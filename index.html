<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rotter AI</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@latest"
      }
    }
    </script>

    <style>
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; background-color: #ffffff; }
        /* Estilo para mostrar errores reales si algo falla */
        #debug-console { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #fff0f0; color: #d8000c; padding: 20px; z-index: 99999; 
            overflow: auto; font-family: monospace; white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div id="debug-console"></div>
    <div id="root" style="height: 100vh; width: 100vw;"></div>

    <script>
        window.onerror = function(msg, url, line, col, error) {
            var console = document.getElementById('debug-console');
            console.style.display = 'block';
            console.innerHTML += "游댮 ERROR CR칈TICO:\n" + msg + "\n\nEn l칤nea: " + line + "\nVerifica que no tengas AdBlock bloqueando scripts.\n\n";
            return false;
        };
        // Capturar errores de promesas (com칰n en imports)
        window.addEventListener('unhandledrejection', function(event) {
            var console = document.getElementById('debug-console');
            console.style.display = 'block';
            console.innerHTML += "游 ERROR DE CARGA (Promesa):\n" + event.reason + "\n\n";
        });
    </script>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        // Importamos todo Lucide para evitar errores si falta un icono espec칤fico
        import * as LucideIcons from 'lucide-react';

        // Desempaquetamos los iconos que usas (Si falta alguno, no romper치 la web)
        const { 
          Plus, ArrowUp, ChevronDown, Check, X, Lock, 
          FileText, Image: ImageIcon, Link: LinkIcon, // Renombramos Image y Link para evitar choques
          Sparkles, AlignLeft, FilePlus, Presentation, UserCheck, Code2,
          Paperclip, LayoutGrid, User, AlertTriangle,
          Plane, Terminal, ChevronLeft, ChevronRight, Edit3, MonitorPlay,
          Bold, Italic, Underline, Strikethrough, List, ListOrdered, 
          AlignCenter, AlignRight, Palette, Highlighter, Heading1, Heading2,
          Maximize2, Minimize2, Trash2, Scaling,
          RotateCcw, RotateCw, Copy, Save, CheckCircle, GripVertical, MessageSquare, LayoutTemplate, ExternalLink,
          RefreshCw, ThumbsUp, ThumbsDown, Clipboard, Zap,
          Maximize, Minimize, CreditCard, Loader2, Brain, Activity, Search, Hammer, Lightbulb, Play, Download,
          Folder, Bot, Settings, PanelLeftClose, PanelLeftOpen, Archive, History, Clock, Layers
        } = LucideIcons;

        // --- TU L칍GICA COMIENZA AQU칈 ---
        
        // --- UTILIDADES ---
        const MarkdownLite = ({ content, themeClass = "" }) => {
          if (!content) return null;
          const codeBlockRegex = /(\`\`\`[\s\S]*?\`\`\`)/g;
          const parts = content.split(codeBlockRegex);

          return (
            <span className={`block ${themeClass}`}>
              {parts.map((part, index) => {
                if (part.startsWith('```') && part.endsWith('```')) {
                  const lines = part.split('\n');
                  const language = lines[0].replace(/```/, '').trim();
                  const code = lines.slice(1).join('\n').replace(/```$/, '').trim();
                  return <CodeBlock key={index} language={language} code={code} />;
                }
                const inlineParts = part.split(/(\*\*.*?\*\*|\*.*?\*|`.*?`|\n\n|\n)/g);
                return (
                  <span key={index}>
                    {inlineParts.map((subPart, subIndex) => {
                      if (subPart === '\n\n') return <div key={subIndex} className="h-4" />;
                      if (subPart === '\n') return <br key={subIndex} />;
                      if (subPart.startsWith('**') && subPart.endsWith('**')) return <strong key={subIndex} className="font-bold text-black">{subPart.slice(2, -2)}</strong>;
                      if (subPart.startsWith('*') && subPart.endsWith('*')) return <em key={subIndex} className="italic text-black/90">{subPart.slice(1, -1)}</em>;
                      if (subPart.startsWith('`') && subPart.endsWith('`')) return <code key={subIndex} className="bg-gray-100 border border-gray-200 px-1.5 py-0.5 rounded font-mono text-sm text-red-600">{subPart.slice(1, -1)}</code>;
                      return <span key={subIndex} className="text-black">{subPart}</span>;
                    })}
                  </span>
                );
              })}
            </span>
          );
        };

        const parseMarkdownToHtml = (md) => {
          if (!md) return '';
          let html = md.replace(/^### (.*$)/gim, '<h3>$1</h3>').replace(/^## (.*$)/gim, '<h2>$1</h2>').replace(/^# (.*$)/gim, '<h1>$1</h1>').replace(/\*\*(.*)\*\*/gim, '<b>$1</b>').replace(/\*(.*)\*/gim, '<i>$1</i>').replace(/^- (.*$)/gim, '<li>$1</li>');
          if (html.includes('<li>')) html = html.replace(/((<li>.*<\/li>\s*)+)/gim, '<ul>$1</ul>');
          return html.split('\n').map(line => (line.match(/<h|<ul|<li/) ? line : line.trim() ? `<div>${line}</div>` : '<br>')).join('');
        };

        // --- MENU EXTRAS ---
        const ExtrasMenu = ({ isOpen, onClose }) => {
          if (!isOpen) return null;
          const tools = [
            { icon: FileText, label: "Crear documentos", desc: "Word, PDF, textos largos" },
            { icon: AlignLeft, label: "Resumir contenido", desc: "Sintetizar informaci칩n clave" },
            { icon: RefreshCw, label: "Reescribir textos", desc: "Mejorar redacci칩n y tono" },
            { icon: List, label: "Organizar ideas", desc: "Estructurar puntos clave" },
            { icon: ListOrdered, label: "Dividir en fases", desc: "Respuestas paso a paso" },
            { icon: LayoutTemplate, label: "Respuestas estructuradas", desc: "T칤tulos, divisores, emojis" },
            { icon: Brain, label: "Modo razonamiento", desc: "An치lisis profundo l칩gico" },
            { icon: Zap, label: "Respuestas r치pidas", desc: "Concisi칩n y velocidad" },
          ];
          const chatFunctions = [
            { icon: MessageSquare, label: "Contexto extendido", desc: "Para charlas largas" },
            { icon: Archive, label: "Memoria de chat", desc: "Recordar datos previos" },
            { icon: Save, label: "Guardar respuestas", desc: "Almacenar en favoritos" },
            { icon: Search, label: "Buscar en chat", desc: "Localizar informaci칩n" },
            { icon: Code2, label: "Formato avanzado", desc: "Uso de divisores '--'" },
            { icon: CheckCircle, label: "Cierre claro", desc: "Conclusiones y res칰menes" },
          ];
          return (
            <div className="absolute top-full left-0 mt-3 w-[340px] bg-white rounded-2xl shadow-2xl border border-gray-100 p-2 z-50 animate-in fade-in zoom-in-95 duration-200 origin-top-left overflow-hidden font-inter">
              <div className="max-h-[80vh] overflow-y-auto custom-scrollbar p-2">
                <div className="mb-4">
                  <h3 className="px-3 py-2 text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Herramientas</h3>
                  <div className="space-y-0.5">
                    {tools.map((item, idx) => {
                      const Icon = item.icon || Sparkles; 
                      return (
                      <button key={idx} className="w-full flex items-start gap-3 p-3 rounded-xl hover:bg-gray-50 transition-colors group text-left">
                        <div className="mt-0.5 text-gray-400 group-hover:text-black transition-colors">
                          <Icon size={16} strokeWidth={1.5} />
                        </div>
                        <div>
                          <div className="text-sm font-semibold text-black leading-tight">{item.label}</div>
                          <div className="text-[11px] text-gray-400 font-medium mt-0.5">{item.desc}</div>
                        </div>
                      </button>
                    )})}
                  </div>
                </div>
                <div className="h-px bg-gray-100 mx-3 mb-4"></div>
                <div>
                  <h3 className="px-3 py-2 text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Funciones del chat</h3>
                  <div className="space-y-0.5">
                    {chatFunctions.map((item, idx) => {
                      const Icon = item.icon || Sparkles;
                      return (
                      <button key={idx} className="w-full flex items-start gap-3 p-3 rounded-xl hover:bg-gray-50 transition-colors group text-left">
                        <div className="mt-0.5 text-gray-400 group-hover:text-black transition-colors">
                          <Icon size={16} strokeWidth={1.5} />
                        </div>
                        <div>
                          <div className="text-sm font-semibold text-black leading-tight">{item.label}</div>
                          <div className="text-[11px] text-gray-400 font-medium mt-0.5">{item.desc}</div>
                        </div>
                      </button>
                    )})}
                  </div>
                </div>
              </div>
            </div>
          );
        };

        // --- COMPONENTE VISTA DE HISTORIAL ---
        const HistoryView = ({ onClose, onSelectChat }) => {
          const [isExpanded, setIsExpanded] = useState(false);
          const [searchTerm, setSearchTerm] = useState('');
          
          const mockChats = Array.from({ length: 20 }, (_, i) => ({
            id: i,
            title: i === 0 ? "Plan de Marketing 2025" : i === 1 ? "C칩digo Python Script" : `Conversaci칩n Antigua ${20 - i}`,
            date: i === 0 ? "Justo ahora" : i < 5 ? "Ayer" : "Hace una semana",
            preview: "Aqu칤 tienes el detalle de lo que hablamos..."
          }));
          const filteredChats = mockChats.filter(chat => 
            chat.title.toLowerCase().includes(searchTerm.toLowerCase())
          );
          return (
            <div className={`
              transition-all duration-500 ease-in-out bg-white/95 backdrop-blur-xl border border-gray-200 shadow-2xl
              ${isExpanded 
                ? 'absolute inset-0 z-30 flex flex-col p-6 rounded-none' 
                : 'absolute top-10 left-10 md:left-20 w-[400px] max-h-[600px] flex flex-col p-4 rounded-2xl z-30' 
              }
            `}>
              <div className="flex items-center justify-between mb-4 shrink-0">
               <div className="flex items-center gap-2">
                   <button 
                     onClick={() => setIsExpanded(!isExpanded)}
                     className="p-2 hover:bg-gray-100 rounded-lg text-gray-500 hover:text-black transition-colors"
                     title={isExpanded ? "Contraer" : "Expandir"}
                   >
                     {isExpanded ? <Minimize2 size={18} /> : <Maximize2 size={18} />}
                   </button>
                   <h2 className="font-bold text-lg text-black">Historial</h2>
                </div>
                <button onClick={onClose} className="p-2 hover:bg-red-50 text-gray-400 hover:text-red-600 rounded-lg transition-colors">
                    <X size={18} />
                </button>
              </div>

              <div className="relative mb-4 shrink-0">
                <Search size={16} className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" />
                <input 
                  type="text" 
                  placeholder="Buscar en tus chats..." 
                  value={searchTerm}
                  onChange={(e) => setSearchTerm(e.target.value)}
                  className="w-full pl-9 pr-4 py-2.5 bg-gray-50 border border-gray-200 rounded-xl text-sm outline-none focus:border-black/20 focus:bg-white transition-all font-inter"
                />
              </div>

              <div className={`flex-1 overflow-y-auto custom-scrollbar pr-1 space-y-2 ${!isExpanded ? 'max-h-[400px]' : ''}`}>
                {filteredChats.map((chat) => (
                    <button 
                        key={chat.id} 
                        onClick={() => onSelectChat(chat.id)}
                        className="w-full text-left p-3 hover:bg-gray-50 border border-transparent hover:border-gray-100 rounded-xl group transition-all duration-200"
                    >
                      <div className="flex justify-between items-start mb-1">
                            <span className="font-semibold text-sm text-black group-hover:text-blue-600 transition-colors truncate pr-2">{chat.title}</span>
                            <span className="text-[10px] text-gray-400 whitespace-nowrap">{chat.date}</span>
                        </div>
                        <p className="text-xs text-gray-500 truncate">{chat.preview}</p>
                    </button>
                ))}
                {filteredChats.length === 0 && (
                    <div className="text-center py-10 text-gray-400 text-sm">
                        No se encontraron chats
                    </div>
                )}
              </div>
            </div>
          );
        };

        // --- SIDEBAR MINIMALISTA ---
        const Sidebar = ({ onNewChat, onOpenHistory, onOpenSettings }) => {
          const [isCollapsed, setIsCollapsed] = useState(false);
          return (
            <div 
              className={`hidden md:flex flex-col h-full border-r border-gray-200 shrink-0 font-inter transition-all duration-300 relative 
              ${isCollapsed ? 'w-[70px] bg-white' : 'w-[260px] bg-white'}`}
            >
              <div className={`flex items-center h-14 px-4 ${isCollapsed ? 'justify-center' : 'justify-between'}`}>
                {!isCollapsed ? (
                    <>
                       <span className="font-sans font-bold text-sm tracking-tight text-black animate-in fade-in duration-200">
                            ROTTER AI
                        </span>
                        <button onClick={() => setIsCollapsed(true)} className="p-1.5 rounded-lg text-black hover:bg-gray-200 transition-colors">
                            <PanelLeftClose size={16} strokeWidth={1.2} />
                         </button>
                    </>
                ) : (
                    <button onClick={() => setIsCollapsed(false)} className="group relative w-9 h-9 flex items-center justify-center bg-gray-100 hover:bg-gray-200 rounded-xl transition-all duration-300 shadow-sm">
                        <span className="font-sans font-bold text-lg text-black group-hover:opacity-0 transition-opacity duration-200 absolute">R</span>
                        <PanelLeftOpen size={16} strokeWidth={1.5} className="text-black opacity-0 group-hover:opacity-100 transition-opacity duration-200 absolute" />
                    </button>
                )}
              </div>

              <div className="flex flex-col gap-1 px-3 mt-2 flex-1">
                <SidebarOption icon={Plus} label="Nuevo Chat" onClick={onNewChat} isCollapsed={isCollapsed} />
                <SidebarOption icon={Search} label="Buscar Chats" onClick={() => console.log("Buscando...")} isCollapsed={isCollapsed} />
                <SidebarOption icon={Archive} label="Proyectos" onClick={() => console.log("Proyectos")} isCollapsed={isCollapsed} />
                <SidebarOption icon={Brain} label="Agentes" onClick={() => console.log("Agentes")} isCollapsed={isCollapsed} />
                <SidebarOption icon={History} label="Historial" onClick={onOpenHistory} isCollapsed={isCollapsed} />
              </div>

              <div className="p-3 border-t border-gray-200">
                <SidebarOption icon={Settings} label="Configuraci칩n" onClick={onOpenSettings} isCollapsed={isCollapsed} />
               </div>
            </div>
          );
        };

        // --- SIDEBAR OPTION ---
        const SidebarOption = ({ icon: Icon, label, onClick, isCollapsed }) => {
            const IconComp = Icon || Sparkles;
            return (
                <button 
                  onClick={onClick} 
                  className={`
                    group flex items-center transition-all duration-150 ease-in-out
                    ${isCollapsed ? 'justify-center w-9 h-9 mx-auto rounded-lg' : 'w-full px-3 py-2 rounded-[8px] gap-3'}
                    text-black hover:bg-gray-100 font-normal
                  `}
                  title={isCollapsed ? label : ""}
                >
                  <IconComp size={14} strokeWidth={1.2} className="shrink-0 text-black" />
                  {!isCollapsed && (
                      <span className="text-[13px] truncate text-black animate-in fade-in duration-100">
                         {label}
                      </span>
                  )}
                </button>
            );
        };

        // --- COMPONENTE MENSAJE EXPANDIBLE ---
        const ExpandableMessage = ({ content, role, children }) => {
          if (role === 'user') return children;
          const [isExpanded, setIsExpanded] = useState(false);
          const CHAR_LIMIT = 800; 
          if (!content || content.length <= CHAR_LIMIT || isExpanded) return <div className="animate-in fade-in duration-300 w-full">{children}</div>;
          return (
            <div className="relative animate-in fade-in duration-300 w-full">
              <div className="max-h-[250px] overflow-hidden relative">{children}<div className="absolute bottom-0 left-0 w-full h-24 bg-gradient-to-t from-white via-white/80 to-transparent" /></div>
              <button onClick={() => setIsExpanded(true)} className="mt-4 text-xs font-bold uppercase tracking-widest text-black hover:underline flex items-center gap-1 transition-colors">Leer todo <ChevronDown size={14} /></button>
            </div>
          );
        };

        // --- COMPONENTE IMAGEN ---
        const ImageMessage = ({ src, alt }) => {
          const [isLoading, setIsLoading] = useState(true);
          return (
            <div className="mt-3 rounded-3xl overflow-hidden shadow-lg border border-gray-100 max-w-md w-full relative group bg-gray-50">
              {isLoading && <div className="w-full aspect-square bg-gray-200 animate-pulse flex flex-col items-center justify-center gap-3"><Sparkles size={24} className="text-gray-400" /><span className="text-xs font-bold text-gray-400 uppercase tracking-widest">Generando...</span></div>}
              <img src={src} alt={alt || "AI Image"} className={`w-full h-auto object-cover transition-all duration-1000 ease-out ${isLoading ? 'opacity-0 absolute top-0 left-0' : 'opacity-100 relative'}`} onLoad={() => setIsLoading(false)} loading="lazy" />
              {!isLoading && <div className="absolute top-3 right-3 opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex gap-2"><button onClick={() => window.open(src, '_blank')} className="p-2 bg-black/50 hover:bg-black/70 backdrop-blur-md rounded-full text-white transition-all shadow-sm"><ExternalLink size={16} /></button><a href={src} download="image.png" target="_blank" rel="noreferrer" className="p-2 bg-black/50 hover:bg-black/70 backdrop-blur-md rounded-full text-white transition-all shadow-sm"><Download size={16} /></a></div>}
            </div>
          );
        };

        // --- CODE BLOCK ---
        const CodeBlock = ({ language, code }) => {
          const [copied, setCopied] = useState(false);
          const handleCopy = () => {
            const textArea = document.createElement("textarea"); textArea.value = code; textArea.style.position = "fixed";
            textArea.style.left = "-9999px"; document.body.appendChild(textArea); textArea.focus(); textArea.select();
            try { document.execCommand('copy'); setCopied(true); setTimeout(() => setCopied(false), 2000); } catch (err) {} document.body.removeChild(textArea);
          };
          return (
            <div className="rounded-xl overflow-hidden my-6 border border-gray-800 shadow-xl transition-all w-full max-w-full bg-[#0a0a0a] text-gray-200 group ring-1 ring-white/10">
              <div className="flex items-center justify-between px-4 py-3 text-xs font-mono border-b border-gray-800 bg-[#111] text-gray-400">
                <div className="flex items-center gap-2"><Terminal size={14} className="text-blue-500" /><span className="uppercase tracking-wider font-bold text-gray-300">{language || 'CODE'}</span></div>
                <button onClick={handleCopy} className={`flex items-center gap-1.5 px-3 py-1.5 rounded-lg transition-all duration-300 font-medium ${copied ? 'text-green-400 bg-green-900/20' : 'text-gray-400 hover:text-white hover:bg-gray-800'}`}>{copied ? <Check size={14} /> : <Copy size={14} />}<span>{copied ? 'Copiado' : 'Copiar'}</span></button>
              </div>
              <div className="overflow-x-auto custom-scrollbar-dark relative"><pre className="p-5 font-mono text-[13px] leading-relaxed whitespace-pre tab-4 text-gray-300"><code>{code}</code></pre></div>
            </div>
          );
        };

        // --- RAZONAMIENTO ---
        const ReasoningBlock = ({ content }) => {
          const [isOpen, setIsOpen] = useState(false);
          if (!content) return null;
          return (
            <div className="mb-6 w-full max-w-3xl border border-blue-200 rounded-xl overflow-hidden bg-blue-50/50 shadow-sm transition-all duration-300">
              <button onClick={() => setIsOpen(!isOpen)} className="w-full flex items-center justify-between p-4 text-xs font-semibold text-blue-900 hover:bg-blue-100/50 transition-colors">
                <div className="flex items-center gap-2"><Brain size={16} className="text-blue-700" /><span className="uppercase tracking-wide">Proceso de pensamiento</span></div>
                <div className="flex items-center gap-2"><span className="text-[10px] text-blue-600 uppercase tracking-wider font-bold">{isOpen ? 'Ocultar' : 'Ver detalles'}</span><ChevronDown size={16} className={`text-blue-700 transform transition-transform duration-300 ${isOpen ? 'rotate-180' : ''}`} /></div>
              </button>
              {isOpen && <div className="p-5 bg-white border-t border-blue-100 animate-in slide-in-from-top-2 fade-in duration-300"><div className="text-sm text-gray-800 font-mono whitespace-pre-wrap leading-relaxed opacity-90"><MarkdownLite content={content} /></div></div>}
            </div>
          );
        };

        // --- AVISOS ---
        const ContextLimitNotice = ({ type = 'limit', onClose, onOpenPro }) => {
          const content = type === 'deferred' ?
            { title: "Nota sobre contexto", subtitle: "Memoria optimizada.", cta: "Mejorar" } : { title: "쯇royecto grande?", subtitle: "Optimiza la memoria.", cta: "Ser Pro" };
          return (
            <div className="mb-4 mx-auto w-full max-w-2xl bg-white/95 backdrop-blur-md border border-gray-200 rounded-2xl p-4 shadow-lg animate-in slide-in-from-bottom-2 duration-500 fade-in">
              <div className="flex justify-between items-center gap-4"><div className="flex-1"><h4 className="text-sm font-bold text-black">{content.title}</h4><p className="text-xs text-black/70 mt-0.5">{content.subtitle}</p></div><div className="flex items-center gap-2"><button onClick={onOpenPro} className="bg-black text-white text-xs font-bold px-3 py-2 rounded-lg hover:bg-gray-800 transition-transform active:scale-95 flex items-center gap-1">{content.cta} <Zap size={10} fill="currentColor" /></button><button onClick={onClose} className="text-black/40 hover:text-black p-1 rounded-full hover:bg-gray-100"><X size={14} /></button></div></div>
            </div>
          );
        };

        // --- ANUNCIO GEMINI 3 ---
        const AnnouncementModal = ({ onClose }) => {
          return (
            <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-in fade-in duration-300">
              <div className="bg-white rounded-[2rem] shadow-2xl w-full max-w-2xl overflow-hidden relative animate-in zoom-in-95 duration-300 border border-gray-100">
                <button onClick={onClose} className="absolute top-4 right-4 p-2 bg-black/20 hover:bg-black/40 text-white rounded-full transition-all z-10 backdrop-blur-md hover:scale-105">
                  <X size={20} strokeWidth={2} />
                </button>
                <div className="w-full relative bg-gray-50">
                   <img 
                     src="https://photos.fife.usercontent.google.com/pw/AP1GczP9HALxhpcOJUEWB_pu2It4mc6S9K8UuphRKRpjmec9NA7z3HUxB2M=w1290-h633-s-no-gm?authuser=0" 
                     className="w-full h-auto object-cover"
                     alt="Gemini 3 Announcement"
                     style={{ display: 'block' }} 
                  />
                </div>
                <div className="p-8 pb-10 text-center space-y-3 bg-white">
                   <h2 className="text-3xl font-bold text-black tracking-tight font-inter">Ya lleg칩 Gemini 3</h2>
                   <p className="text-gray-500 text-base font-normal leading-relaxed max-w-lg mx-auto font-dm-sans">
                     Ahora puedes usar el modelo m치s reciente de Google, 
                     integrado directamente en ROTTER AI para respuestas m치s r치pidas, precisas y potentes.
                   </p>
                   <div className="pt-2">
                        <button onClick={onClose} className="px-8 py-3 bg-black text-white font-bold rounded-xl hover:bg-gray-900 transition-all shadow-xl hover:shadow-2xl hover:-translate-y-0.5 active:translate-y-0">Entendido</button>
                   </div>
                </div>
              </div>
            </div>
          )
        };
        
        // --- MODAL PRO ---
        const ProModal = ({ onClose, onActivatePro }) => {
          const [paymentState, setPaymentState] = useState('idle');
          const handlePurchase = () => { setPaymentState('processing'); setTimeout(() => { setPaymentState('success'); setTimeout(() => { onActivatePro(); onClose(); }, 1500); }, 2000);
          };
          return (
            <div className="fixed inset-0 z-50 flex items-center justify-center p-4"><div className="absolute inset-0 bg-black/40 backdrop-blur-sm transition-opacity" onClick={onClose} /><div className="bg-white rounded-[2rem] shadow-2xl p-8 w-full max-w-sm relative z-10 animate-in zoom-in-95 duration-300 border border-black/5"><button onClick={onClose} className="absolute top-5 right-5 p-2 text-gray-400 hover:text-black transition-colors rounded-full hover:bg-gray-100"><X size={20} /></button><div className="space-y-6 text-center"><div><div className="w-12 h-12 bg-black text-white rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg"><Zap size={24} fill="currentColor" /></div><h3 className="text-2xl font-bold text-black tracking-tight">ROTTER Pro</h3></div><button onClick={handlePurchase} disabled={paymentState !== 'idle'} className={`w-full py-4 px-6 rounded-2xl font-bold text-white transition-all flex items-center justify-center gap-2 shadow-xl ${paymentState === 'success' ? 'bg-green-600 scale-105' : 'bg-black hover:bg-gray-900 active:scale-95'} ${paymentState === 'processing' ? 'cursor-wait opacity-90' : ''}`}>{paymentState === 'idle' && "Activar Ahora"}{paymentState === 'processing' && <><Loader2 size={20} className="animate-spin" /> Procesando...</>}{paymentState === 'success' && <><Check size={20} /> 춰Listo!</>}</button></div></div></div>
          );
        };

        const Typewriter = ({ text }) => {
          const [displayedText, setDisplayedText] = useState('');
          const indexRef = useRef(0);
          useEffect(() => { indexRef.current = 0; setDisplayedText(''); const length = text.length; let speed = length < 100 ? 20 : length > 500 ? 1 : 5; let step = length > 500 ? 8 : length < 100 ? 1 : 3; const timer = setInterval(() => { if (indexRef.current < length) { indexRef.current += step; setDisplayedText(text.slice(0, indexRef.current)); } else { setDisplayedText(text); clearInterval(timer); } }, speed); return () => clearInterval(timer); }, [text]);
          return <MarkdownLite content={displayedText} themeClass="text-base text-black leading-relaxed tracking-wide space-y-4" />;
        };
        
        const RandomFeedbackBox = ({ type, onFeedback }) => {
          const [isVisible, setIsVisible] = useState(true);
          if (!isVisible) return null;
          return (
            <div className="mt-6 mb-2 bg-gray-50/50 border border-gray-100 rounded-2xl p-4 w-full max-w-xs animate-in fade-in slide-in-from-top-2 duration-500"><p className="text-xs text-black/60 mb-3 font-medium text-center">{type === 'personality' ? "쯊e gusta c칩mo estoy hablando?" : "쯊e sirvi칩 esta respuesta?"}</p><div className="flex gap-2"><button onClick={() => { onFeedback('positive'); setIsVisible(false); }} className="flex-1 py-2 bg-white border border-gray-200 rounded-xl text-xs font-bold text-black hover:bg-black hover:text-white transition-all flex items-center justify-center gap-1.5 shadow-sm active:scale-95"><ThumbsUp size={14} /> S칤</button><button onClick={() => { onFeedback('negative'); setIsVisible(false); }} className="flex-1 py-2 bg-white border border-gray-200 rounded-xl text-xs font-bold text-black hover:bg-black hover:text-white transition-all flex items-center justify-center gap-1.5 shadow-sm active:scale-95"><ThumbsDown size={14} /> No</button></div></div>
          );
        };

        const MessageActions = ({ text, align, isUser, onEdit, onRegenerate, onVote }) => {
          const [copied, setCopied] = useState(false);
          const [vote, setVote] = useState(null);
          const handleCopy = () => { const textArea = document.createElement("textarea"); textArea.value = text;
          textArea.style.position = "fixed"; textArea.style.left = "-9999px"; document.body.appendChild(textArea); textArea.focus(); textArea.select(); try { document.execCommand('copy'); setCopied(true); setTimeout(() => setCopied(false), 2000);
          } catch (err) {} document.body.removeChild(textArea); };
          const handleVote = (type) => { setVote(type); if (onVote) onVote(type); };
          return (
            <div className={`flex items-center gap-2 mt-3 opacity-0 group-hover:opacity-100 transition-opacity duration-200 ${align === 'right' ? 'justify-end' : 'justify-start'}`}>
              {!isUser && (<><button onClick={() => handleVote('like')} className={`p-2 rounded-lg transition-all ${vote === 'like' ? 'text-black bg-gray-100' : 'text-gray-400 hover:text-black hover:bg-gray-100'}`} disabled={vote !== null}><ThumbsUp size={16} /></button><button onClick={() => handleVote('dislike')} className={`p-2 rounded-lg transition-all ${vote === 'dislike' ? 'text-black bg-gray-100' : 'text-gray-400 hover:text-black hover:bg-gray-100'}`} disabled={vote !== null}><ThumbsDown size={16} /></button><div className="w-px h-4 bg-gray-200 mx-1"></div></>)}
              {!isUser && onRegenerate && (<button onClick={onRegenerate} className="p-2 text-gray-400 hover:text-black hover:bg-gray-100 rounded-lg transition-all" title="Rehacer"><RefreshCw size={16} /></button>)}
              
              {isUser && onEdit && (<button onClick={() => onEdit(text)} className="p-2 text-gray-400 hover:text-black hover:bg-gray-100 rounded-lg transition-all" title="Editar"><Edit3 size={16} /></button>)}
              <button onClick={handleCopy} className="p-2 text-gray-400 hover:text-black hover:bg-gray-100 rounded-lg transition-all flex items-center gap-1" title="Copiar">{copied ? <Check size={16} className="text-green-600" /> : <Copy size={16} />}</button>
            </div>
          );
        };
        // ... [Presentation Components]
        const PresentationCard = ({ content, onOpen }) => { if (!content) return null;
          const lines = content.split('\n'); const titleLine = lines.find(l => l.trim().length > 0 && !l.includes('---')) || "Presentaci칩n";
          const title = titleLine.replace(/^#+\s*/, '').replace(/\*\*/g, '').trim(); return (<div className="mt-4 bg-white border border-gray-200 rounded-2xl shadow-sm p-5 w-full max-w-sm flex items-center justify-between group hover:shadow-md transition-all"><div className="flex items-center gap-4 overflow-hidden"><div className="bg-black p-3 rounded-xl text-white shrink-0"><Presentation size={24} /></div><div className="min-w-0"><h4 className="font-bold text-black text-base truncate">{title}</h4><p className="text-xs text-gray-500 font-medium">iRotter Slides</p></div></div><button onClick={onOpen} className="ml-2 px-4 py-2 bg-black text-white text-xs font-bold rounded-lg hover:bg-gray-900 transition-colors flex items-center gap-2 shrink-0">Abrir <ExternalLink size={14} /></button></div>);
        };
        const DraggableResizableImage = ({ img, isSelected, onSelect, onUpdate, onDelete, readOnly }) => { const handleMouseDown = (e) => { if (readOnly) return;
          e.stopPropagation(); onSelect(); const startX = e.clientX - img.x; const startY = e.clientY - img.y;
          const handleMouseMove = (moveEvent) => onUpdate({ ...img, x: moveEvent.clientX - startX, y: moveEvent.clientY - startY });
          const handleMouseUp = () => { document.removeEventListener('mousemove', handleMouseMove); document.removeEventListener('mouseup', handleMouseUp); }; document.addEventListener('mousemove', handleMouseMove); document.addEventListener('mouseup', handleMouseUp); };
          const handleResizeMouseDown = (e) => { e.stopPropagation(); const startX = e.clientX; const startY = e.clientY; const startWidth = img.width;
          const startHeight = img.height; const handleMouseMove = (moveEvent) => onUpdate({ ...img, width: Math.max(50, startWidth + (moveEvent.clientX - startX)), height: Math.max(50, startHeight + (moveEvent.clientY - startY)) });
          const handleMouseUp = () => { document.removeEventListener('mousemove', handleMouseMove); document.removeEventListener('mouseup', handleMouseUp); }; document.addEventListener('mousemove', handleMouseMove); document.addEventListener('mouseup', handleMouseUp); };
          return (<div className={`absolute ${readOnly ? '' : 'cursor-move'} group select-none ${isSelected ? 'z-20' : 'z-10'}`} style={{ left: img.x, top: img.y, width: img.width, height: img.height }} onMouseDown={handleMouseDown}><img src={img.url} alt="Slide element" className={`w-full h-full object-cover rounded-lg shadow-md transition-all ${isSelected && !readOnly ? 'ring-2 ring-black' : ''}`} draggable={false} />{isSelected && !readOnly && (<><button onMouseDown={(e) => { e.stopPropagation(); onDelete(); }} className="absolute -top-2 -right-2 bg-black text-white p-1.5 rounded-full shadow-md hover:bg-gray-900 transition-colors"><Trash2 size={12} /></button><div onMouseDown={handleResizeMouseDown} className="absolute bottom-0 right-0 w-6 h-6 cursor-nwse-resize flex items-center justify-center bg-white rounded-tl-lg shadow-sm border border-gray-200"><Scaling size={12} className="text-black" /></div></>)}</div>);
        };
        const PRESENTATION_THEMES = { minimalist: { name: 'Minimalista', container: 'bg-white', text: 'text-black', accent: 'text-black', font: 'font-sans' }, dark: { name: 'Oscuro', container: 'bg-slate-950', text: 'text-gray-300', accent: 'text-white', font: 'font-sans' }, corporate: { name: 'Corporativo', container: 'bg-slate-50 border-l-8 border-blue-700', text: 'text-slate-800', accent: 'text-blue-900', font: 'font-sans' }, educational: { name: 'Educativo', container: 'bg-amber-50', text: 'text-amber-950', accent: 'text-amber-900', font: 'font-serif' }, };
        const PresentationEditor = ({ initialContent, onClose }) => { const [slides, setSlides] = useState([]);
          const [history, setHistory] = useState({ past: [], future: [] }); const [contentVersion, setContentVersion] = useState(Date.now()); const [currentSlideIndex, setCurrentSlideIndex] = useState(0);
          const [isFullScreen, setIsFullScreen] = useState(false); const [selectedImageId, setSelectedImageId] = useState(null); const [saveStatus, setSaveStatus] = useState('saved'); const [currentTheme, setCurrentTheme] = useState('minimalist');
          const [showThemeSelector, setShowThemeSelector] = useState(false); const [isPresenting, setIsPresenting] = useState(false); const [showRecovery, setShowRecovery] = useState(false); const editorRef = useRef(null);
          const [draggedSlideIndex, setDraggedSlideIndex] = useState(null); useEffect(() => { const savedData = localStorage.getItem('irotter_presentation_autosave'); if (initialContent) { const rawSlides = initialContent.split('---').map(s => s.trim()).filter(s => s.length > 0); const parsedSlides = rawSlides.map(slide => { const lines = slide.split('\n'); const title = lines[0].replace(/^#+\s*/, '').replace(/\*\*/g, '').trim(); const images = []; const bodyLines = []; lines.slice(1).forEach(line => { if (line.trim().startsWith('IMAGE:')) { const prompt = line.replace('IMAGE:', '').trim(); images.push({ id: Date.now() + Math.random(), url: `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}`, x: 400, y: 100, width: 250, height: 250 }); } else { bodyLines.push(line); } }); return { title: title || "Nueva Diapositiva", body: parseMarkdownToHtml(bodyLines.join('\n').trim()), images, comments: [] }; }); setSlides(parsedSlides.length > 0 ? 
          parsedSlides : [{ title: "T칤tulo", body: "<div>...</div>", images: [], comments: [] }]); } else if (savedData) { setShowRecovery(true);
          } }, [initialContent]); const recoverSession = () => { const savedData = localStorage.getItem('irotter_presentation_autosave'); if (savedData) { const parsed = JSON.parse(savedData);
          setSlides(parsed.slides || []); if (parsed.theme) setCurrentTheme(parsed.theme); setContentVersion(Date.now()); } setShowRecovery(false); }; const discardSession = () => { localStorage.removeItem('irotter_presentation_autosave'); setShowRecovery(false);
          if (!slides.length) setSlides([{ title: "Nueva Presentaci칩n", body: "<div>Comienza a escribir...</div>", images: [], comments: [] }]); };
          const updateState = (newSlides, newTheme = currentTheme, addToHistory = true) => { if (addToHistory) setHistory(curr => ({ past: [...curr.past, { slides, theme: currentTheme }], future: [] }));
          setSlides(newSlides); setCurrentTheme(newTheme); setSaveStatus('saving'); setTimeout(() => { localStorage.setItem('irotter_presentation_autosave', JSON.stringify({ slides: newSlides, theme: newTheme })); setSaveStatus('saved'); }, 500); };
          const handleUndo = () => { if (history.past.length === 0) return; const previous = history.past[history.past.length - 1];
          setHistory({ past: history.past.slice(0, -1), future: [{ slides, theme: currentTheme }, ...history.future] }); setSlides(previous.slides); setCurrentTheme(previous.theme); setContentVersion(Date.now()); };
          const handleRedo = () => { if (history.future.length === 0) return; const next = history.future[0];
          setHistory({ past: [...history.past, { slides, theme: currentTheme }], future: history.future.slice(1) }); setSlides(next.slides); setCurrentTheme(next.theme); setContentVersion(Date.now()); };
          useEffect(() => { if (editorRef.current && slides[currentSlideIndex]) { editorRef.current.innerHTML = slides[currentSlideIndex].body; } setSelectedImageId(null); }, [currentSlideIndex, contentVersion]);
          const saveCurrentSlideBody = () => { if (editorRef.current && slides[currentSlideIndex]) { const newHtml = editorRef.current.innerHTML;
          if (slides[currentSlideIndex].body !== newHtml) { const newSlides = [...slides]; newSlides[currentSlideIndex] = { ...newSlides[currentSlideIndex], body: newHtml }; setSlides(newSlides); setSaveStatus('saving');
          setTimeout(() => { localStorage.setItem('irotter_presentation_autosave', JSON.stringify({ slides: newSlides, theme: currentTheme })); setSaveStatus('saved'); }, 500); } } };
          const updateTitle = (val) => { const newSlides = [...slides]; newSlides[currentSlideIndex].title = val; updateState(newSlides); };
          const addImage = () => { const prompt = prompt("Describe la imagen:");
          if (prompt) { const newImage = { id: Date.now(), url: `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}`, x: 50, y: 50, width: 200, height: 200 };
          const newSlides = [...slides]; newSlides[currentSlideIndex].images.push(newImage); updateState(newSlides); } }; const updateImage = (imgObj) => { const newSlides = [...slides];
          newSlides[currentSlideIndex].images = newSlides[currentSlideIndex].images.map(img => img.id === imgObj.id ? imgObj : img); setSlides(newSlides); };
          const deleteImage = (imgId) => { const newSlides = [...slides]; newSlides[currentSlideIndex].images = newSlides[currentSlideIndex].images.filter(img => img.id !== imgId); updateState(newSlides); };
          const duplicateSlide = (index) => { const newSlide = JSON.parse(JSON.stringify(slides[index])); newSlide.images = newSlide.images.map(img => ({...img, id: Date.now() + Math.random()}));
          const newSlides = [...slides]; newSlides.splice(index + 1, 0, newSlide); updateState(newSlides); setCurrentSlideIndex(index + 1); };
          const addComment = () => { const text = prompt("A침adir nota:"); if (text) { const newSlides = [...slides];
          if (!newSlides[currentSlideIndex].comments) newSlides[currentSlideIndex].comments = []; newSlides[currentSlideIndex].comments.push({ id: Date.now(), text }); updateState(newSlides); } };
          const handleDragStart = (e, index) => { setDraggedSlideIndex(index); e.dataTransfer.effectAllowed = "move"; }; const handleDragOver = (e, index) => { e.preventDefault();
          e.dataTransfer.dropEffect = "move"; }; const handleDrop = (e, index) => { e.preventDefault(); if (draggedSlideIndex === null) return;
          if (draggedSlideIndex !== index) { const newSlides = [...slides]; const [draggedSlide] = newSlides.splice(draggedSlideIndex, 1); newSlides.splice(index, 0, draggedSlide); updateState(newSlides); setCurrentSlideIndex(index);
          } setDraggedSlideIndex(null); }; const changeTheme = (themeKey) => { updateState(slides, themeKey); };
          const execCmd = (cmd, val = null) => { document.execCommand(cmd, false, val); editorRef.current.focus(); saveCurrentSlideBody(); };
          if (slides.length === 0 && !showRecovery) return null; const activeTheme = PRESENTATION_THEMES[currentTheme];
          if (isPresenting) { return ( <div className={`fixed inset-0 z-[100] flex flex-col items-center justify-center ${activeTheme.container} ${activeTheme.font}`}> <div className="absolute top-4 right-4 flex gap-2 z-50"> <button onClick={() => setCurrentSlideIndex(prev => Math.max(0, prev - 1))} className="p-3 bg-black/30 hover:bg-black/50 text-white rounded-full"><ChevronLeft size={24} /></button> <button onClick={() => setCurrentSlideIndex(prev => Math.min(slides.length - 1, prev + 1))} className="p-3 bg-black/30 hover:bg-black/50 text-white rounded-full"><ChevronRight size={24} /></button> <button onClick={() => setIsPresenting(false)} className="p-3 bg-red-600 hover:bg-red-700 text-white rounded-full"><X size={24} /></button> </div> <div className="w-full max-w-7xl aspect-video relative p-20 flex flex-col justify-center"> <h1 className={`text-7xl font-bold mb-10 ${activeTheme.accent}`}>{slides[currentSlideIndex]?.title}</h1> <div className={`text-4xl leading-relaxed ${activeTheme.text}`} dangerouslySetInnerHTML={{ __html: slides[currentSlideIndex]?.body }} /> {slides[currentSlideIndex]?.images?.map((img) => (<DraggableResizableImage key={img.id} img={img} readOnly={true} />))} </div> <div 
          className="absolute bottom-6 text-base opacity-50 font-medium">{currentSlideIndex + 1} / {slides.length}</div> </div> );
          } return ( <div className={`h-full flex flex-col border-l border-gray-200 shadow-xl font-sans relative ${isFullScreen ? 'fixed inset-0 z-[60] bg-gray-50' : 'bg-gray-50'}`} onClick={() => setSelectedImageId(null)}> {showRecovery && ( <div className="absolute inset-0 z-50 bg-black/50 backdrop-blur-sm flex items-center justify-center"><div className="bg-white p-8 rounded-3xl shadow-2xl max-w-sm text-center"><h3 className="text-xl font-bold text-black mb-3">Sesi칩n encontrada</h3><p className="text-gray-500 mb-6 text-base">쮻eseas restaurar tu 칰ltima presentaci칩n?</p><div className="flex gap-3"><button onClick={discardSession} className="flex-1 px-5 py-3 bg-gray-100 hover:bg-gray-200 rounded-xl text-black font-medium">Descartar</button><button onClick={recoverSession} className="flex-1 px-5 py-3 bg-black hover:bg-gray-900 rounded-xl text-white font-medium">Restaurar</button></div></div></div> )} <div className="bg-white border-b border-gray-200 px-6 py-3 flex justify-between items-center shrink-0"> <div className="flex items-center gap-5"><div className="bg-black p-2.5 rounded-xl text-white"><Presentation size={20} /></div><div><h2 className="font-bold text-black text-base">Editor</h2><div className="flex items-center gap-2 
          mt-0.5 text-xs font-medium">{saveStatus === 'saved' ? <span className="text-green-600 flex items-center gap-1"><CheckCircle size={12} /> Guardado</span> : <span className="text-gray-400 flex items-center gap-1"><Save size={12} /> ...</span>}</div></div><div className="flex items-center bg-gray-100 rounded-lg p-1 ml-4"><button onClick={handleUndo} disabled={!history.past.length} className="p-2 text-black hover:bg-white rounded-md disabled:opacity-30 transition-all"><RotateCcw size={16} /></button><button onClick={handleRedo} disabled={!history.future.length} className="p-2 text-black hover:bg-white rounded-md disabled:opacity-30 transition-all"><RotateCw size={16} /></button></div><div className="h-8 w-px bg-gray-200 mx-2"></div><div className="relative"><button onClick={() => setShowThemeSelector(!showThemeSelector)} className="flex items-center gap-2 px-3 py-2 text-sm font-bold bg-gray-100 hover:bg-gray-200 rounded-lg text-black transition-colors"><LayoutTemplate size={16} /> Dise침o</button>{showThemeSelector && (<div className="absolute top-full left-0 mt-2 w-48 bg-white border border-gray-200 rounded-xl shadow-2xl p-2 z-50">{Object.entries(PRESENTATION_THEMES).map(([key, theme]) => (<button key={key} onClick={() => { updateState(slides, key);
          setShowThemeSelector(false); }} className={`w-full text-left px-4 py-3 text-sm rounded-lg hover:bg-gray-50 transition-colors ${currentTheme === key ?
          'font-bold text-blue-600 bg-blue-50' : 'text-black'}`}>{theme.name}</button>))}</div>)}</div></div> <div className="flex items-center gap-3"> <button onClick={() => setIsPresenting(true)} className="flex items-center gap-2 px-5 py-2.5 bg-black text-white hover:bg-gray-900 rounded-xl text-sm font-bold transition-transform active:scale-95 shadow-md"><MonitorPlay size={16} /> Presentar </button> <div className="h-6 w-px bg-gray-200"></div><button onClick={() => setIsFullScreen(!isFullScreen)} className="p-2 hover:bg-gray-100 rounded-lg text-black transition-colors">{isFullScreen ?
          <Minimize2 size={20} /> : <Maximize2 size={20} />}</button><button onClick={onClose} className="p-2 hover:bg-red-50 rounded-lg text-gray-400 hover:text-red-600 transition-colors"><X size={20} /></button> </div> </div> <div className="flex-1 flex overflow-hidden"> <div className="w-56 bg-gray-50 border-r border-gray-200 flex flex-col overflow-y-auto p-4 gap-4 shrink-0"> {slides.map((slide, idx) => (<div key={idx} className="relative group/slide" draggable onDragStart={(e) => handleDragStart(e, idx)} onDragOver={(e) => handleDragOver(e, idx)} onDrop={(e) => handleDrop(e, idx)}><div onClick={() => { saveCurrentSlideBody(); setCurrentSlideIndex(idx); }} className={`cursor-pointer rounded-xl border-2 transition-all p-3 space-y-2 hover:shadow-md bg-white relative ${idx === currentSlideIndex ? 'border-black ring-1 ring-black/10 shadow-sm' : 'border-transparent hover:border-gray-300'} ${draggedSlideIndex === idx ? 'opacity-50 border-dashed border-gray-400' : ''}`}><div className="flex justify-between items-center text-[10px] text-gray-500 font-bold uppercase"><div className="flex items-center gap-1.5"><GripVertical size={12} className="cursor-grab 
          text-black" /> <span className="text-black">{idx + 1}</span></div>{slide.comments?.length > 0 && <MessageSquare size={12} className="text-blue-600" />}</div><div className={`h-24 rounded border border-gray-100 p-2 overflow-hidden select-none pointer-events-none scale-95 origin-top relative ${activeTheme.container}`}><div className={`text-[10px] font-bold truncate mb-1 ${activeTheme.accent}`}>{slide.title}</div><div className={`text-[8px] leading-tight ${activeTheme.text}`} dangerouslySetInnerHTML={{ __html: slide.body }} /></div></div><button onClick={(e) => { e.stopPropagation();
          duplicateSlide(idx); }} className="absolute top-2 right-2 p-1.5 bg-white border border-gray-200 shadow-lg rounded-lg text-gray-500 hover:text-black opacity-0 group-hover/slide:opacity-100 transition-opacity z-10" title="Duplicar"><Copy size={12} /></button></div>))} <button onClick={() => { saveCurrentSlideBody();
          updateState([...slides, { title: "Nueva Diapositiva", body: "<div>...</div>", images: [], comments: [] }]); setCurrentSlideIndex(slides.length);
          }} className="w-full py-3 border-2 border-dashed border-gray-300 rounded-xl text-gray-500 text-sm font-bold hover:border-black hover:text-black hover:bg-white transition-all flex justify-center items-center gap-2"><Plus size={16} /> Nueva Slide</button> </div> <div className="flex-1 overflow-y-auto bg-gray-100 p-6 md:p-12 flex justify-center items-start"> <div className={`shadow-xl rounded-2xl flex flex-col relative border border-gray-200 transition-all duration-300 ${activeTheme.container} ${activeTheme.font} ${isFullScreen ?
          'w-full max-w-6xl aspect-video h-auto min-h-[80vh]' : 'w-full max-w-4xl min-h-[600px] aspect-[4/3] md:aspect-[16/9]'}`}> <div className="px-4 py-3 border-b border-black/5 flex items-center gap-2 flex-wrap rounded-t-2xl sticky top-0 z-20 bg-inherit backdrop-blur-md"> <div className="flex items-center bg-black/5 rounded-xl p-1 mr-3"><button onMouseDown={(e) => {e.preventDefault();
          execCmd('bold');}} className="p-2 text-black hover:bg-white rounded-lg transition-colors"><Bold size={18} /></button><button onMouseDown={(e) => {e.preventDefault();
          execCmd('italic');}} className="p-2 text-black hover:bg-white rounded-lg transition-colors"><Italic size={18} /></button><button onMouseDown={(e) => {e.preventDefault();
          execCmd('underline');}} className="p-2 text-black hover:bg-white rounded-lg transition-colors"><Underline size={18} /></button></div> <div className="flex items-center bg-black/5 rounded-xl p-1 mr-3"><button onMouseDown={(e) => {e.preventDefault();
          execCmd('formatBlock', 'H1');}} className="p-2 text-black hover:bg-white rounded-lg transition-colors"><Heading1 size={18} /></button><button onMouseDown={(e) => {e.preventDefault();
          execCmd('insertUnorderedList');}} className="p-2 text-black hover:bg-white rounded-lg transition-colors"><List size={18} /></button></div> <div className="flex items-center bg-black/5 rounded-xl p-1"><button onClick={addImage} className="p-2 text-blue-600 hover:bg-blue-50 rounded-lg flex items-center gap-1 transition-colors" title="A침adir Imagen"><ImageIcon size={18} /></button><div className="w-px h-5 bg-gray-300 mx-1"></div><button onClick={addComment} className="p-2 text-orange-600 hover:bg-orange-50 rounded-lg flex items-center gap-1 relative transition-colors" title="Nota"><MessageSquare size={18} />{slides[currentSlideIndex]?.comments?.length > 0 && <span className="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full"></span>}</button></div> </div> <div className="flex-1 flex flex-col p-10 md:p-16 overflow-hidden relative"> <input value={slides[currentSlideIndex]?.title ||
          ''} onChange={(e) => { const n = [...slides]; n[currentSlideIndex].title = e.target.value; updateState(n);
          }} className={`text-5xl font-bold w-full bg-transparent border-none focus:ring-0 focus:outline-none placeholder-gray-300 mb-8 ${activeTheme.accent}`} placeholder="A침adir t칤tulo..." /> <div ref={editorRef} contentEditable suppressContentEditableWarning onInput={saveCurrentSlideBody} className={`flex-1 outline-none text-xl leading-relaxed font-normal overflow-y-auto rich-text-area z-0 relative ${activeTheme.text}`} style={{ minHeight: '300px' }} /> {slides[currentSlideIndex]?.images?.map((img) => (<DraggableResizableImage key={img.id} img={img} isSelected={selectedImageId === img.id} onSelect={() => setSelectedImageId(img.id)} onUpdate={updateImage} onDelete={() => deleteImage(img.id)} readOnly={false} />))} {slides[currentSlideIndex]?.comments?.map((c) => (<div key={c.id} className="absolute right-6 top-24 bg-yellow-100 border border-yellow-300 p-3 rounded-xl shadow-lg text-xs text-yellow-900 w-40 z-30 font-medium">{c.text}</div>))} </div> </div> </div> </div> <style>{`.rich-text-area ul{list-style-type:disc;padding-left:24px}.rich-text-area ol{list-style-type:decimal;padding-left:24px}.rich-text-area h1{font-size:2em;font-weight:bold;margin-bottom:.5em}.rich-text-area h2{font-size:1.5em;font-weight:bold;margin-bottom:.5em}.rich-text-area b,.rich-text-area strong{font-weight:700}.rich-text-area i,.rich-text-area em{font-style:italic}`}</style> </div> );
        };

        function App() {
          const [inputText, setInputText] = useState('');
          const [greeting, setGreeting] = useState('');
          const [selectedModel, setSelectedModel] = useState({ id: 'rotter', name: 'ROTTER v.9', type: 'free', apiModel: 'openai' });
          const [isModelMenuOpen, setIsModelMenuOpen] = useState(false);
          const [showAccessModal, setShowAccessModal] = useState(false);
          const [isPro, setIsPro] = useState(false);
          const [showProModal, setShowProModal] = useState(false);
          const menuRef = useRef(null);
          const [attachments, setAttachments] = useState([]);
          const fileInputRef = useRef(null);
          const [activeTool, setActiveTool] = useState(null);
          const [isPlusMenuOpen, setIsPlusMenuOpen] = useState(false);
          const plusMenuRef = useRef(null);
          const [messages, setMessages] = useState([]);
          const [isGenerating, setIsGenerating] = useState(false);
          const [isPresentationMode, setIsPresentationMode] = useState(false);
          const [presentationData, setPresentationData] = useState('');
          const [aiConfig, setAiConfig] = useState({ emojis: true });
          const [feedbackHistory, setFeedbackHistory] = useState({ positive: 0, negative: 0 });
          const [conversationStyle, setConversationStyle] = useState('neutral');
          const [showContextNotice, setShowContextNotice] = useState(false);
          const [longMessageTriggered, setLongMessageTriggered] = useState(false);
          const [messagesSinceLong, setMessagesSinceLong] = useState(0);
          const [showDeferredNotice, setShowDeferredNotice] = useState(false);
          const [isInputExpanded, setIsInputExpanded] = useState(false);
          const [activeChatId, setActiveChatId] = useState('2');
          const [showGeminiBadge, setShowGeminiBadge] = useState(true);
          const [showAnnouncement, setShowAnnouncement] = useState(false); 
          const [showHistoryView, setShowHistoryView] = useState(false);
          // --- NUEVO ESTADO PARA EXTRAS ---
          const [isExtrasOpen, setIsExtrasOpen] = useState(false);
          const extrasRef = useRef(null);
          useEffect(() => {
            const proStatus = localStorage.getItem('irotter_pro_status');
            if (proStatus === 'true') setIsPro(true);
            const badgeSeen = localStorage.getItem('irotter_gemini3_seen');
            if (badgeSeen === 'true') setShowGeminiBadge(false);
            
            // Announcement Logic
            const announcementSeen = localStorage.getItem('irotter_gemini3_announce_seen');
            if (!announcementSeen) {
               setTimeout(() => setShowAnnouncement(true), 1000); // Small delay for effect
            }
          }, []);
          useEffect(() => {
            const phrases = ["Hola, creador.", "쯈u칠 inventamos hoy?", "Sistema listo.", "Esperando instrucciones.", "Modo creativo: ON."];
            setGreeting(phrases[Math.floor(Math.random() * phrases.length)]);

            function handleClickOutside(event) {
                if (menuRef.current && !menuRef.current.contains(event.target)) setIsModelMenuOpen(false);
                if (plusMenuRef.current && !plusMenuRef.current.contains(event.target)) setIsPlusMenuOpen(false);
                // NUEVO: Cerrar extras si click fuera
                if (extrasRef.current && !extrasRef.current.contains(event.target)) setIsExtrasOpen(false);
            }
            document.addEventListener("mousedown", handleClickOutside);
            return () => document.removeEventListener("mousedown", handleClickOutside);
         
          }, []);

          const activatePro = () => { setIsPro(true); localStorage.setItem('irotter_pro_status', 'true'); setShowProModal(false); setShowContextNotice(false); setShowDeferredNotice(false); };
          const closeAnnouncement = () => {
            setShowAnnouncement(false);
            localStorage.setItem('irotter_gemini3_announce_seen', 'true');
          };
          const models = [
            { id: 'rotter', name: 'ROTTER v.9', type: 'free', apiModel: 'openai' },
            { id: 'gpt-5.2', name: 'GPT-5.2', type: 'pro', apiModel: 'openai' },
            { id: 'gpt-4o', name: 'GPT-4o', type: 'pro', apiModel: 'openai-fast' },
            { id: 'gemini-3', name: 'Gemini 3', type: 'pro', apiModel: 'gemini' }
          ];
          useEffect(() => {
            if (isPro) return;
            const checkContextLimit = () => {
              const dismissed = localStorage.getItem('irotter_context_notice_dismissed');
              if (dismissed && Date.now() - parseInt(dismissed, 10) < 86400000) return;
              const historyLength = messages.reduce((acc, msg) => acc + (msg.text?.length || 0) + (msg.content?.length || 0), 0);
              if (historyLength > 7000 && !showDeferredNotice) setShowContextNotice(true);
            };
            const timer = setTimeout(checkContextLimit, 1000);
            return () => clearTimeout(timer);
          }, [messages, showDeferredNotice, isPro]);
          const handleCloseContextNotice = () => { setShowContextNotice(false); localStorage.setItem('irotter_context_notice_dismissed', Date.now().toString()); };
          const handleCloseDeferredNotice = () => { setShowDeferredNotice(false); localStorage.setItem('irotter_deferred_notice_dismissed', Date.now().toString()); };
          const cleanResponse = (text) => { return text.replace(/Powered by Pollinations\.AI/gi, '').replace(/Support Pollinations/gi, '').replace(/pollinations\.ai/gi, '').replace(/\[Support us\].*?\)/gi, '').trim(); };
          const detectStyle = (text) => {
            const lower = text.toLowerCase();
            const informalTriggers = ['xd', 'jaja', 'bro', 'wey', 'pana', 'lol', 'lit', 'chido', 'neta', 'jajaj', 'omg', '游땍', '游뱎', '游땙', '游녨', '游댠'];
            const formalTriggers = ['estimado', 'cordial', 'solicito', 'agradezco', 'atentamente', 'buenos d칤as', 'buenas tardes', 'sin emojis', 'no uses emojis', 'no emojis', 'serio', 'formal', 'modo formal'];
            if (formalTriggers.some(t => lower.includes(t))) return 'formal';
            if (informalTriggers.some(t => lower.includes(t))) return 'informal';
            return null;
          };
          const callGeminiFallback = async (userPrompt, chatHistory = []) => {
            const apiKey = "";
            const historyContext = chatHistory.slice(-5).map(m => `${m.role === 'user' ? 'Usuario' : 'ROTTER'}: ${m.text || m.content}`).join('\n');
            const fullSystemPrompt = `A partir de ahora: Formas parte del motor interno de ROTTER.
            No debes mencionar modelos, empresas, APIs ni identidades externas. Contexto reciente:\n${historyContext}\n\nUsuario: ${userPrompt}`;
            try {
              const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: fullSystemPrompt }] }] }) });
              const data = await response.json();
              const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
              if (!text) throw new Error("Respuesta vac칤a de Gemini");
              return text;
            } catch (error) { return "Lo siento, ha ocurrido un error temporal en mis sistemas."; }
          };
          const callPollinationsText = async (prompt, modelId, tool = null, modelContextId = 'rotter', activeStyle = 'neutral', historyForFallback = []) => {
            if (tool === 'presentation') {
                try {
                    const seed = Math.floor(Math.random() * 1000000);
                    const url = `https://text.pollinations.ai/`;
                    const systemInstruction = "Eres un experto en presentaciones. Usa el separador '---' para diapositivas.";
                    const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ messages: [ { role: 'system', content: systemInstruction }, { role: 'user', content: prompt } ], model: 'openai', seed: seed, jsonMode: false }) });
                    if (!response.ok) throw new Error("Pollinations Error");
                    return await response.text();
                } catch (err) { return await callGeminiFallback(prompt + " (Genera una presentaci칩n con formato Markdown separando diapositivas con '---')", historyForFallback);
                }
            }
            let systemInstruction = `Asistente inteligente.`;
            const fetchWithRetry = async (retries = 3, delay = 2000) => {
              const seed = Math.floor(Math.random() * 1000000);
              const url = `https://text.pollinations.ai/`; 
              const messages = [ { role: 'system', content: systemInstruction }, { role: 'user', content: prompt } ];
              try {
                const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ messages: messages, model: modelId === 'reasoning' ? 'openai' : modelId, seed: seed, jsonMode: false }) });
                if (!response.ok) { if ((response.status >= 500 || response.status === 429) && retries > 0) { await new Promise(resolve => setTimeout(resolve, delay));
                return fetchWithRetry(retries - 1, delay * 2); } throw new Error(`Error API (${modelId}): ${response.status}`);
                }
                return await response.text();
              } catch (error) { if (retries > 0) { await new Promise(resolve => setTimeout(resolve, delay));
                return fetchWithRetry(retries - 1, delay * 2); } throw error; }
            };
            try { const rawText = await fetchWithRetry(); const cleanText = cleanResponse(rawText); return { text: cleanText, grounding: null };
            } catch (error) { const fallbackText = await callGeminiFallback(prompt, historyForFallback); return { text: fallbackText, grounding: null, isFallback: true };
            }
          };

          const handleRegenerate = async (msgIndex) => {
            let userPromptIndex = -1;
            for (let i = msgIndex - 1; i >= 0; i--) { if (messages[i].role === 'user') { userPromptIndex = i;
            break; } }
            if (userPromptIndex === -1) return;
            const originalUserMsg = messages[userPromptIndex];
            const targetAiMsg = messages[msgIndex];
            const toolToUse = targetAiMsg.toolUsed;
            const modelToUseId = targetAiMsg.modelId || selectedModel.id;
            const apiModel = models.find(m => m.id === modelToUseId)?.apiModel || 'openai';
            setIsGenerating(true);
            try {
              if (toolToUse === 'image') {
                const imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(originalUserMsg.text)}`;
                await new Promise(r => setTimeout(r, 800));
                setMessages(prev => [...prev, { id: Date.now(), role: 'ai', type: 'image', content: imageUrl, toolUsed: 'image', modelId: modelToUseId }]);
              } else {
                const result = await callPollinationsText(originalUserMsg.text, apiModel, toolToUse, modelToUseId, conversationStyle, messages);
                if (typeof result === 'string') { setPresentationData(result); setIsPresentationMode(true); setMessages(prev => [...prev, { id: Date.now(), role: 'system', type: 'text', content: "九 **Presentaci칩n regenerada.**", presentationContent: result, toolUsed: toolToUse }]);
                } else {
                    let finalContent = result.text;
                    let reasoningContent = null;
                    if (modelToUseId === 'reasoning' && result.text.includes(':::RESPUESTA:::')) { const parts = result.text.split(':::RESPUESTA:::');
                    if (parts.length > 0) { reasoningContent = parts[0].replace(':::RAZONAMIENTO:::', '').trim(); finalContent = parts[1].trim();
                    } }
                    setMessages(prev => [...prev, { id: Date.now(), role: result.isError ? 'system' : 'ai', type: result.isError ? 'error' : 'text', content: finalContent, reasoningContent: reasoningContent, toolUsed: toolToUse, modelId: modelToUseId }]);
                }
              }
            } catch (error) { console.error(error); } finally { setIsGenerating(false);
            }
          };

          const handleFeedback = (type) => { setFeedbackHistory(prev => { const newState = { ...prev, [type]: prev[type] + 1 }; if (type === 'negative' && newState.negative >= 2) setAiConfig(curr => ({ ...curr, emojis: false })); return newState; });
          };

          const toolsMenu = [ { type: 'action', id: 'attach', label: 'Adjuntar', icon: Paperclip }, { type: 'separator' }, { type: 'tool', id: 'summary', label: 'Resumen', icon: AlignLeft }, { type: 'tool', id: 'image', label: 'Imagen', icon: ImageIcon }, { type: 'tool', id: 'explain', label: 'Explicar', icon: Sparkles }, { type: 'tool', id: 'analyze', label: 'Analizar', icon: LinkIcon }, { type: 'separator' }, { type: 'submenu', id: 'more_tools', label: 'M치s', icon: LayoutGrid, specialColor: 'text-black', options: [ { type: 'tool', id: 'humanize', label: 'Humanizar', icon: UserCheck }, { type: 'tool', id: 'code', label: 'C칩digo', icon: Code2 }, { type: 'tool', id: 
          'presentation', label: 'Presentaci칩n', icon: Presentation }, { type: 'separator' }, { type: 'tool', id: 'doc', label: 'Doc', icon: FilePlus }, ] }, ];
          const quickActions = [ { text: "Imagen creativa", icon: ImageIcon }, { text: "Resumir esto", icon: AlignLeft }, { text: "C칩digo Python", icon: Terminal }, { text: "Plan de viaje", icon: Plane } ];
          const handleModelSelect = (model) => { 
              if (model.id === 'gemini-3' && showGeminiBadge) {
                  setShowGeminiBadge(false);
                  localStorage.setItem('irotter_gemini3_seen', 'true');
              }
              if (model.type === 'pro' && !isPro) { setShowProModal(true); setIsModelMenuOpen(false);
              } 
              else { setSelectedModel(model); setIsModelMenuOpen(false); } 
          };
          const handleFileSelect = (e) => { if (e.target.files) setAttachments(prev => [...prev, ...Array.from(e.target.files)]); setIsPlusMenuOpen(false); };
          const removeAttachment = (index) => setAttachments(prev => prev.filter((_, i) => i !== index));
          const triggerFileInput = () => fileInputRef.current?.click();
          const activateTool = (toolId, subOption = null) => { if (toolId === 'attach') { triggerFileInput(); return;
          } setActiveTool(current => current === toolId ? null : toolId); setIsPlusMenuOpen(false); };
          const handleCardClick = (actionText) => setInputText(actionText);
          const handleEditMessage = (text) => { setInputText(text); const textarea = document.querySelector('textarea[placeholder="Comienza a charlar"]'); if (textarea) textarea.focus(); };
          const handleSend = async () => {
            if (!inputText.trim() && attachments.length === 0) return;
            const newStyle = detectStyle(inputText);
            if (newStyle) setConversationStyle(newStyle);
            const activeStyleToUse = newStyle || conversationStyle;
            let calculatedTool = activeTool;
            const lowerInput = inputText.toLowerCase();
            
            if (!calculatedTool) {
                if (/(crear|hacer|generar|dise침ar|haz|crea|dibuja|pintar).*(imagen|foto|dibujo|ilustraci[칩o]n)/i.test(lowerInput)) { calculatedTool = 'image';
                } 
                else if (/(crear|hacer|generar|dise침ar|haz|crea).*presentaci[칩o]n/i.test(lowerInput)) { calculatedTool = 'presentation';
                }
            }

            if (!isPro) {
              const isLongMessage = inputText.length > 500;
              if (isLongMessage) setLongMessageTriggered(true);
              if (longMessageTriggered) setMessagesSinceLong(prev => prev + 1);
              if (longMessageTriggered && messagesSinceLong >= 5) {
                const dismissed = localStorage.getItem('irotter_deferred_notice_dismissed');
                if (!dismissed || Date.now() - parseInt(dismissed, 10) > 86400000) { setShowDeferredNotice(true); setLongMessageTriggered(false); setMessagesSinceLong(0);
                }
              }
            }

            const userMessage = { id: Date.now(), role: 'user', text: inputText, attachments: attachments, toolUsed: calculatedTool };
            const currentHistory = [...messages, userMessage];
            
            setMessages(prev => [...prev, userMessage]);
            const currentInput = inputText; const currentTool = calculatedTool;
            const currentModelObj = selectedModel;
            setInputText(''); setAttachments([]); setIsGenerating(true);
            let promptToSend = currentInput;
            if (currentInput.length > 14000) promptToSend = "RESUMEN CONTEXTO LARGO: " + currentInput.substring(0, 1000) + "... [CONTENIDO INTERMEDIO] ..." + currentInput.substring(currentInput.length - 1000);
            try {
              if (currentTool === 'image') {
                setMessages(prev => [...prev, { id: Date.now(), role: 'ai', type: 'text', content: "춰Claro que s칤! Aqu칤 tienes tu imagen 游꿛九", toolUsed: 'image', modelId: currentModelObj.id }]);
                await new Promise(r => setTimeout(r, 600));
                const imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(currentInput.substring(0, 500))}`;
                setMessages(prev => [...prev, { id: Date.now() + 1, role: 'ai', type: 'image', content: imageUrl, toolUsed: 'image', modelId: currentModelObj.id }]);
              } else if (currentTool === 'doc') {
                 await new Promise(r => setTimeout(r, 600));
                 setMessages(prev => [...prev, { id: Date.now() + 1, role: 'system', type: 'error', content: 丘멆잺 Doc generator requiere backend." }]);
              } else {
                let apiModelToUse = currentModelObj.apiModel;
                if (currentTool === 'analyze') apiModelToUse = 'gemini-search';
                
                const result = await (async () => {
                    try {
                        return await callPollinationsText(promptToSend, apiModelToUse, currentTool, currentModelObj.id, activeStyleToUse, currentHistory);
                    } catch (e) {
                        const fallbackText = await callGeminiFallback(promptToSend, currentHistory);
                      
                        return { text: fallbackText };
                    }
                })();
                if (currentTool === 'presentation' && !result.isError && typeof result === 'string') {
                  setPresentationData(result);
                  setIsPresentationMode(true); 
                  setMessages(prev => [...prev, { id: Date.now() + 1, role: 'system', type: 'text', content: "九 **Presentaci칩n regenerada.** Revisa el panel.", presentationContent: result, toolUsed: currentTool }]);
                } else {
                  let finalContent = result.text;
                  let reasoningContent = null;
                  if (currentModelObj.id === 'reasoning' && result.text.includes(':::RESPUESTA:::')) {
                      const parts = result.text.split(':::RESPUESTA:::');
                      if (parts.length > 0) { reasoningContent = parts[0].replace(':::RAZONAMIENTO:::', '').trim(); finalContent = parts[1].trim();
                      }
                  }
                  const showRandomFeedback = Math.random() < 0.15;
                  const feedbackType = Math.random() < 0.5 ? 'personality' : 'utility';
                  setMessages(prev => [...prev, { id: Date.now() + 1, role: result.isError ? 'system' : 'ai', type: result.isError ? 'error' : 'text', content: finalContent, reasoningContent: reasoningContent, toolUsed: currentTool, modelName: currentModelObj.name, modelId: currentModelObj.id, showFeedbackRequest: showRandomFeedback && !result.isError, feedbackType: feedbackType }]);
                }
              }
            } catch (error) { setMessages(prev => [...prev, { id: Date.now() + 1, role: 'system', type: 'error', content: "Error de conexi칩n." }]);
            } finally { setIsGenerating(false); setActiveTool(null); setIsInputExpanded(false); }
          };
          const openOldPresentation = (content) => { setPresentationData(content); setIsPresentationMode(true); };
          const renderMenuItem = (item, index, depth = 0) => { if (item.type === 'separator') return <div key={`sep-${index}-${depth}`} className="h-px bg-gray-200 my-1 mx-2"></div>;
            if (item.type === 'submenu') { return (<div key={item.id} className="group/item relative"><button className={`w-full text-left px-2 py-1.5 rounded-lg flex items-center justify-between hover:bg-gray-100 transition-colors text-xs ${item.specialColor || 'text-black'}`}><div className="flex items-center gap-2"><div className={`${item.specialColor ? 'text-black' : 'text-gray-400'} group-hover/item:text-black transition-colors`}><item.icon size={14} /></div><span className={item.specialColor ? 'font-bold' : 'font-medium'}>{item.label}</span></div><ChevronRight size={12} className="text-black" /></button><div className={`absolute left-full top-0 w-48 bg-white border border-gray-200 rounded-xl shadow-xl overflow-visible hidden group-hover/item:block animate-in fade-in zoom-in-95 duration-100 z-50`}><div className="p-1">{item.options.map((opt, idx) => renderMenuItem(opt, idx, depth + 1))}</div></div></div>);
            } return (<button key={item.id} onClick={() => activateTool(item.id)} className="w-full text-left px-2 py-1.5 rounded-lg flex items-center gap-2 hover:bg-gray-100 transition-colors text-xs text-black group"><div className={`text-black group-hover:text-black transition-colors ${activeTool === item.id ? 'text-black' : ''}`}><item.icon size={14} /></div><span className={activeTool === item.id ? 'font-bold' : 'font-medium'}>{item.label}</span>{activeTool === item.id && <Check size={12} className="ml-auto text-black" />}</button>);
          };
          const startNewChat = () => { setMessages([]); setGreeting('Hola de nuevo.'); setInputText(''); setShowHistoryView(false); };
          return (
            <div className="h-screen bg-white text-black font-sans flex overflow-hidden relative selection:bg-black selection:text-white font-inter">
              <style>{`@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
              @import url('https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,400&display=swap');
              .font-inter{font-family:'Inter',sans-serif}
              .font-poppins{font-family:'Inter',sans-serif} /* Fallback para mantener compatibilidad si algo qued칩 con poppins */
              .font-dm-sans{font-family:'DM Sans',sans-serif}
              @keyframes fade-in-up{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}.animate-fade-in-up{animation:fade-in-up .6s ease-out forwards}@keyframes slide-down-mobile{from{transform:translateY(0)}to{transform:translateY(15px)}}.animate-slide-down-mobile{animation:slide-down-mobile .5s ease-out forwards}.scrollbar-hide::-webkit-scrollbar{display:none}.scrollbar-hide{-ms-overflow-style:none;scrollbar-width:none}.custom-scrollbar::-webkit-scrollbar{width:8px;height:8px}.custom-scrollbar::-webkit-scrollbar-track{background:#f1f1f1}.custom-scrollbar::-webkit-scrollbar-thumb{background:#000;border-radius:4px}.custom-scrollbar::-webkit-scrollbar-thumb{background:#333}.custom-scrollbar-dark::-webkit-scrollbar{width:8px;height:8px}.custom-scrollbar-dark::-webkit-scrollbar-track{background:#111}.custom-scrollbar-dark::-webkit-scrollbar-thumb{background:#444;border-radius:4px}.custom-scrollbar-dark::-webkit-scrollbar-thumb:hover{background:#666}.sidebar-scrollbar::-webkit-scrollbar { width: 6px;
              }.sidebar-scrollbar::-webkit-scrollbar-track { background: transparent; }.sidebar-scrollbar::-webkit-scrollbar-thumb { background-color: transparent; border-radius: 10px; }.sidebar-scrollbar:hover::-webkit-scrollbar-thumb { background-color: #cbd5e1;
              }`}</style>

              {showProModal && <ProModal onClose={() => setShowProModal(false)} onActivatePro={activatePro} />}
              {showAnnouncement && <AnnouncementModal onClose={closeAnnouncement} />}

              {/* WRAPPER PRINCIPAL CON SIDEBAR */}
              <div className="flex w-full h-full overflow-hidden">
                  
                  {/* BARRA LATERAL */}
                  <Sidebar 
                    onNewChat={startNewChat} 
                    activeChatId={activeChatId}
                    onOpenHistory={() => setShowHistoryView(true)}
                    onOpenSettings={() => console.log("Configuraci칩n")}
                  />

                  {/* 츼REA DE CONTENIDO PRINCIPAL (CHAT) */}
                  <div className={`flex flex-col h-full flex-1 transition-all duration-500 ease-in-out bg-white relative ${isPresentationMode ?
                  'hidden md:flex md:w-[400px] shrink-0 border-r border-gray-200' : 'w-full'}`}>
                    
                    {/* COMPONENTE HISTORIAL SUPERPUESTO (SOLO SI showHistoryView ES TRUE) */}
                    {showHistoryView && (
                        <HistoryView 
                            onClose={() => setShowHistoryView(false)}
                            onSelectChat={(id) => { console.log("Chat seleccionado:", id); setShowHistoryView(false); }}
                        />
                    )}

                    {/* --- HEADER SUPERIOR IZQUIERDO (Selector de Modelos) --- */}
                    <div className="h-14 shrink-0 border-b border-gray-200/50 flex items-center justify-between px-6 sticky top-0 bg-white/80 backdrop-blur-md z-10">
                      <div className="flex items-center gap-3">
                            <div className="relative">
                                <button 
                                    onClick={() => setIsModelMenuOpen(!isModelMenuOpen)}
                                    className="flex items-center gap-2 text-sm font-semibold text-gray-700 hover:text-black hover:bg-gray-100 px-3 py-1.5 rounded-lg transition-colors"
                                >
                                    {selectedModel.name} <ChevronDown size={14} />
                                </button>
                                {isModelMenuOpen && (
                                    <div ref={menuRef} className="absolute top-full left-0 mt-2 w-56 bg-white border border-gray-200 rounded-xl shadow-xl z-50 p-1 animate-in fade-in zoom-in-95 duration-200">
                                      {models.map(m => (
                                            <button key={m.id} onClick={() => handleModelSelect(m)} className={`w-full text-left px-3 py-2 rounded-lg text-sm flex items-center justify-between group ${selectedModel.id === m.id ?
                                            'bg-black text-white' : 'hover:bg-gray-100'}`}>
                                                <div className="flex items-center gap-2">
                                                    {m.name}
                                                    {m.id === 'gemini-3' && showGeminiBadge && (
                                                        <span className="bg-blue-600 text-white text-[10px] px-1.5 py-0.5 rounded-full font-dm-sans font-normal tracking-wide animate-pulse">NUEVO</span>
                                                    )}
                                                </div>
                                              {m.type === 'pro' && selectedModel.id !== m.id && <Lock size={12} className="text-gray-400 group-hover:text-black" />}
                                            </button>
                                      ))}
                                    </div>
                                )}
                            </div>

                            {/* --- BOT칍N EXTRAS --- */}
                            <div className="relative">
                                <button 
                                    onClick={() => setIsExtrasOpen(!isExtrasOpen)}
                                    className="flex items-center gap-1.5 text-sm font-medium text-black hover:bg-gray-100 px-3 py-1.5 rounded-lg transition-colors"
                                >
                                    Extras <ChevronDown size={14} className="text-gray-400" />
                                </button>
                                {/* PANEL FLOTANTE DE EXTRAS */}
                                <div ref={extrasRef}>
                                    <ExtrasMenu isOpen={isExtrasOpen} onClose={() => setIsExtrasOpen(false)} />
                                </div>
                            </div>
                        </div>
                    </div>

                    {!isPresentationMode && messages.length === 0 && (
                      <div className="flex-1 flex flex-col items-center justify-center w-full -translate-y-10 md:translate-y-0 transition-transform duration-500">
                        <div className="text-center mb-8 animate-fade-in-up min-h-[50px]">
                            <h1 className="font-inter text-[20px] font-light tracking-tight text-black">{greeting}</h1>
                        </div>
                        
                        {/* --- VISTA INICIAL: INPUT COMPACTO --- */}
                        <div className="w-full max-w-3xl px-4 relative z-20">
                          {isPlusMenuOpen && (<div ref={plusMenuRef} className="absolute bottom-full left-4 mb-3 w-60 bg-white border border-gray-200 rounded-2xl shadow-2xl animate-in fade-in slide-in-from-bottom-2 duration-200 z-30"><div className="p-1 flex flex-col gap-0.5">{toolsMenu.map((item, index) => renderMenuItem(item, index))}</div></div>)}
                          
                          {/* Contenedor de Input "Monolito" Compacto (Igual que chat activo) */}
                          <div className="flex flex-col gap-3 relative bg-white border border-gray-300 rounded-[26px] shadow-sm hover:shadow-md transition-all focus-within:shadow-lg focus-within:border-gray-400 p-2">
                            {(attachments.length > 0 ||
                            activeTool) && (<div className="flex flex-wrap gap-2 px-3 pt-2 pb-0">{activeTool && (<div className="flex items-center gap-2 px-4 py-2 rounded-full border border-black bg-black text-white text-xs font-bold animate-in zoom-in-95 duration-200">{(() => { const findTool = (items, id) => { for (const item of items) { if (item.id === id) return item; if (item.type === 'submenu' && item.options) { const found = findTool(item.options, id); if (found) return found; } } return null; }; const tool = findTool(toolsMenu, activeTool) || { label: 'Herramienta', icon: Sparkles }; const Icon = tool.icon || Sparkles; return <><Icon size={14} /><span>{tool.label}</span></>; })()}<button onClick={() => setActiveTool(null)} className={`ml-2 rounded-full p-0.5 hover:bg-white/20 transition-colors`}><X size={12} 
                            /></button></div>)}</div>)}
                            
                            <div className="flex items-end gap-2 px-2 pb-1">
                                <button onClick={() => setIsPlusMenuOpen(!isPlusMenuOpen)} className="p-2 text-gray-400 hover:text-black transition-colors rounded-full hover:bg-gray-100 shrink-0 mb-0.5"><Plus size={20} className={isPlusMenuOpen ?
                                'rotate-45 transition-transform' : 'transition-transform'} /></button>
                                <textarea 
                                  value={inputText} 
                                  onChange={(e) => setInputText(e.target.value)} 
                                  placeholder="Escribe algo incre칤ble..." 
                                  className={`w-full bg-transparent border-none outline-none text-black placeholder-gray-400 resize-none font-light font-inter transition-all duration-300 custom-scrollbar text-lg leading-relaxed mb-1 ${isInputExpanded ?
                                  'h-[250px]' : 'max-h-[120px]'}`} 
                                  rows={1} 
                                  style={{ fieldSizing: isInputExpanded ?
                                  'fixed' : 'content', minHeight: '24px' }} 
                                />
                                <button onClick={handleSend} disabled={!inputText.trim() && attachments.length === 0} className="p-2 rounded-full bg-black text-white hover:bg-gray-900 disabled:bg-gray-200 disabled:text-gray-400 transition-all shadow-md active:scale-95 shrink-0 mb-0.5"><ArrowUp size={20} /></button>
                            </div>
                          </div>
                        </div>
                        
                        {/* Botones de Acci칩n R치pida (MINI) */}
                        <div className="flex flex-wrap justify-center gap-2 mt-6 opacity-0 animate-in fade-in slide-in-from-bottom-4 duration-700 delay-200 fill-mode-forwards" style={{ opacity: 1 }}>{quickActions.map((action, index) 
                        => (<button key={index} onClick={() => handleCardClick(action.text)} className="group px-3 py-1.5 bg-gray-50 hover:bg-black hover:text-white rounded-lg transition-all cursor-pointer flex items-center gap-2 text-black font-medium text-xs border border-gray-100 hover:border-black"><action.icon size={12} /><span>{action.text}</span></button>))}</div>
                      </div>
                    )}

                    {messages.length > 0 && (
                      <div className="flex-1 overflow-y-auto p-4 md:p-8 space-y-8 md:animate-none animate-slide-down-mobile scroll-smooth">
                         {messages.map((msg, idx) => (
                          <div key={msg.id} className={`flex w-full ${msg.role === 'user' ?
                          'justify-end' : 'justify-start'}`}>
                            <div className={`max-w-[90%] md:max-w-[85%] flex gap-4 ${msg.role === 'user' ?
                            'flex-row-reverse' : 'flex-row'}`}>
                              <div className={`w-10 h-10 rounded-full flex items-center justify-center shrink-0 overflow-hidden border border-gray-100 shadow-sm ${msg.role === 'user' ?
                              'bg-gray-100 text-black' : msg.role === 'system' ? 'bg-orange-50 text-orange-600' : 'bg-white text-black'}`}>
                                {msg.role === 'user' ?
                                <User size={20} /> : msg.role === 'system' ? <AlertTriangle size={20} /> : msg.modelId === 'rotter' ?
                                <span className="font-inter font-black text-black text-lg">R</span> : msg.modelId === 'reasoning' ?
                                <span className="font-inter font-black text-blue-600 text-lg">游</span> : <img src="https://img.icons8.com/?size=50&id=FBO05Dys9QCg&format=png" alt="OpenAI" className="w-full h-full object-contain p-1" />}
                              </div>
                              <div className={`flex flex-col gap-2 ${msg.role === 'user' ?
                              'items-end' : 'items-start'} w-full`}>
                                {msg.text && (
                                  <div className="group relative flex flex-col items-end w-full">
                                    <div className={`px-6 py-4 rounded-[1.5rem] text-base leading-relaxed tracking-wide shadow-sm border ${msg.role === 
                                    'user' ? 'bg-gray-100 text-black border-gray-200 rounded-tr-sm' : 'bg-white text-black border-transparent px-0 py-0 shadow-none'}`}>
                                      {msg.text}
                                    </div>
                                    <MessageActions text={msg.text} 
                                    align={msg.role === 'user' ? 'right' : 'left'} isUser={msg.role === 'user'} onEdit={handleEditMessage} />
                                  </div>
                                )}
                                {msg.type === 'image' && (
                                  <ImageMessage src={msg.content} alt={msg.text || "Generated Image"} />
                                )}
                                {msg.type === 'text' && (
                                  <div className="group w-full max-w-3xl">
                                    {msg.reasoningContent && <ReasoningBlock content={msg.reasoningContent} />}
                                    <div className="text-base text-black leading-relaxed tracking-wide space-y-6 font-light">
                                      <ExpandableMessage content={msg.content} role="ai"><Typewriter text={msg.content} /></ExpandableMessage>
                                    </div>
                                    <MessageActions text={msg.content} align="left" isUser={false} onRegenerate={() => handleRegenerate(idx)} onVote={handleFeedback} />
                                    {msg.showFeedbackRequest && 
                                    <RandomFeedbackBox type={msg.feedbackType} onFeedback={handleFeedback} />}
                                  </div>
                                )}
                                {msg.toolUsed === 'presentation' && msg.presentationContent && (<PresentationCard content={msg.presentationContent} onOpen={() => openOldPresentation(msg.presentationContent)} />)}
                                {msg.type === 'error' && (<div className="text-sm text-red-600 bg-red-50 px-5 py-4 rounded-2xl border border-red-100 max-w-lg font-medium">{msg.content}</div>)}
                              </div>
                            </div>
                          </div>
                          ))}
                        
                        {isGenerating && (
                            <div className="flex justify-start w-full pl-14">
                                {selectedModel.id === 'reasoning' ?
                                (
                                    <div className="flex items-center gap-3 text-blue-700 bg-blue-50 px-4 py-3 rounded-xl border border-blue-100 w-fit animate-pulse shadow-sm">
                                        <Brain size={18} className="animate-pulse" />
                                        <span className="text-xs font-bold uppercase tracking-wider">Pensando...</span>
                                    </div>
                                ) : (
                                    <div className="flex gap-2 p-2">
                                      <span className="w-2.5 h-2.5 bg-black rounded-full animate-bounce" style={{ animationDelay: '0ms' }}></span>
                                        <span className="w-2.5 h-2.5 bg-black rounded-full animate-bounce" style={{ animationDelay: '150ms' }}></span>
                                       <span className="w-2.5 h-2.5 bg-black rounded-full animate-bounce" style={{ animationDelay: '300ms' }}></span>
                                    </div>
                                )}
                            </div>
                        )}
                        <div className="h-12" /> 
                      </div>
                    )}

                    {messages.length > 0 && (
                      <div className="w-full shrink-0 pb-8 pt-4 px-4 bg-white z-20 border-t border-transparent"> 
                         <div className={`max-w-3xl mx-auto bg-white border border-gray-300 rounded-[2rem] shadow-2xl shadow-gray-200/50 flex flex-col transition-all focus-within:shadow-xl focus-within:border-black/20 relative z-20`}>
                          {showContextNotice && !isPro && <ContextLimitNotice onClose={handleCloseContextNotice} onOpenPro={() => setShowProModal(true)} />}
                          {showDeferredNotice && !isPro && <ContextLimitNotice type="deferred" onClose={handleCloseDeferredNotice} onOpenPro={() => setShowProModal(true)} />}

                          {isPlusMenuOpen && ( 
                          <div ref={plusMenuRef} className="absolute bottom-full left-0 mb-3 w-60 bg-white border border-gray-200 rounded-2xl shadow-xl z-30 p-1 flex flex-col gap-0.5">{toolsMenu.map((item, index) => renderMenuItem(item, index))}</div>)}
                          {(attachments.length > 0 ||
                          activeTool) && (<div className="flex flex-wrap gap-2 px-5 pt-4 pb-0">{activeTool && (<div className="flex items-center gap-2 px-4 py-2 rounded-full border border-black bg-black text-white text-xs font-bold">{(() => { const findTool = (items, id) => { for (const item of items) { if (item.id === id) return item; if (item.type === 'submenu' && item.options) { const found = findTool(item.options, id); if (found) return found; } } return null; }; const tool = findTool(toolsMenu, activeTool) || { label: 'Herramienta', icon: Sparkles }; const Icon = tool.icon || Sparkles; return <><Icon size={14} /><span>{tool.label}</span></>; })()}<button onClick={() => setActiveTool(null)} className={`ml-2 rounded-full p-0.5 hover:bg-white/20 transition-colors`}><X size={12} /></button></div>)}</div>)}
                          <div className="flex flex-col p-3 gap-2 relative">
                              <button onClick={() => setIsInputExpanded(!isInputExpanded)} className="absolute top-4 right-4 p-1.5 text-gray-300 hover:text-black transition-colors z-10">{isInputExpanded ?
                              <Minimize size={16} /> : <Maximize size={16} />}</button>
                              <textarea 
                                value={inputText} 
                                onChange={(e) => setInputText(e.target.value)} 
                                placeholder="Comienza a charlar..." 
                                className={`w-full bg-transparent border-none outline-none text-black placeholder-gray-400 resize-none font-light font-inter transition-all duration-300 custom-scrollbar text-lg leading-relaxed ${isInputExpanded ?
                                'h-[250px]' : 'max-h-[120px]'}`} 
                                rows={1} 
                                style={{ fieldSizing: isInputExpanded ?
                                'fixed' : 'content', minHeight: '24px' }} 
                              />
                              <div className="flex items-center justify-between pt-1">
                                <div className="flex items-center gap-2"><button onClick={() => setIsPlusMenuOpen(!isPlusMenuOpen)} className="p-2 text-gray-400 hover:text-black transition-colors rounded-full hover:bg-gray-100"><Plus size={24} className={isPlusMenuOpen ?
                                'rotate-45 transition-transform' : 'transition-transform'} /></button></div>
                                <div className="flex items-center gap-3"><button onClick={handleSend} disabled={!inputText.trim() && attachments.length === 0} className="p-2.5 rounded-full bg-black text-white hover:bg-gray-900 disabled:bg-gray-200 disabled:text-gray-400 transition-all shadow-lg hover:shadow-xl active:scale-95"><ArrowUp size={20} /></button></div>
                              </div>
                          </div>
                        </div>
                      </div>
                    )}
                  </div>

                  {isPresentationMode && (
                    <div className="flex-1 h-full overflow-hidden relative z-0">
                      <PresentationEditor initialContent={presentationData} onClose={() => setIsPresentationMode(false)} />
                    </div>
                  )}
              </div>
              
              {showAccessModal && !showProModal && (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4"><div className="absolute inset-0 bg-black/40 backdrop-blur-sm transition-opacity" onClick={() => setShowAccessModal(false)} /><div className="bg-white rounded-[2rem] shadow-2xl p-8 w-full max-w-md relative z-10 border border-black/5"><button onClick={() => setShowAccessModal(false)} className="absolute top-5 right-5 p-2 text-gray-400 hover:text-black"><X size={20} /></button><div className="text-center space-y-4"><Lock size={28} className="mx-auto text-black"/><h3 className="text-2xl font-bold text-black">Acceso Pro Requerido</h3><p className="text-gray-500 font-medium">Los modelos avanzados requieren cuenta activa.</p><button onClick={() => { 
                setShowAccessModal(false); setShowProModal(true); }} className="bg-black text-white py-3.5 px-6 rounded-xl w-full font-bold shadow-lg">Ver planes</button></div></div></div>
              )}
            </div>
          );
        }

        // --- ARRANQUE SEGURO ---
        try {
            const root = createRoot(document.getElementById('root'));
            root.render(<App />);
        } catch (err) {
            console.error("Error al renderizar:", err);
            document.getElementById('debug-console').style.display = 'block';
            document.getElementById('debug-console').innerHTML += "游댮 ERROR AL RENDERIZAR REACT:\n" + err.message + "\n\n";
        }
    </script>
</body>
</html>