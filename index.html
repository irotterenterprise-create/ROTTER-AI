<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ROTTER AI</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Google Fonts: Inter & DM Sans -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=DM+Sans:opsz,wght@9..40,400;500;700&display=swap" rel="stylesheet">

    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        /* Tipografía y Base */
        body { font-family: 'Inter', sans-serif; background-color: #ffffff; color: #000000; }
        .font-dm-sans { font-family: 'DM Sans', sans-serif; }
        
        /* Scrollbars */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #cbd5e1; }

        .sidebar-scrollbar::-webkit-scrollbar { width: 4px; }
        .sidebar-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .sidebar-scrollbar::-webkit-scrollbar-thumb { background: transparent; border-radius: 10px; }
        .sidebar-scrollbar:hover::-webkit-scrollbar-thumb { background: #cbd5e1; }

        /* Animaciones */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fadeIn 0.2s ease-out forwards; }
        
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-slide-up { animation: slideUp 0.3s ease-out forwards; }

        @keyframes zoomIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .animate-zoom-in { animation: zoomIn 0.2s ease-out forwards; }

        @keyframes pulse-slow { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .animate-pulse-slow { animation: pulse-slow 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }

        /* Clases de utilidad específicas para replicar React */
        .sidebar-transition { transition: width 0.3s ease-in-out, background-color 0.3s; }
        .fade-in-fast { animation: fadeIn 0.1s ease-out forwards; }
        
        /* Markdown Styles */
        .prose p { margin-bottom: 0.8em; line-height: 1.6; }
        .prose ul { list-style-type: disc; padding-left: 1.2em; margin-bottom: 0.8em; }
        .prose ol { list-style-type: decimal; padding-left: 1.2em; margin-bottom: 0.8em; }
        .prose strong { font-weight: 700; color: #000; }
        .prose code { background-color: #f3f4f6; padding: 0.1em 0.3em; border-radius: 0.2em; font-family: monospace; font-size: 0.9em; color: #dc2626; border: 1px solid #e5e7eb; }
        .prose pre { background-color: #0a0a0a; color: #e5e7eb; padding: 1em; border-radius: 0.5em; overflow-x: auto; margin-bottom: 1em; border: 1px solid rgba(255,255,255,0.1); }
        .prose pre code { background-color: transparent; color: inherit; border: none; padding: 0; }
        .prose h1, .prose h2, .prose h3 { font-weight: 700; margin-top: 1em; margin-bottom: 0.5em; color: #000; }
    </style>
</head>
<body class="h-screen flex overflow-hidden selection:bg-black selection:text-white">

    <!-- SIDEBAR -->
    <div id="sidebar" class="hidden md:flex flex-col h-full border-r border-gray-200 shrink-0 sidebar-transition relative z-40 bg-white w-[260px]">
        
        <!-- Cabecera Sidebar -->
        <div id="sidebar-header" class="flex items-center h-14 px-4 justify-between shrink-0 transition-all duration-300">
            <div id="logo-container" class="flex items-center gap-2 animate-fade-in">
                <span class="font-sans font-bold text-sm tracking-tight text-black">ROTTER AI</span>
            </div>
            <button id="btn-collapse" class="p-1.5 rounded-lg text-black hover:bg-gray-200 transition-colors">
                <i data-lucide="panel-left-close" width="16" height="16" stroke-width="1.2"></i>
            </button>
        </div>

        <!-- Botón Expandir (Solo visible cuando colapsado) -->
        <div id="collapsed-header" class="hidden h-14 w-full items-center justify-center">
            <button id="btn-expand" class="group relative w-9 h-9 flex items-center justify-center bg-gray-100 hover:bg-gray-200 rounded-xl transition-all duration-300 shadow-sm">
                <span class="font-sans font-bold text-lg text-black group-hover:opacity-0 transition-opacity duration-200 absolute">R</span>
                <i data-lucide="panel-left-open" width="16" height="16" stroke-width="1.5" class="text-black opacity-0 group-hover:opacity-100 transition-opacity duration-200 absolute"></i>
            </button>
        </div>

        <!-- Opciones Principales -->
        <div class="flex flex-col gap-1 px-3 mt-2 flex-1 overflow-y-auto sidebar-scrollbar" id="sidebar-options">
            <!-- Items generados dinámicamente -->
        </div>

        <!-- Perfil / Configuración (Footer) -->
        <div class="p-3 border-t border-gray-200 mt-auto">
            <button class="sidebar-item w-full flex items-center px-3 py-2 rounded-[8px] gap-3 text-black hover:bg-gray-100 transition-all group">
                <i data-lucide="settings" width="14" height="14" stroke-width="1.2" class="shrink-0 text-black"></i>
                <span class="text-[13px] truncate text-black fade-in-fast sidebar-label">Configuración</span>
            </button>
        </div>
    </div>

    <!-- ÁREA DE CONTENIDO PRINCIPAL -->
    <div class="flex flex-col h-full flex-1 transition-all duration-500 ease-in-out bg-white relative w-full">
        
        <!-- HEADER SUPERIOR (Sticky) -->
        <div class="h-14 shrink-0 border-b border-gray-200/50 flex items-center justify-between px-6 sticky top-0 bg-white/80 backdrop-blur-md z-30">
            <div class="flex items-center gap-3">
                
                <!-- Selector de Modelos -->
                <div class="relative">
                    <button id="btn-model-menu" class="flex items-center gap-2 text-sm font-semibold text-gray-700 hover:text-black hover:bg-gray-100 px-3 py-1.5 rounded-lg transition-colors">
                        <span id="selected-model-name">ROTTER v.9</span>
                        <i data-lucide="chevron-down" width="14" height="14"></i>
                    </button>
                    <!-- Menú Modelos -->
                    <div id="model-menu" class="hidden absolute top-full left-0 mt-2 w-56 bg-white border border-gray-200 rounded-xl shadow-xl z-50 p-1 animate-zoom-in">
                        <button onclick="selectModel('ROTTER v.9')" class="w-full text-left px-3 py-2 rounded-lg text-sm flex items-center gap-2 hover:bg-gray-100 transition-colors bg-black text-white" id="model-rotter">
                            ROTTER v.9
                        </button>
                        <button onclick="selectModel('GPT-5.2')" class="w-full text-left px-3 py-2 rounded-lg text-sm flex items-center justify-between hover:bg-gray-100 transition-colors group text-black">
                            GPT-5.2 <i data-lucide="lock" width="12" class="text-gray-400 group-hover:text-black"></i>
                        </button>
                        <button onclick="selectModel('GPT-4o')" class="w-full text-left px-3 py-2 rounded-lg text-sm flex items-center justify-between hover:bg-gray-100 transition-colors group text-black">
                            GPT-4o <i data-lucide="lock" width="12" class="text-gray-400 group-hover:text-black"></i>
                        </button>
                        <button onclick="selectModel('Gemini 3')" class="w-full text-left px-3 py-2 rounded-lg text-sm flex items-center justify-between hover:bg-gray-100 transition-colors group text-black">
                            <span class="flex items-center gap-2">Gemini 3 <span id="gemini-badge" class="bg-blue-600 text-white text-[10px] px-1.5 py-0.5 rounded-full font-dm-sans font-normal tracking-wide animate-pulse-slow">NUEVO</span></span>
                            <i data-lucide="lock" width="12" class="text-gray-400 group-hover:text-black"></i>
                        </button>
                    </div>
                </div>

                <!-- Botón EXTRAS -->
                <div class="relative">
                    <button id="btn-extras-menu" class="flex items-center gap-1.5 text-sm font-medium text-black hover:bg-gray-100 px-3 py-1.5 rounded-lg transition-colors">
                        Extras <i data-lucide="chevron-down" width="14" height="14" class="text-gray-400"></i>
                    </button>
                    <!-- Panel Flotante Extras -->
                    <div id="extras-menu" class="hidden absolute top-full left-0 mt-3 w-[340px] bg-white rounded-2xl shadow-2xl border border-gray-100 p-2 z-50 animate-zoom-in origin-top-left overflow-hidden">
                        <div class="max-h-[80vh] overflow-y-auto custom-scrollbar p-2">
                            <!-- Sección Herramientas -->
                            <div class="mb-4">
                                <h3 class="px-3 py-2 text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Herramientas</h3>
                                <div class="space-y-0.5" id="extras-tools-list">
                                    <!-- JS Genera esto -->
                                </div>
                            </div>
                            <div class="h-px bg-gray-100 mx-3 mb-4"></div>
                            <!-- Sección Funciones -->
                            <div>
                                <h3 class="px-3 py-2 text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Funciones del chat</h3>
                                <div class="space-y-0.5" id="extras-functions-list">
                                    <!-- JS Genera esto -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- CONTENEDOR VISTA DE CHAT -->
        <div id="chat-viewport" class="flex-1 overflow-y-auto p-4 md:p-8 space-y-8 scroll-smooth custom-scrollbar relative">
            
            <!-- Pantalla de Bienvenida (Greeting) -->
            <div id="welcome-screen" class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none transition-transform duration-500">
                <div class="text-center mb-8 animate-slide-up min-h-[50px]">
                    <h1 id="greeting-text" class="font-inter text-[20px] font-light tracking-tight text-black">Hola, creador.</h1>
                </div>
            </div>

            <!-- Lista de Mensajes -->
            <div id="messages-list" class="flex flex-col gap-8 pb-12 w-full max-w-full">
                <!-- Mensajes JS -->
            </div>

            <!-- Loader (Pensando) -->
            <div id="ai-loader" class="hidden pl-14 w-full justify-start">
                <div class="flex gap-2 p-2">
                    <span class="w-2.5 h-2.5 bg-black rounded-full animate-bounce" style="animation-delay: 0ms"></span>
                    <span class="w-2.5 h-2.5 bg-black rounded-full animate-bounce" style="animation-delay: 150ms"></span>
                    <span class="w-2.5 h-2.5 bg-black rounded-full animate-bounce" style="animation-delay: 300ms"></span>
                </div>
            </div>
        </div>
        
        <!-- VISTA HISTORIAL FLOTANTE -->
        <div id="history-view" class="hidden absolute top-16 left-4 md:left-20 w-[400px] bg-white/95 backdrop-blur-xl border border-gray-200 shadow-2xl rounded-2xl flex-col p-4 z-40 transition-all duration-300 max-h-[600px]">
             <!-- Header Historial -->
             <div class="flex items-center justify-between mb-4 shrink-0">
                <div class="flex items-center gap-2">
                   <button id="btn-history-expand" class="p-2 hover:bg-gray-100 rounded-lg text-gray-500 hover:text-black transition-colors" title="Expandir">
                     <i data-lucide="maximize-2" width="18" height="18"></i>
                   </button>
                   <h2 class="font-bold text-lg text-black">Historial</h2>
                </div>
                <button id="btn-history-close" class="p-2 hover:bg-red-50 text-gray-400 hover:text-red-600 rounded-lg transition-colors">
                    <i data-lucide="x" width="18" height="18"></i>
                </button>
            </div>
            <!-- Buscador -->
            <div class="relative mb-4 shrink-0">
                <i data-lucide="search" width="16" class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                <input type="text" placeholder="Buscar en tus chats..." class="w-full pl-9 pr-4 py-2.5 bg-gray-50 border border-gray-200 rounded-xl text-sm outline-none focus:border-black/20 focus:bg-white transition-all font-inter">
            </div>
            <!-- Lista Chats -->
            <div id="history-list-content" class="flex-1 overflow-y-auto custom-scrollbar pr-1 space-y-2 max-h-[400px]">
                <!-- JS Generado -->
            </div>
        </div>

        <!-- ÁREA DE INPUT (Monolito) -->
        <div class="w-full shrink-0 pb-8 pt-4 px-4 bg-white z-20">
            <div class="max-w-3xl mx-auto relative z-20">
                <!-- Panel Herramientas (Plus Menu) -->
                <div id="plus-menu" class="hidden absolute bottom-full left-0 mb-3 w-60 bg-white border border-gray-200 rounded-2xl shadow-2xl animate-slide-up z-30 p-1 flex flex-col gap-0.5">
                    <!-- JS generará menú -->
                </div>

                <div class="flex flex-col gap-3 relative bg-white border border-gray-300 rounded-[26px] shadow-sm hover:shadow-md transition-all focus-within:shadow-lg focus-within:border-gray-400 p-2">
                    <!-- Tags de adjuntos / herramientas activas irían aquí -->
                    <div class="flex items-end gap-2 px-2 pb-1 relative">
                        <button id="btn-plus" class="p-2 text-gray-400 hover:text-black transition-colors rounded-full hover:bg-gray-100 shrink-0 mb-0.5">
                            <i data-lucide="plus" width="20" height="20" class="transition-transform duration-200"></i>
                        </button>
                        
                        <textarea id="chat-textarea" rows="1" placeholder="Comienza a charlar..." class="w-full bg-transparent border-none outline-none text-black placeholder-gray-400 resize-none font-light font-inter transition-all duration-300 custom-scrollbar text-lg leading-relaxed max-h-[120px] py-2" style="min-height: 24px;"></textarea>
                        
                        <button id="btn-send" disabled class="p-2 rounded-full bg-black text-white hover:bg-gray-900 disabled:bg-gray-200 disabled:text-gray-400 transition-all shadow-md active:scale-95 shrink-0 mb-0.5">
                            <i data-lucide="arrow-up" width="20" height="20"></i>
                        </button>
                    </div>
                </div>

                <!-- Acciones Rápidas -->
                <div id="quick-actions" class="flex flex-wrap justify-center gap-2 mt-6 opacity-0 animate-fade-in" style="animation-delay: 0.2s; opacity: 1;">
                    <!-- JS Generado -->
                </div>
            </div>
        </div>

    </div>

    <!-- Modales -->
    <div id="modal-overlay" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/40 backdrop-blur-sm transition-opacity">
        <div class="bg-white rounded-[2rem] shadow-2xl p-8 w-full max-w-sm relative z-10 animate-zoom-in border border-black/5 text-center space-y-6">
            <button onclick="closeModal()" class="absolute top-5 right-5 p-2 text-gray-400 hover:text-black transition-colors rounded-full hover:bg-gray-100"><i data-lucide="x" width="20"></i></button>
            <div>
                <div class="w-12 h-12 bg-black text-white rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg"><i data-lucide="zap" width="24" fill="currentColor"></i></div>
                <h3 class="text-2xl font-bold text-black tracking-tight">ROTTER Pro</h3>
            </div>
            <button class="w-full py-4 px-6 rounded-2xl font-bold text-white bg-black hover:bg-gray-900 active:scale-95 transition-all flex items-center justify-center gap-2 shadow-xl">
                Activar Ahora
            </button>
        </div>
    </div>

    <script>
        // --- ESTADO GLOBAL ---
        const state = {
            isSidebarCollapsed: false,
            isModelMenuOpen: false,
            isExtrasOpen: false,
            isPlusMenuOpen: false,
            isHistoryOpen: false,
            isHistoryExpanded: false,
            messages: [],
            currentModel: 'ROTTER v.9'
        };

        // --- DATOS ---
        const sidebarItems = [
            { icon: 'plus', label: 'Nuevo Chat', action: 'newChat' },
            { icon: 'search', label: 'Buscar Chats', action: 'search' },
            { icon: 'archive', label: 'Proyectos', action: 'projects' },
            { icon: 'brain', label: 'Agentes', action: 'agents' },
            { icon: 'history', label: 'Historial', action: 'toggleHistory' } // Icono History
        ];

        const extrasTools = [
            { icon: 'file-text', label: "Crear documentos", desc: "Word, PDF, textos largos" },
            { icon: 'align-left', label: "Resumir contenido", desc: "Sintetizar información clave" },
            { icon: 'refresh-cw', label: "Reescribir textos", desc: "Mejorar redacción y tono" },
            { icon: 'list', label: "Organizar ideas", desc: "Estructurar puntos clave" },
            { icon: 'list-ordered', label: "Dividir en fases", desc: "Respuestas paso a paso" },
            { icon: 'layout-template', label: "Respuestas estructuradas", desc: "Títulos, divisores, emojis" },
            { icon: 'brain', label: "Modo razonamiento", desc: "Análisis profundo lógico" },
            { icon: 'zap', label: "Respuestas rápidas", desc: "Concisión y velocidad" },
        ];
        
        const extrasFuncs = [
            { icon: 'message-square', label: "Contexto extendido", desc: "Para charlas largas" },
            { icon: 'archive', label: "Memoria de chat", desc: "Recordar datos previos" },
            { icon: 'save', label: "Guardar respuestas", desc: "Almacenar en favoritos" },
            { icon: 'search', label: "Buscar en chat", desc: "Localizar información" },
            { icon: 'code-2', label: "Formato avanzado", desc: "Uso de divisores '--'" },
            { icon: 'check-circle', label: "Cierre claro", desc: "Conclusiones y resúmenes" },
        ];

        const quickActionsData = [
            { text: "Imagen creativa", icon: "image" },
            { text: "Resumir esto", icon: "align-left" },
            { text: "Código Python", icon: "terminal" },
            { text: "Plan de viaje", icon: "plane" }
        ];

        // --- INICIALIZACIÓN ---
        document.addEventListener('DOMContentLoaded', () => {
            initIcons();
            renderSidebar();
            renderExtras();
            renderQuickActions();
            renderHistoryItems();
            
            // Random Greeting
            const greetings = ["Hola, creador.", "¿Qué inventamos hoy?", "Sistema listo.", "Esperando instrucciones.", "Modo creativo: ON."];
            document.getElementById('greeting-text').innerText = greetings[Math.floor(Math.random() * greetings.length)];

            // Event Listeners Globales
            document.addEventListener('click', handleGlobalClick);
            
            // Textarea Auto-resize
            const textarea = document.getElementById('chat-textarea');
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
                document.getElementById('btn-send').disabled = this.value.trim() === "";
                
                // Toggle Quick Actions
                const qa = document.getElementById('quick-actions');
                if (this.value.trim().length > 0) qa.classList.add('hidden');
                else if (state.messages.length === 0) qa.classList.remove('hidden');
            });
            textarea.addEventListener('keydown', (e) => {
                if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
            });

            // Botones Header
            document.getElementById('btn-model-menu').addEventListener('click', (e) => { e.stopPropagation(); toggleState('isModelMenuOpen', 'model-menu'); });
            document.getElementById('btn-extras-menu').addEventListener('click', (e) => { e.stopPropagation(); toggleState('isExtrasOpen', 'extras-menu'); });

            // Botones Sidebar
            document.getElementById('btn-collapse').addEventListener('click', () => setSidebar(true));
            document.getElementById('btn-expand').addEventListener('click', () => setSidebar(false));

            // Botón Plus
            document.getElementById('btn-plus').addEventListener('click', (e) => { 
                e.stopPropagation(); 
                toggleState('isPlusMenuOpen', 'plus-menu'); 
                document.querySelector('#btn-plus svg').classList.toggle('rotate-45');
            });

            // Botón Send
            document.getElementById('btn-send').addEventListener('click', sendMessage);

            // Botones Historial
            document.getElementById('btn-history-close').addEventListener('click', () => toggleHistoryView(false));
            document.getElementById('btn-history-expand').addEventListener('click', toggleHistoryExpand);
        });

        // --- FUNCIONES DE RENDERIZADO ---

        function initIcons() { lucide.createIcons(); }

        function renderSidebar() {
            const container = document.getElementById('sidebar-options');
            container.innerHTML = sidebarItems.map(item => `
                <button onclick="handleSidebarAction('${item.action}')" class="sidebar-item w-full flex items-center px-3 py-2 rounded-[8px] gap-3 text-black hover:bg-gray-100 transition-all group mb-1">
                    <i data-lucide="${item.icon}" width="14" height="14" stroke-width="1.2" class="shrink-0 text-black"></i>
                    <span class="text-[13px] truncate text-black fade-in-fast sidebar-label">${item.label}</span>
                </button>
            `).join('');
            initIcons();
        }

        function renderExtras() {
            const createItem = (i) => `
                <button class="w-full flex items-start gap-3 p-3 rounded-xl hover:bg-gray-50 transition-colors group text-left">
                    <div class="mt-0.5 text-gray-400 group-hover:text-black transition-colors">
                        <i data-lucide="${i.icon}" width="16" stroke-width="1.5"></i>
                    </div>
                    <div>
                        <div class="text-sm font-semibold text-black leading-tight">${i.label}</div>
                        <div class="text-[11px] text-gray-400 font-medium mt-0.5">${i.desc}</div>
                    </div>
                </button>`;
            
            document.getElementById('extras-tools-list').innerHTML = extrasTools.map(createItem).join('');
            document.getElementById('extras-functions-list').innerHTML = extrasFuncs.map(createItem).join('');
            initIcons();
        }

        function renderQuickActions() {
            const container = document.getElementById('quick-actions');
            container.innerHTML = quickActionsData.map(a => `
                <button onclick="setInput('${a.text}')" class="group px-3 py-1.5 bg-gray-50 hover:bg-black hover:text-white rounded-lg transition-all cursor-pointer flex items-center gap-2 text-black font-medium text-xs border border-gray-100 hover:border-black">
                    <i data-lucide="${a.icon}" width="12" height="12"></i>
                    <span>${a.text}</span>
                </button>
            `).join('');
            initIcons();
        }

        function renderHistoryItems() {
            const list = document.getElementById('history-list-content');
            let html = '';
            for(let i=0; i<10; i++) {
                html += `
                <button class="w-full text-left p-3 hover:bg-gray-50 border border-transparent hover:border-gray-100 rounded-xl group transition-all duration-200">
                    <div class="flex justify-between items-start mb-1">
                        <span class="font-semibold text-sm text-black group-hover:text-blue-600 transition-colors truncate pr-2">Conversación ${i+1}</span>
                        <span class="text-[10px] text-gray-400 whitespace-nowrap">Hace ${i+1}h</span>
                    </div>
                    <p class="text-xs text-gray-500 truncate">Detalles sobre la arquitectura del proyecto...</p>
                </button>`;
            }
            list.innerHTML = html;
            initIcons();
        }

        // --- LOGICA UI ---

        function handleGlobalClick(e) {
            // Cerrar Model Menu
            if(state.isModelMenuOpen && !e.target.closest('#model-menu') && !e.target.closest('#btn-model-menu')) {
                toggleState('isModelMenuOpen', 'model-menu');
            }
            // Cerrar Extras
            if(state.isExtrasOpen && !e.target.closest('#extras-menu') && !e.target.closest('#btn-extras-menu')) {
                toggleState('isExtrasOpen', 'extras-menu');
            }
            // Cerrar Plus Menu
            if(state.isPlusMenuOpen && !e.target.closest('#plus-menu') && !e.target.closest('#btn-plus')) {
                toggleState('isPlusMenuOpen', 'plus-menu');
                document.querySelector('#btn-plus svg').classList.remove('rotate-45');
            }
        }

        function toggleState(key, domId) {
            state[key] = !state[key];
            const el = document.getElementById(domId);
            if(state[key]) {
                el.classList.remove('hidden');
            } else {
                el.classList.add('hidden');
            }
        }

        function setSidebar(collapsed) {
            state.isSidebarCollapsed = collapsed;
            const sidebar = document.getElementById('sidebar');
            const header = document.getElementById('sidebar-header');
            const collapsedHeader = document.getElementById('collapsed-header');
            const labels = document.querySelectorAll('.sidebar-label');
            const items = document.querySelectorAll('.sidebar-item');

            if (collapsed) {
                sidebar.classList.remove('w-[260px]');
                sidebar.classList.add('w-[70px]');
                header.classList.add('hidden');
                collapsedHeader.classList.remove('hidden');
                collapsedHeader.classList.add('flex');
                labels.forEach(l => l.classList.add('hidden'));
                items.forEach(i => { i.classList.add('justify-center'); i.classList.remove('px-3'); });
            } else {
                sidebar.classList.add('w-[260px]');
                sidebar.classList.remove('w-[70px]');
                header.classList.remove('hidden');
                collapsedHeader.classList.add('hidden');
                collapsedHeader.classList.remove('flex');
                labels.forEach(l => l.classList.remove('hidden'));
                items.forEach(i => { i.classList.remove('justify-center'); i.classList.add('px-3'); });
            }
        }

        function handleSidebarAction(action) {
            if (action === 'newChat') resetChat();
            if (action === 'toggleHistory') toggleHistoryView(true);
            if (action === 'search' || action === 'projects' || action === 'agents') {
                console.log("Acción: " + action);
            }
        }

        function toggleHistoryView(show) {
            state.isHistoryOpen = show;
            const view = document.getElementById('history-view');
            if (show) {
                view.classList.remove('hidden');
                view.classList.add('flex');
            } else {
                view.classList.add('hidden');
                view.classList.remove('flex');
                // Reset expand
                if(state.isHistoryExpanded) toggleHistoryExpand();
            }
        }

        function toggleHistoryExpand() {
            state.isHistoryExpanded = !state.isHistoryExpanded;
            const view = document.getElementById('history-view');
            const btnIcon = document.querySelector('#btn-history-expand svg');
            
            if (state.isHistoryExpanded) {
                view.className = "flex absolute inset-0 z-50 bg-white flex-col p-6 rounded-none animate-fade-in";
                // Update icon to minimize logic handled by re-rendering or attr change. 
                // Simple attr replacement:
                // Note: Lucide replaces SVG, so we target the parent button innerHTML
                document.getElementById('btn-history-expand').innerHTML = '<i data-lucide="minimize-2" width="18" height="18"></i>';
                document.getElementById('history-list-content').classList.remove('max-h-[400px]');
            } else {
                view.className = "flex absolute top-16 left-4 md:left-20 w-[400px] bg-white/95 backdrop-blur-xl border border-gray-200 shadow-2xl rounded-2xl flex-col p-4 z-40 transition-all duration-300 max-h-[600px]";
                document.getElementById('btn-history-expand').innerHTML = '<i data-lucide="maximize-2" width="18" height="18"></i>';
                document.getElementById('history-list-content').classList.add('max-h-[400px]');
            }
            initIcons();
        }

        function setInput(text) {
            const tx = document.getElementById('chat-textarea');
            tx.value = text;
            tx.focus();
            tx.dispatchEvent(new Event('input'));
        }

        function selectModel(name) {
            state.currentModel = name;
            document.getElementById('selected-model-name').innerText = name;
            // Update UI styling for active model
            document.querySelectorAll('#model-menu button').forEach(b => {
                b.classList.remove('bg-black', 'text-white');
                b.classList.add('text-black', 'hover:bg-gray-100');
            });
            // This assumes simple logic, in production match ID
            toggleState('isModelMenuOpen', 'model-menu');
            
            if (name.includes('GPT') || name.includes('Gemini')) {
                 document.getElementById('modal-overlay').classList.remove('hidden');
            }
        }

        function closeModal() {
            document.getElementById('modal-overlay').classList.add('hidden');
        }

        function resetChat() {
            state.messages = [];
            document.getElementById('messages-list').innerHTML = '';
            document.getElementById('welcome-screen').classList.remove('hidden');
            document.getElementById('quick-actions').classList.remove('hidden');
            document.getElementById('chat-textarea').value = '';
            document.getElementById('chat-textarea').style.height = 'auto';
        }

        // --- CHAT LOGIC ---

        async function sendMessage() {
            const tx = document.getElementById('chat-textarea');
            const text = tx.value.trim();
            if(!text) return;

            // UI Clean up
            tx.value = '';
            tx.style.height = 'auto';
            document.getElementById('btn-send').disabled = true;
            document.getElementById('welcome-screen').classList.add('hidden');
            document.getElementById('quick-actions').classList.add('hidden');

            addMessage('user', text);

            // Show loader
            const loader = document.getElementById('ai-loader');
            loader.classList.remove('hidden');
            loader.classList.add('flex');
            scrollToBottom();

            // Simulate AI
            await new Promise(r => setTimeout(r, 1500));

            loader.classList.add('hidden');
            loader.classList.remove('flex');

            const aiResponse = `¡Claro! Aquí tienes una respuesta simulada para: "**${text}**".\n\nEl sistema está funcionando con **HTML puro** y todas las funciones como *Extras*, *Historial* y *Barra Lateral* están operativas al 100%.\n\n\`\`\`javascript\nconsole.log("Todo correcto");\n\`\`\``;
            addMessage('ai', aiResponse);
        }

        function addMessage(role, content) {
            const list = document.getElementById('messages-list');
            const isUser = role === 'user';
            
            const msgDiv = document.createElement('div');
            msgDiv.className = `flex w-full ${isUser ? 'justify-end' : 'justify-start'} animate-fade-in`;
            
            // Icon Logic
            let iconHtml = '';
            if (isUser) {
                iconHtml = `<div class="w-10 h-10 rounded-full flex items-center justify-center shrink-0 overflow-hidden border border-gray-100 shadow-sm bg-gray-100 text-black"><i data-lucide="user" width="20"></i></div>`;
            } else {
                iconHtml = `<div class="w-10 h-10 rounded-full flex items-center justify-center shrink-0 overflow-hidden border border-gray-100 shadow-sm bg-white text-black"><span class="font-inter font-black text-black text-lg">R</span></div>`;
            }

            // Content Logic (Markdown)
            const parsedContent = isUser ? content : marked.parse(content);
            
            const bubbleHtml = `
                <div class="px-6 py-4 rounded-[1.5rem] text-base leading-relaxed tracking-wide shadow-sm ${isUser ? 'bg-gray-100 text-black rounded-tr-sm border border-gray-200' : 'bg-white text-black px-0 shadow-none border-transparent'}">
                    <div class="prose prose-sm max-w-none ${isUser ? '' : 'font-light'}">
                        ${parsedContent}
                    </div>
                </div>
            `;

            // Actions for AI
            const actionsHtml = !isUser ? `
                <div class="flex items-center gap-2 mt-2 opacity-0 group-hover:opacity-100 transition-opacity justify-start">
                    <button class="p-2 text-gray-400 hover:text-black rounded-lg transition-all"><i data-lucide="copy" width="14"></i></button>
                    <button class="p-2 text-gray-400 hover:text-black rounded-lg transition-all"><i data-lucide="refresh-cw" width="14"></i></button>
                    <button class="p-2 text-gray-400 hover:text-black rounded-lg transition-all"><i data-lucide="thumbs-up" width="14"></i></button>
                    <button class="p-2 text-gray-400 hover:text-black rounded-lg transition-all"><i data-lucide="thumbs-down" width="14"></i></button>
                </div>
            ` : '';

            msgDiv.innerHTML = `
                <div class="max-w-[90%] md:max-w-[85%] flex gap-4 ${isUser ? 'flex-row-reverse' : 'flex-row'} group">
                    ${iconHtml}
                    <div class="flex flex-col gap-1 ${isUser ? 'items-end' : 'items-start'} w-full">
                        ${bubbleHtml}
                        ${actionsHtml}
                    </div>
                </div>
            `;

            list.appendChild(msgDiv);
            initIcons();
            scrollToBottom();
            
            state.messages.push({ role, content });
        }

        function scrollToBottom() {
            const vp = document.getElementById('chat-viewport');
            vp.scrollTop = vp.scrollHeight;
        }

    </script>
</body>
</html>