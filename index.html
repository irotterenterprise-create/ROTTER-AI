<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="icon" type="image/png" href="favicon.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IRO AI</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Google Fonts: Inter & DM Sans -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=DM+Sans:opsz,wght@9..40,200;300;400;500;700&display=swap" rel="stylesheet">

    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        /* Tipografía y Base */
        body { font-family: 'Inter', sans-serif; background-color: #ffffff; color: #000000; transition: all 0.4s cubic-bezier(0.25, 1, 0.5, 1); }
        .font-dm-sans { font-family: 'DM Sans', sans-serif; }
        
        /* Scrollbars */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #cbd5e1; }

        .sidebar-scrollbar::-webkit-scrollbar { width: 4px; }
        .sidebar-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .sidebar-scrollbar::-webkit-scrollbar-thumb { background: transparent; border-radius: 10px; }
        .sidebar-scrollbar:hover::-webkit-scrollbar-thumb { background: #cbd5e1; }

        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Animaciones */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-slide-up { animation: slideUp 0.4s ease-out forwards; }

        @keyframes slideUpPanel { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .animate-slide-up-panel { animation: slideUpPanel 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

        @keyframes zoomIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .animate-zoom-in { animation: zoomIn 0.2s ease-out forwards; }

        /* Estilos específicos para la cápsula de herramienta */
        .tool-capsule {
            background-color: #e0e7ff; /* Indigo-100 (Moradito pastel/Azul) */
            border: 1px solid #c7d2fe; /* Indigo-200 */
            color: #4338ca; /* Indigo-700 (Azul marino pastel) */
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: all 0.2s ease;
        }
        .tool-capsule:hover {
            background-color: #dbeafe; /* Blue-100 */
        }

        /* --- LÓGICA DE LAYOUT CANVAS (CORE) --- */
        
        /* El panel del Canvas */
        #canvas-panel {
            position: fixed;
            top: 0;
            right: 0;
            height: 100%;
            width: 65%; /* Ocupa el 65% */
            background: white;
            border-left: 1px solid #e5e7eb;
            box-shadow: -5px 0 25px rgba(0,0,0,0.05);
            z-index: 40;
            transform: translateX(100%); /* Oculto por defecto */
            transition: transform 0.5s cubic-bezier(0.16, 1, 0.3, 1);
            display: flex;
            flex-direction: column;
        }

        /* Estado: Canvas Abierto */
        body.canvas-open #canvas-panel {
            transform: translateX(0);
        }

        /* Ajuste del Chat cuando Canvas está abierto */
        body.canvas-open #main-content-area {
            width: 35%; /* El chat se reduce al 35% */
            margin-right: 65%; /* Espacio para el canvas */
        }
        
        /* Ajuste de la barra inferior de input cuando Canvas está abierto */
        body.canvas-open #bottom-bar-container {
            width: 35%;
            left: 70px; /* Offset del sidebar colapsado */
            position: fixed;
            bottom: 0;
        }

        /* --- INTERACCIÓN CON SIDEBAR --- */
        /* Si la sidebar se abre (expandida) mientras canvas está abierto, empujamos el canvas un poco */
        body.sidebar-expanded.canvas-open #canvas-panel {
            transform: translateX(180px); /* Se oculta un poco hacia la derecha */
        }
    </style>
</head>
<body class="h-screen flex overflow-hidden selection:bg-black selection:text-white relative transition-all duration-300">

    <!-- INPUTS DE ARCHIVOS REALES (Ocultos) -->
    <input type="file" id="file-input-generic" class="hidden" multiple>
    <input type="file" id="file-input-image" class="hidden" accept="image/*" multiple>
    <input type="file" id="file-input-video" class="hidden" accept="video/*" multiple>
    <input type="file" id="file-input-gallery" class="hidden" accept="image/*,video/*" multiple>

    <!-- OVERLAYS -->
    <div id="mobile-overlay" class="hidden fixed inset-0 bg-black/20 backdrop-blur-sm z-30 md:hidden transition-opacity"></div>
    <div id="global-click-overlay" class="hidden fixed inset-0 bg-transparent z-[60]" onclick="closeAllMenusExcept(null)"></div>

    <!-- CANVAS PANEL (El Lienzo) -->
    <div id="canvas-panel">
        <!-- Header Canvas -->
        <div class="h-14 border-b border-gray-100 flex items-center justify-between px-4 bg-white/95 backdrop-blur-sm shrink-0">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-lg bg-indigo-50 flex items-center justify-center text-indigo-600">
                    <i data-lucide="layout" width="18"></i>
                </div>
                <div>
                    <h2 class="font-bold text-sm text-gray-800 font-dm-sans">IRO AI Canvas</h2>
                    <p class="text-[10px] text-gray-400 font-medium font-inter">Editor Inteligente</p>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <span id="canvas-status" class="text-[10px] text-gray-400 mr-2 transition-opacity opacity-0">Guardado</span>
                <button onclick="closeCanvas()" class="p-2 text-gray-400 hover:text-black hover:bg-gray-100 rounded-lg transition-colors" title="Cerrar Canvas"><i data-lucide="x" width="18"></i></button>
            </div>
        </div>

        <!-- Toolbar Canvas (Acciones Reales) -->
        <div class="px-4 py-2 bg-gray-50/50 border-b border-gray-100 flex items-center gap-2 overflow-x-auto hide-scrollbar shrink-0">
            <button onclick="canvasAction('grammar')" class="flex items-center gap-1.5 px-3 py-1.5 bg-white border border-gray-200 hover:border-indigo-300 hover:text-indigo-600 rounded-md text-xs font-medium text-gray-600 transition-all whitespace-nowrap shadow-sm"><i data-lucide="check-circle" width="12"></i> Mejorar Gramática</button>
            <button onclick="canvasAction('code')" class="flex items-center gap-1.5 px-3 py-1.5 bg-white border border-gray-200 hover:border-indigo-300 hover:text-indigo-600 rounded-md text-xs font-medium text-gray-600 transition-all whitespace-nowrap shadow-sm"><i data-lucide="code-2" width="12"></i> Revisar Código</button>
            <button onclick="insertEmoji()" class="flex items-center gap-1.5 px-3 py-1.5 bg-white border border-gray-200 hover:border-indigo-300 hover:text-indigo-600 rounded-md text-xs font-medium text-gray-600 transition-all whitespace-nowrap shadow-sm"><i data-lucide="smile" width="12"></i> Emoji</button>
            
            <div class="h-4 w-px bg-gray-300 mx-1"></div>
            
            <button onclick="canvasUndo()" id="btn-undo" class="flex items-center justify-center w-8 h-8 bg-white border border-gray-200 hover:bg-gray-50 rounded-md text-gray-600 disabled:opacity-50 disabled:cursor-not-allowed transition-all shadow-sm" title="Deshacer"><i data-lucide="undo" width="14"></i></button>
            <button onclick="canvasRedo()" id="btn-redo" class="flex items-center justify-center w-8 h-8 bg-white border border-gray-200 hover:bg-gray-50 rounded-md text-gray-600 disabled:opacity-50 disabled:cursor-not-allowed transition-all shadow-sm" title="Rehacer"><i data-lucide="redo" width="14"></i></button>
            
            <div class="flex-1"></div>
            <button onclick="copyCanvasContent()" class="flex items-center gap-1.5 px-3 py-1.5 bg-black text-white hover:bg-gray-800 rounded-md text-xs font-medium transition-colors shadow-md"><i data-lucide="copy" width="12"></i> Copiar</button>
        </div>

        <!-- Editor Area -->
        <div class="flex-1 overflow-hidden relative bg-gray-50 p-4 md:p-8 flex flex-col">
            <div class="w-full h-full max-w-4xl mx-auto bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden flex flex-col relative group">
                <!-- Textarea Real -->
                <textarea id="canvas-editor" class="flex-1 w-full h-full p-8 resize-none outline-none font-mono text-sm md:text-base text-gray-800 leading-relaxed custom-scrollbar bg-transparent z-10" placeholder="El contenido generado aparecerá aquí..." spellcheck="false"></textarea>
                
                <!-- Overlay de carga para el canvas -->
                <div id="canvas-loader" class="hidden absolute inset-0 bg-white/80 backdrop-blur-sm z-20 flex-col items-center justify-center">
                    <div class="w-8 h-8 border-2 border-indigo-600 border-t-transparent rounded-full animate-spin mb-3"></div>
                    <span class="text-xs font-medium text-indigo-600 animate-pulse">Procesando con IA...</span>
                </div>
            </div>
        </div>
    </div>


    <!-- MENÚS FLOTANTES -->
    
    <!-- Menú AGENTES -->
    <div id="agents-menu" class="hidden fixed w-48 bg-white border border-gray-200 rounded-xl shadow-2xl animate-zoom-in z-[100] p-1.5 overflow-hidden">
        <button onclick="selectAgent(1)" class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-50 text-[13px] font-medium text-black transition-colors">Agente 1</button>
        <button onclick="selectAgent(2)" class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-50 text-[13px] font-medium text-black transition-colors">Agente 2 MPR</button>
        <button onclick="selectAgent(3)" class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-50 text-[13px] font-medium text-black transition-colors">Agente 3</button>
        <div class="h-px bg-gray-100 my-1"></div>
        <button onclick="handleLockedAgent()" class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-50 text-[13px] font-medium text-gray-400 transition-colors flex justify-between items-center group">
            Agente 4 <i data-lucide="lock" width="12"></i>
        </button>
        <button onclick="handleLockedAgent()" class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-50 text-[13px] font-medium text-gray-400 transition-colors flex justify-between items-center group">
            Agente 5 <i data-lucide="lock" width="12"></i>
        </button>
    </div>

    <!-- Menú ADJUNTAR (Clip - Tools View) -->
    <div id="tools-attach-menu" class="hidden fixed w-60 bg-white border border-gray-200 rounded-xl shadow-2xl animate-zoom-in z-[100] p-1.5 overflow-hidden">
        <button onclick="triggerFileSelect('generic')" class="w-full text-left px-3 py-2.5 rounded-lg hover:bg-gray-50 flex items-center gap-3 text-[13px] font-medium text-black transition-colors mb-2">
            <div class="bg-gray-100 p-1.5 rounded-md"><i data-lucide="paperclip" width="14"></i></div> Adjuntar Fotos y Archivos
        </button>
        <div class="h-px bg-gray-100 my-1"></div>
        <div class="grid grid-cols-1 gap-0.5" id="tools-advanced-list"></div>
    </div>

    <!-- Menú ADJUNTAR (Chat Normal PC) -->
    <div id="plus-menu-desktop" class="hidden fixed w-56 bg-white border border-gray-200 rounded-2xl shadow-2xl animate-zoom-in z-[100] p-1.5">
        <button onclick="triggerFileSelect('generic')" class="w-full text-left px-3 py-2 rounded-xl hover:bg-gray-50 flex items-center gap-3 text-[13px] font-medium text-black transition-colors group">
            <div class="bg-gray-100 p-1.5 rounded-lg group-hover:bg-white border border-transparent group-hover:border-gray-200"><i data-lucide="paperclip" width="11"></i></div> Adjuntar Archivos y Fotos
        </button>
        <div class="h-px bg-gray-100 my-1.5"></div>
        <div class="grid grid-cols-1 gap-0.5" id="pc-tools-list"></div>
    </div>

    <!-- SIDEBAR -->
    <div id="sidebar" class="hidden md:flex flex-col h-full border-r border-gray-200 shrink-0 sidebar-transition relative z-40 bg-white w-[70px] absolute md:static shadow-2xl md:shadow-none font-dm-sans bg-white transition-all duration-300">
        
        <!-- Cabecera Sidebar (Expanded) -->
        <div id="sidebar-header" class="hidden flex items-center h-14 px-4 justify-between shrink-0 transition-all duration-300">
            <div id="logo-container" class="flex items-center gap-3 animate-fade-in">
                <img src="logo-negro.png" onerror="this.src='https://via.placeholder.com/24x24?text=L'" alt="Logo" class="w-6 h-6 object-contain">
                <span class="font-bold text-sm tracking-tight text-black">IRO AI</span>
            </div>
            <button id="btn-collapse" class="p-1.5 rounded-lg text-black hover:bg-gray-200 transition-colors"><i data-lucide="panel-left-close" width="16" height="16" stroke-width="1.2"></i></button>
        </div>
        
        <!-- Cabecera Sidebar Colapsada -->
        <div id="collapsed-header" class="flex h-14 w-full items-center justify-center">
            <button id="btn-expand" class="group relative w-9 h-9 flex items-center justify-center rounded-xl transition-all duration-300">
                <img src="logo-negro.png" onerror="this.style.display='none'; this.nextElementSibling.style.opacity='1';" alt="Logo" class="w-6 h-6 object-contain absolute opacity-100 group-hover:opacity-0 transition-opacity duration-200">
                <i data-lucide="panel-left-open" width="16" height="16" stroke-width="1.5" class="text-black opacity-0 group-hover:opacity-100 transition-opacity duration-200 absolute"></i>
            </button>
        </div>
        
        <!-- Opciones Principales -->
        <div class="flex flex-col gap-[3px] px-0 mt-2 flex-1 overflow-y-auto sidebar-scrollbar" id="sidebar-options">
            <!-- JS Generates this -->
        </div>
        
        <!-- Footer Group -->
        <div class="mt-auto">
            <div class="px-3 pb-2">
                <button id="btn-download-app" class="sidebar-item w-full flex items-center justify-center py-2 rounded-[8px] gap-[3px] text-black hover:bg-gray-100 transition-all group">
                    <span class="text-[11.5px] truncate text-black fade-in-fast sidebar-label font-medium flex-1 text-left hidden">Descargar IRO AI</span>
                    <div class="flex gap-2 text-gray-400 group-hover:text-black transition-colors fade-in-fast sidebar-label hidden">
                        <i data-lucide="monitor" width="12.5" height="12.5" stroke-width="1.5"></i>
                        <i data-lucide="smartphone" width="12.5" height="12.5" stroke-width="1.5"></i>
                    </div>
                </button>
            </div>
            
            <div class="p-3 pt-0 pb-1">
                <button class="sidebar-item w-full flex items-center justify-center py-2 rounded-[8px] gap-[3px] text-black hover:bg-gray-100 transition-all group">
                    <i data-lucide="settings" width="16" height="16" stroke-width="1.2" class="shrink-0 text-black"></i>
                    <span class="text-[13px] truncate text-black fade-in-fast sidebar-label font-medium hidden">Configuración</span>
                </button>
            </div>
            
            <!-- ID DE USUARIO (Visible cuando la barra está expandida) -->
            <div id="user-id-display" class="w-full text-center pb-3 hidden fade-in-fast sidebar-label">
                <span class="text-[7px] text-gray-400 font-mono tracking-wider">ID: 8F3K-9L2P</span>
            </div>
        </div>
    </div>

    <!-- ÁREA PRINCIPAL -->
    <div id="main-content-area" class="flex flex-col h-full flex-1 transition-all duration-500 ease-in-out bg-white relative w-full overflow-hidden">
        
        <!-- 1. VISTA STANDARD (Chat Normal) -->
        <div id="standard-view" class="flex flex-col h-full w-full">
            <!-- Header Standard -->
            <div class="h-14 shrink-0 flex items-center justify-between px-6 sticky top-0 bg-white/80 backdrop-blur-md z-30 font-dm-sans">
                <div class="flex items-center gap-3 w-full relative">
                    <button id="btn-mobile-sidebar" class="md:hidden p-2 mr-1 text-black hover:bg-gray-100 rounded-full transition-colors flex items-center justify-center border border-gray-200 shadow-sm active:scale-95"><i data-lucide="panel-left" width="18" height="18"></i></button>
                    
                    <!-- MENU "IRO AI" -->
                    <div class="relative">
                        <button id="btn-iro-menu" class="flex items-center gap-1.5 text-sm font-dm-sans font-[300] text-black hover:bg-gray-100 px-3 py-1.5 rounded-lg transition-colors group">
                            <span>IRO AI</span>
                            <i data-lucide="chevron-down" width="14" height="14" class="transition-transform duration-200 text-gray-400 group-hover:text-black" id="iro-menu-icon"></i>
                        </button>
                        
                        <div id="iro-menu-content" class="hidden absolute top-full left-0 mt-3 w-[280px] bg-white border border-gray-200 rounded-2xl shadow-2xl z-50 p-2 animate-zoom-in overflow-hidden">
                            <div class="flex flex-col gap-1">
                                <button class="w-full text-left px-3 py-2.5 rounded-xl hover:bg-gray-50 flex items-start gap-3 transition-colors group">
                                    <div class="mt-0.5 text-black shrink-0"><i data-lucide="rabbit" width="18"></i></div>
                                    <div class="flex-1">
                                        <div class="text-sm font-medium text-black leading-none mb-1">IRO AI</div>
                                        <div class="text-[11px] text-gray-500 font-medium leading-tight">Veloz y suficiente para todo</div>
                                    </div>
                                    <div class="text-gray-400 shrink-0 self-center"><i data-lucide="check" width="16"></i></div>
                                </button>
                                
                                <button class="w-full text-left px-3 py-2.5 rounded-xl hover:bg-gray-50 flex items-start gap-3 transition-colors group">
                                    <div class="mt-0.5 text-black shrink-0"><i data-lucide="orbit" width="18"></i></div>
                                    <div class="flex-1">
                                        <div class="text-sm font-medium text-black leading-none mb-1">IRO Pro</div>
                                        <div class="text-[11px] text-gray-500 font-medium leading-tight">Altamente Capaz y hecho para todo</div>
                                    </div>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- WRAPPER LADO DERECHO -->
                    <div class="ml-auto flex items-center gap-2">
                        
                        <!-- EXPLORAR MENU -->
                        <div class="relative">
                            <button id="btn-explore-menu" class="flex items-center gap-1.5 text-base font-medium text-black hover:bg-gray-100 px-3 py-1.5 rounded-lg transition-colors">Explorar <i data-lucide="chevron-down" width="14" height="14" class="text-gray-400"></i></button>
                            <div id="explore-menu" class="hidden absolute top-full right-0 mt-3 w-[280px] bg-white rounded-2xl shadow-2xl border border-gray-200 p-2 z-50 animate-zoom-in origin-top-right overflow-hidden font-dm-sans">
                                <div class="p-1">
                                    <h3 class="px-3 py-2 text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Información</h3>
                                    <a href="/sobre-nuestro-modelo" class="w-full flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-gray-100 transition-colors text-sm font-medium text-black group">
                                        <i data-lucide="bot" width="16" class="text-gray-400 group-hover:text-black transition-colors"></i>
                                        Sobre nuestro modelo
                                    </a>
                                </div>
                            </div>
                        </div>

                        <!-- EXTRAS MENU -->
                        <div class="relative">
                            <button id="btn-extras-menu" class="flex items-center gap-1.5 text-base font-medium text-black hover:bg-gray-100 px-3 py-1.5 rounded-lg transition-colors">Extras <i data-lucide="chevron-down" width="14" height="14" class="text-gray-400"></i></button>
                            <div id="extras-menu" class="hidden absolute top-full right-0 mt-3 w-[340px] bg-gray-100 rounded-2xl shadow-2xl border border-gray-200 p-2 z-50 animate-zoom-in origin-top-right overflow-hidden font-dm-sans">
                                <div class="max-h-[80vh] overflow-y-auto custom-scrollbar p-2">
                                    <div class="mb-4">
                                        <h3 class="px-3 py-2 text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Herramientas</h3>
                                        <div class="space-y-0.5 text-black" id="extras-tools-list"></div>
                                    </div>
                                    <div class="h-px bg-gray-200 mx-3 mb-4"></div>
                                    <div>
                                        <h3 class="px-3 py-2 text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Funciones del chat</h3>
                                        <div class="space-y-0.5 text-black" id="extras-functions-list"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Viewport Standard -->
            <div id="chat-viewport" class="flex-1 overflow-y-auto p-4 md:p-8 space-y-8 scroll-smooth custom-scrollbar relative flex flex-col items-center transition-all duration-500">
                <div id="welcome-screen" class="flex-1 flex flex-col items-center justify-center min-h-[50vh] transition-all duration-500 w-full">
                    <div class="text-center mb-8 animate-slide-up md:-translate-y-8"><h1 id="greeting-text" class="font-inter text-[24px] font-light tracking-tight text-black">Hola, creador.</h1></div>
                    <div id="center-content-spot" class="w-full max-w-3xl px-4 animate-slide-up flex flex-col items-center" style="animation-delay: 0.1s;"></div>
                </div>
                <div id="messages-list" class="flex flex-col gap-8 pb-4 w-full max-w-3xl hidden"></div>
                <div id="ai-loader" class="hidden w-full max-w-3xl pl-14 justify-start"><div class="flex gap-2 p-2"><span class="w-2.5 h-2.5 bg-black rounded-full animate-bounce" style="animation-delay: 0ms"></span><span class="w-2.5 h-2.5 bg-black rounded-full animate-bounce" style="animation-delay: 150ms"></span><span class="w-2.5 h-2.5 bg-black rounded-full animate-bounce" style="animation-delay: 300ms"></span></div></div>
            </div>
            
            <div id="bottom-bar-container" class="w-full shrink-0 pb-8 pt-4 px-4 bg-white z-20 hidden md:block transition-all duration-500"><div id="bottom-input-spot" class="max-w-3xl mx-auto relative z-20"></div></div>
        </div>

        <!-- 2. VISTA MAS HERRAMIENTAS -->
        <div id="tools-view" class="hidden flex-col h-full w-full bg-white relative overflow-hidden">
            <div class="h-14 w-full shrink-0"></div>
            <div class="flex-1 overflow-y-auto custom-scrollbar p-6 flex flex-col items-center">
                <div class="w-full max-w-2xl mb-4 animate-slide-up flex items-center justify-center gap-3">
                    <img src="logo-negro.png" onerror="this.src='https://via.placeholder.com/40x40?text=I'" alt="Logo IRO AI" class="w-10 h-10 object-contain shrink-0"> 
                    <h1 class="font-inter font-bold text-[25.6px] text-black tracking-tight">IRO AI</h1>
                </div>

                <div class="w-full max-w-2xl mb-10 animate-slide-up relative z-30">
                    <div class="bg-white border border-gray-300 rounded-2xl shadow-sm hover:shadow-md transition-all relative min-h-[140px] flex flex-col">
                        <textarea placeholder="Escribe tu idea o usa una herramienta..." class="w-full bg-transparent border-none outline-none text-black placeholder-gray-400 resize-none font-light font-inter text-lg leading-relaxed flex-1 p-4 pb-12 custom-scrollbar"></textarea>
                        <div class="absolute bottom-2 left-2 right-2 flex justify-between items-center">
                            <button id="btn-tools-attach" class="p-2 text-gray-400 hover:text-black hover:bg-gray-100 rounded-xl transition-colors">
                                <i data-lucide="paperclip" width="16" height="16"></i>
                            </button>
                            <div class="flex items-center gap-1">
                                <button id="btn-tools-agents" class="p-2 text-gray-500 hover:text-blue-600 hover:bg-blue-50 rounded-xl transition-colors">
                                    <i data-lucide="brain" width="16" height="16"></i>
                                </button>
                                <button class="p-2 bg-black text-white hover:bg-gray-900 rounded-xl transition-all shadow-md active:scale-95">
                                    <i data-lucide="arrow-up" width="16" height="16"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="w-full max-w-6xl grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 animate-slide-up" style="animation-delay: 0.1s;" id="cards-grid"></div>
                <div class="h-12 w-full shrink-0"></div>
            </div>
        </div>

        <!-- Componente Historial Mejorado -->
        <div id="history-view" class="hidden absolute inset-0 z-50 bg-white/95 backdrop-blur-md flex-col p-4 md:p-8 animate-fade-in transition-all">
             <div class="flex items-center justify-between mb-6 shrink-0 w-full max-w-4xl mx-auto">
                <h2 class="font-bold text-2xl text-black font-dm-sans">Tu Historial</h2>
                <button id="btn-history-close" class="p-2 hover:bg-gray-100 text-black rounded-full transition-colors"><i data-lucide="x" width="24" height="24"></i></button>
            </div>
            
            <div class="w-full max-w-4xl mx-auto relative mb-6 shrink-0">
                <i data-lucide="search" width="18" class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                <input type="text" id="history-search" placeholder="Buscar conversaciones antiguas..." class="w-full pl-12 pr-4 py-3 bg-gray-50 border border-gray-200 rounded-2xl text-base outline-none focus:border-black/20 focus:bg-white transition-all font-inter shadow-sm">
            </div>

            <div id="history-list-content" class="flex-1 w-full max-w-4xl mx-auto overflow-y-auto custom-scrollbar space-y-3 pb-8">
                <div class="text-center text-gray-400 mt-10">No tienes chats guardados aún.</div>
            </div>
        </div>

        <!-- INPUT STANDARD -->
        <div id="main-input-wrapper" class="w-full relative mb-[25px] md:mb-0 md:-translate-y-[27.5px] transition-all duration-300">
            <div id="plus-menu-mobile" class="hidden md:hidden fixed bottom-0 left-0 w-full bg-white rounded-t-[2rem] shadow-[0_-10px_40px_rgba(0,0,0,0.1)] z-[70] animate-slide-up-panel flex flex-col max-h-[70vh]">
                <div class="w-10 h-1 bg-gray-200 rounded-full mx-auto mt-3 mb-4"></div>
                <div class="px-5 pb-6 overflow-y-auto custom-scrollbar">
                    <div class="flex gap-4 mb-5">
                        <div class="flex gap-2 shrink-0">
                            <button onclick="triggerFileSelect('generic')" class="flex flex-col items-center gap-1.5 group p-1"><div class="w-12 h-12 bg-blue-50 border border-blue-100 rounded-xl flex items-center justify-center text-blue-600 group-active:scale-95 transition-transform"><i data-lucide="folder" width="20"></i></div><span class="text-[10px] font-medium text-gray-600">Archivos</span></button>
                            <button onclick="triggerFileSelect('image')" class="flex flex-col items-center gap-1.5 group p-1"><div class="w-12 h-12 bg-purple-50 border border-purple-100 rounded-xl flex items-center justify-center text-purple-600 group-active:scale-95 transition-transform"><i data-lucide="image" width="20"></i></div><span class="text-[10px] font-medium text-gray-600">Fotos</span></button>
                            <button onclick="triggerFileSelect('video')" class="flex flex-col items-center gap-1.5 group p-1"><div class="w-12 h-12 bg-pink-50 border border-pink-100 rounded-xl flex items-center justify-center text-pink-600 group-active:scale-95 transition-transform"><i data-lucide="clapperboard" width="20"></i></div><span class="text-[10px] font-medium text-gray-600">Video</span></button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CAPSULA DE HERRAMIENTA ACTIVA (Canvas) -->
            <div id="active-tool-capsule" class="hidden absolute -top-12 left-4 md:left-12 z-20 animate-slide-up">
                <div class="tool-capsule flex items-center gap-2 px-3 py-1.5 rounded-full shadow-sm">
                    <div class="text-[#4338ca]"><i data-lucide="layout" width="14"></i></div>
                    <span class="text-xs font-semibold">Canvas</span>
                    <button onclick="removeActiveTool()" class="ml-1 p-0.5 hover:bg-white/50 rounded-full transition-colors"><i data-lucide="x" width="12"></i></button>
                </div>
            </div>

            <div class="flex items-end md:items-center gap-2 relative">
                <button id="btn-plus" class="p-2.5 md:p-3 text-black md:text-gray-400 hover:text-black bg-gray-100 md:bg-transparent rounded-full hover:bg-gray-200 md:hover:bg-gray-100 transition-all shrink-0 md:absolute md:left-[24px] md:top-1/2 md:-translate-y-1/2 md:z-10 shadow-sm md:shadow-none">
                    <i data-lucide="paperclip" width="20" height="20" class="md:w-5 md:h-5 transition-transform duration-200"></i>
                </button>
                
                <div id="input-container" class="flex-1 bg-gray-50 md:bg-white border border-gray-300 rounded-[2rem] md:rounded-[2rem] shadow-sm hover:shadow-md transition-all focus-within:shadow-lg focus-within:border-gray-400 p-1.5 pl-4 md:p-4 md:pl-16 relative flex items-center">
                    <textarea id="chat-textarea" rows="1" placeholder="Comienza a charlar..." class="w-full bg-transparent border-none outline-none text-black placeholder-gray-400 resize-none font-light font-inter transition-all duration-300 custom-scrollbar text-lg leading-relaxed max-h-[150px] py-1" style="min-height: 24px;"></textarea>
                    
                    <div class="relative flex items-center mr-1">
                        <button id="btn-model-menu" class="flex items-center gap-2 text-xs font-semibold text-gray-500 hover:text-black hover:bg-gray-100 px-2 py-1.5 rounded-lg transition-colors whitespace-nowrap">
                            <span id="selected-model-name">IRO v.9</span>
                            <i data-lucide="chevron-up" width="16" height="16" id="model-menu-icon" stroke-width="1.8"></i>
                        </button>
                        <div id="model-menu" class="hidden absolute bottom-full right-0 mb-2 w-56 bg-white border border-gray-200 rounded-xl shadow-xl z-50 p-1 animate-zoom-in">
                            <button onclick="selectModel('IRO v.9')" class="w-full text-left px-3 py-2 rounded-lg text-sm flex items-center gap-2 hover:bg-gray-100 transition-colors bg-black text-white">IRO v.9</button>
                            <button onclick="selectModel('GPT-5.2')" class="w-full text-left px-3 py-2 rounded-lg text-sm flex items-center justify-between hover:bg-gray-100 transition-colors group text-black">GPT-5.2 <i data-lucide="lock" width="12" class="text-gray-400 group-hover:text-black"></i></button>
                            <button onclick="selectModel('Gemini 3')" class="w-full text-left px-3 py-2 rounded-lg text-sm flex items-center justify-between hover:bg-gray-100 transition-colors group text-black"><span class="flex items-center gap-2">Gemini 3 <span class="bg-blue-600 text-white text-[10px] px-1.5 py-0.5 rounded-full font-bold">NUEVO</span></span> <i data-lucide="lock" width="12" class="text-gray-400 group-hover:text-black"></i></button>
                        </div>
                    </div>

                    <button onclick="toggleReadAloud()" id="btn-read-aloud" class="p-2 mr-1 rounded-full transition-all bg-gray-200 text-gray-400 cursor-not-allowed" disabled>
                        <i data-lucide="audio-lines" width="20" height="20" class="md:w-5 md:h-5"></i>
                    </button>

                    <button id="btn-send" onclick="handleSendClick()" disabled class="p-2 ml-1 rounded-full bg-black text-white hover:bg-gray-900 disabled:bg-gray-200 disabled:text-gray-400 transition-all shadow-md active:scale-95 shrink-0 flex items-center justify-center">
                        <i id="send-icon" data-lucide="arrow-up" width="18" height="18" class="md:w-5 md:h-5"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div id="quick-actions" class="hidden md:flex flex-wrap justify-center gap-2 mt-6 opacity-0 animate-fade-in transform -translate-y-[4.5px]" style="animation-delay: 0.2s; opacity: 1;"></div>
    </div>

    <!-- PREVIEW MODAL -->
    <div id="preview-modal" class="hidden fixed inset-0 z-[80] bg-black/90 backdrop-blur-md flex flex-col items-center justify-center p-4 animate-zoom-in">
        <button onclick="closePreview()" class="absolute top-4 right-4 p-2 text-white/50 hover:text-white transition-colors bg-white/10 rounded-full"><i data-lucide="x" width="24"></i></button>
        <div class="relative max-w-2xl w-full max-h-[70vh] rounded-2xl overflow-hidden shadow-2xl bg-black"><img id="preview-image" src="" class="w-full h-full object-contain hidden"><div id="preview-file-icon" class="hidden flex-col items-center justify-center p-20 text-white"><i data-lucide="file-text" width="64" height="64"></i><p id="preview-filename" class="mt-4 text-lg font-medium">documento.pdf</p></div></div>
        <div class="mt-8 flex gap-4 w-full max-w-xs"><button onclick="closePreview()" class="flex-1 py-3 rounded-xl bg-white/10 text-white font-medium hover:bg-white/20 transition-colors">Cancelar</button><button onclick="confirmSendFile()" class="flex-1 py-3 rounded-xl bg-blue-600 text-white font-bold hover:bg-blue-500 shadow-lg transition-colors">Enviar</button></div>
    </div>

    <script>
        // --- GESTIÓN DE ESTADO Y STORAGE ---
        const state = {
            isSidebarCollapsed: true, 
            isModelMenuOpen: false, 
            isExtrasOpen: false, 
            isExploreOpen: false,
            isPlusMenuOpen: false, 
            isHistoryOpen: false, 
            messages: [], 
            currentModel: 'IRO v.9', 
            pendingFile: null,
            currentView: 'standard', 
            isAgentsMenuOpen: false, 
            isToolsAttachOpen: false,
            isIroMenuOpen: false,
            isReadAloud: false, 
            isGenerating: false,
            currentChatId: null, 
            chatHistory: [],
            pendingAction: null, // 'canvas' u otro
            isCanvasOpen: false, // Estado visual del panel canvas
            
            // Estado interno del Canvas (Historial real)
            canvasHistory: [],
            canvasHistoryIndex: -1
        };

        let abortController = null;

        // Init Storage
        function initStorage() {
            const savedHistory = localStorage.getItem('iro_chat_history');
            if (savedHistory) {
                state.chatHistory = JSON.parse(savedHistory);
            }
            // Crear ID inicial si no hay
            startNewSession();
        }

        function startNewSession() {
            state.currentChatId = Date.now().toString(); 
            state.messages = [];
            state.pendingAction = null; 
            state.isCanvasOpen = false;
            closeCanvas(true);
        }

        function saveCurrentChat() {
            if (state.messages.length === 0) return;
            const existingIndex = state.chatHistory.findIndex(c => c.id === state.currentChatId);
            let title = "Nuevo Chat";
            if (state.messages.length > 0) {
                const firstMsg = state.messages.find(m => m.role === 'user');
                if (firstMsg) {
                    title = firstMsg.content.replace(/\[.*?\]/g, '').trim().substring(0, 30) || "Imagen/Archivo";
                }
            }
            const chatData = {
                id: state.currentChatId,
                title: existingIndex !== -1 ? state.chatHistory[existingIndex].title : title,
                date: new Date().toLocaleDateString(),
                preview: state.messages[state.messages.length - 1].content.substring(0, 50) + "...",
                messages: state.messages
            };
            if (existingIndex !== -1) {
                state.chatHistory[existingIndex] = chatData;
            } else {
                state.chatHistory.unshift(chatData); 
            }
            localStorage.setItem('iro_chat_history', JSON.stringify(state.chatHistory));
            renderHistoryList();
        }

        function loadChat(id) {
            const chat = state.chatHistory.find(c => c.id === id);
            if (chat) {
                state.currentChatId = chat.id;
                state.messages = chat.messages || [];
                document.getElementById('messages-list').innerHTML = '';
                state.messages.forEach(msg => addMessage(msg.role === 'user' ? 'user' : 'ai', msg.content, false));
                updateLayout();
                toggleHistoryView(false);
            }
        }

        function deleteChat(id, e) {
            e.stopPropagation();
            if(confirm("¿Seguro que quieres borrar este chat?")) {
                state.chatHistory = state.chatHistory.filter(c => c.id !== id);
                localStorage.setItem('iro_chat_history', JSON.stringify(state.chatHistory));
                renderHistoryList();
                if(state.currentChatId === id) resetChat(); 
            }
        }

        function shareChat(id, e) {
            e.stopPropagation();
            const chat = state.chatHistory.find(c => c.id === id);
            const dummyLink = `https://iro.ai/share/${id}`;
            alert(`Link generado y copiado al portapapeles:\n${dummyLink}\n\n(Cualquiera con este link podrá ver el chat "${chat.title}")`);
        }
        
        function renameChat(id, e) {
            e.stopPropagation();
            const newName = prompt("Nuevo nombre para el chat:");
            if (newName && newName.trim() !== "") {
                const chat = state.chatHistory.find(c => c.id === id);
                if (chat) {
                    chat.title = newName;
                    localStorage.setItem('iro_chat_history', JSON.stringify(state.chatHistory));
                    renderHistoryList();
                }
            }
        }

        function renderHistoryList() {
            const container = document.getElementById('history-list-content');
            if (state.chatHistory.length === 0) {
                container.innerHTML = '<div class="flex flex-col items-center justify-center py-20 opacity-50"><i data-lucide="message-square-dashed" width="48" class="mb-4 text-gray-300"></i><p class="text-gray-400">No hay historial aún.</p></div>';
                initIcons();
                return;
            }
            const term = document.getElementById('history-search').value.toLowerCase();
            const filtered = state.chatHistory.filter(c => c.title.toLowerCase().includes(term));
            container.innerHTML = filtered.map(chat => `
                <div onclick="loadChat('${chat.id}')" class="w-full bg-white border border-gray-100 p-4 rounded-xl hover:shadow-md hover:border-gray-200 transition-all cursor-pointer group flex items-center justify-between animate-fade-in relative overflow-hidden">
                    <div class="flex items-center gap-4 overflow-hidden">
                        <div class="w-10 h-10 rounded-full bg-gray-50 flex items-center justify-center shrink-0 text-gray-500 group-hover:bg-black group-hover:text-white transition-colors">
                            <i data-lucide="message-square" width="18"></i>
                        </div>
                        <div class="min-w-0">
                            <h3 class="font-bold text-sm text-gray-800 truncate pr-2 group-hover:text-black transition-colors" title="${chat.title}">${chat.title}</h3>
                            <p class="text-xs text-gray-400 truncate">${chat.date} · ${chat.preview}</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity absolute right-4 bg-white/80 backdrop-blur-sm pl-2">
                        <button onclick="shareChat('${chat.id}', event)" class="p-2 hover:bg-blue-50 text-gray-400 hover:text-blue-600 rounded-lg transition-colors" title="Compartir Link"><i data-lucide="share-2" width="14"></i></button>
                        <button onclick="renameChat('${chat.id}', event)" class="p-2 hover:bg-gray-100 text-gray-400 hover:text-black rounded-lg transition-colors" title="Renombrar"><i data-lucide="edit-2" width="14"></i></button>
                        <button onclick="deleteChat('${chat.id}', event)" class="p-2 hover:bg-red-50 text-gray-400 hover:text-red-600 rounded-lg transition-colors" title="Borrar"><i data-lucide="trash-2" width="14"></i></button>
                    </div>
                </div>
            `).join('');
            initIcons();
        }

        const sidebarItems = [
            { icon: 'plus', label: 'Nuevo Chat', action: 'newChat' },
            { icon: 'search', label: 'Buscar Chats', action: 'search' },
            { icon: 'archive', label: 'Proyectos', action: 'projects' },
            { icon: 'brain', label: 'Agentes', action: 'agents' },
            { icon: 'layout-grid', label: 'Más herramientas', action: 'moreTools' }, 
            { icon: 'history', label: 'Historial', action: 'toggleHistory' }
        ];

        const toolList = [
            { id: 'canvas', icon: 'layout', label: "Canvas" }, 
            { icon: 'image', label: "Crea imagen" }, { icon: 'align-left', label: "Resumen" }, { icon: 'code-2', label: "Código" }, { icon: 'search', label: "Investigar" }, { icon: 'link', label: "Analizar URL" }
        ];
        
        const advancedTools = [
            { id: 'canvas', icon: 'layout', label: "Canvas" },
            { icon: 'align-left', label: "Resumen" }, { icon: 'file-search', label: "Analisis Extenso" }, { icon: 'quote', label: "Citas" }, { icon: 'search', label: "Investigación Fragmentada" }, { icon: 'list-ordered', label: "Paso a Paso" }, { icon: 'code-2', label: "Codigo" }
        ];

        const cardsData = [
            { title: "Crear sitio web", desc: "Crea sitios web enteros usando IA con un solo prompt.", img: "https://images.unsplash.com/photo-1547658719-da2b51169166?w=600&h=300&fit=crop" },
            { title: "Investigación y Analisis", desc: "Profundiza en cualquier tema con datos actualizados.", img: "https://images.unsplash.com/photo-1454165804606-c3d57bc86b40?w=600&h=300&fit=crop" },
            { title: "Convertir Word a PDF", desc: "Transforma tus documentos en segundos.", img: "https://images.unsplash.com/photo-1568029132208-0a2412bda8b7?w=600&h=300&fit=crop" },
            { title: "Idea para video", desc: "Guiones creativos para YouTube o TikTok.", img: "https://images.unsplash.com/photo-1492691527719-9d1e07e534b4?w=600&h=300&fit=crop" },
            { title: "Crear Tienda Online", desc: "Estructura tu e-commerce desde cero.", img: "https://images.unsplash.com/photo-1556742049-0cfed4f7a07d?w=600&h=300&fit=crop" },
            { title: "Investiga un Tema", desc: "Obtén fuentes y resúmenes fiables.", img: "https://images.unsplash.com/photo-1434030216411-0b793f4b4173?w=600&h=300&fit=crop" },
            { title: "Genera citas", desc: "Formato APA, MLA y más al instante.", img: "https://images.unsplash.com/photo-1455390582262-044cdead277a?w=600&h=300&fit=crop" },
            { title: "Aprender idioma", desc: "Practica conversación y gramática.", img: "https://images.unsplash.com/photo-1543269865-cbf427effbad?w=600&h=300&fit=crop" }
        ];

        document.addEventListener('DOMContentLoaded', () => {
            initStorage(); 
            marked.use({ breaks: true });
            initIcons();
            renderSidebar(); 
            setSidebar(true); 

            renderExtras();
            renderQuickActions();
            renderTools();
            renderCards();
            renderAdvancedTools();
            updateLayout(); 
            
            document.getElementById('greeting-text').innerText = ["Hola, creador.", "¿Qué inventamos hoy?", "Sistema listo."][Math.floor(Math.random()*3)];
            
            document.addEventListener('click', handleGlobalClick);
            const textarea = document.getElementById('chat-textarea');
            textarea.addEventListener('input', function() {
                this.style.height = 'auto'; this.style.height = (this.scrollHeight) + 'px';
                updateInputUI(this.value.trim()); 
            });
            textarea.addEventListener('keydown', (e) => { 
                if(e.key === 'Enter' && !e.shiftKey) { 
                    e.preventDefault(); 
                    if(!document.getElementById('btn-send').disabled) handleSendClick(); 
                } 
            });
            
            document.getElementById('history-search').addEventListener('input', renderHistoryList);

            ['generic','image','video','gallery'].forEach(id => document.getElementById('file-input-'+id).addEventListener('change', id === 'file-input-gallery' ? handleGalleryLoad : handleFileSelect));

            // Setup real canvas editor listeners
            const canvasEditor = document.getElementById('canvas-editor');
            canvasEditor.addEventListener('input', (e) => {
                // Debounce simple para guardar historial
                clearTimeout(canvasEditor.saveTimeout);
                canvasEditor.saveTimeout = setTimeout(() => {
                    saveCanvasHistory(e.target.value);
                }, 1000);
            });

            setupButtons();
            window.addEventListener('resize', () => { if(state.isPlusMenuOpen && window.innerWidth >= 768) updatePCMenuPosition(); if(state.messages.length === 0 && state.currentView === 'standard') updateLayout(); });
        });

        function updateInputUI(text) {
            const sendBtn = document.getElementById('btn-send');
            const readBtn = document.getElementById('btn-read-aloud');
            const qa = document.getElementById('quick-actions');

            if (state.isGenerating) {
                sendBtn.disabled = false;
            } else {
                sendBtn.disabled = text === "";
            }

            if (text.length > 0) {
                readBtn.disabled = false;
                readBtn.classList.remove('bg-gray-200', 'text-gray-400', 'cursor-not-allowed');
                if (state.isReadAloud) {
                    readBtn.classList.add('bg-blue-600', 'text-white');
                    readBtn.classList.remove('bg-black');
                } else {
                    readBtn.classList.add('bg-black', 'text-white');
                    readBtn.classList.remove('bg-blue-600');
                }
            } else {
                readBtn.disabled = true;
                readBtn.classList.add('bg-gray-200', 'text-gray-400', 'cursor-not-allowed');
                readBtn.classList.remove('bg-black', 'bg-blue-600', 'text-white');
            }

            if(text.length > 0) qa.classList.add('hidden'); else if(state.messages.length === 0) qa.classList.remove('hidden');
        }

        function toggleReadAloud() {
            state.isReadAloud = !state.isReadAloud;
            const readBtn = document.getElementById('btn-read-aloud');
            if (state.isReadAloud) {
                readBtn.classList.remove('bg-black');
                readBtn.classList.add('bg-blue-600');
            } else {
                readBtn.classList.remove('bg-blue-600');
                readBtn.classList.add('bg-black');
            }
        }

        function setupButtons() {
            document.getElementById('btn-model-menu').addEventListener('click', (e) => { 
                e.stopPropagation(); 
                if(!state.isModelMenuOpen) closeAllMenusExcept('model-menu'); 
                toggleState('isModelMenuOpen', 'model-menu'); 
            });

            document.getElementById('btn-iro-menu').addEventListener('click', (e) => { 
                e.stopPropagation(); 
                if(!state.isIroMenuOpen) closeAllMenusExcept('iro-menu'); 
                toggleState('isIroMenuOpen', 'iro-menu-content'); 
                const icon = document.getElementById('iro-menu-icon');
                if(state.isIroMenuOpen) icon.classList.add('rotate-180'); else icon.classList.remove('rotate-180');
            });

            document.getElementById('btn-explore-menu').addEventListener('click', (e) => {
                e.stopPropagation();
                if(!state.isExploreOpen) closeAllMenusExcept('explore-menu');
                toggleState('isExploreOpen', 'explore-menu');
            });

            document.getElementById('btn-extras-menu').addEventListener('click', (e) => { e.stopPropagation(); if(!state.isExtrasOpen) closeAllMenusExcept('extras-menu'); toggleState('isExtrasOpen', 'extras-menu'); });
            
            document.getElementById('btn-collapse').addEventListener('click', () => { 
                if(window.innerWidth < 768) { closeMobileSidebar(); } else { setSidebar(true); }
            });
            document.getElementById('btn-expand').addEventListener('click', () => { 
                if(window.innerWidth < 768) { openMobileSidebar(); setSidebar(false); } else { setSidebar(false); } 
            });
            document.getElementById('btn-mobile-sidebar').addEventListener('click', openMobileSidebar);
            document.getElementById('mobile-overlay').addEventListener('click', closeMobileSidebar);
            
            document.getElementById('btn-plus').addEventListener('click', (e) => { 
                e.stopPropagation();
                if(state.isPlusMenuOpen) { closeAllMenusExcept(null); return; }
                if(window.innerWidth < 768) { closeAllMenusExcept('plus-menu'); document.getElementById('plus-menu-mobile').classList.remove('hidden'); document.getElementById('mobile-overlay').classList.remove('hidden'); state.isPlusMenuOpen = true; }
                else { closeAllMenusExcept('plus-menu'); document.getElementById('plus-menu-desktop').classList.remove('hidden'); state.isPlusMenuOpen = true; updatePCMenuPosition(); }
            });
            
            document.getElementById('btn-history-close').addEventListener('click', () => toggleHistoryView(false));
            
            document.getElementById('btn-tools-agents').addEventListener('click', (e) => {
                e.stopPropagation(); closeAllMenusExcept('agents-menu');
                const menu = document.getElementById('agents-menu'); const btn = document.getElementById('btn-tools-agents'); const rect = btn.getBoundingClientRect();
                menu.style.left = (rect.left - 150) + 'px'; menu.style.top = (rect.bottom + 10) + 'px';
                toggleState('isAgentsMenuOpen', 'agents-menu');
            });

            document.getElementById('btn-tools-attach').addEventListener('click', (e) => {
                e.stopPropagation(); closeAllMenusExcept('tools-attach-menu');
                const menu = document.getElementById('tools-attach-menu'); const btn = document.getElementById('btn-tools-attach'); const rect = btn.getBoundingClientRect();
                menu.style.left = rect.left + 'px'; menu.style.top = (rect.bottom + 10) + 'px';
                toggleState('isToolsAttachOpen', 'tools-attach-menu');
            });
        }

        // --- MANEJO DE HERRAMIENTAS Y CANVAS ---
        function selectTool(id, label) {
            closeAllMenusExcept(null); 
            
            if (id === 'canvas') {
                state.pendingAction = 'canvas';
                const tx = document.getElementById('chat-textarea');
                tx.placeholder = "Modo Canvas: ¿Qué creamos hoy?";
                tx.focus();
                
                // Mostrar Cápsula Visual
                document.getElementById('active-tool-capsule').classList.remove('hidden');
                
                // Feedback visual botón
                const sendIcon = document.getElementById('send-icon');
                sendIcon.setAttribute('data-lucide', 'arrow-right'); 
                initIcons();
            } else {
                console.log("Herramienta seleccionada:", label);
            }
        }

        function removeActiveTool() {
            state.pendingAction = null;
            document.getElementById('active-tool-capsule').classList.add('hidden');
            const tx = document.getElementById('chat-textarea');
            tx.placeholder = "Comienza a charlar...";
            const sendIcon = document.getElementById('send-icon');
            sendIcon.setAttribute('data-lucide', 'arrow-up');
            initIcons();
        }

        // --- FUNCIONALIDAD REAL DEL CANVAS ---

        function openCanvas(content) {
            state.isCanvasOpen = true;
            const textarea = document.getElementById('canvas-editor');
            
            // Si hay contenido nuevo, lo seteamos y reseteamos el historial
            if (content) {
                textarea.value = content;
                state.canvasHistory = [content];
                state.canvasHistoryIndex = 0;
            } else if (!textarea.value) {
                 textarea.value = "Escribe algo aquí...";
                 state.canvasHistory = ["Escribe algo aquí..."];
                 state.canvasHistoryIndex = 0;
            }
            
            updateUndoRedoButtons();

            // Lógica de UI (No simulada, cambia clases reales)
            document.body.classList.add('canvas-open');
            
            // Cerrar sidebar automáticamente (Real)
            setSidebar(true); 
        }

        function closeCanvas() {
            state.isCanvasOpen = false;
            document.body.classList.remove('canvas-open');
        }

        // Historial Real (Undo/Redo)
        function saveCanvasHistory(val) {
            // Eliminar futuro si estamos en el medio
            if (state.canvasHistoryIndex < state.canvasHistory.length - 1) {
                state.canvasHistory = state.canvasHistory.slice(0, state.canvasHistoryIndex + 1);
            }
            state.canvasHistory.push(val);
            state.canvasHistoryIndex++;
            updateUndoRedoButtons();
            
            // Animación de guardado
            const status = document.getElementById('canvas-status');
            status.style.opacity = '1';
            setTimeout(() => status.style.opacity = '0', 2000);
        }

        function canvasUndo() {
            if (state.canvasHistoryIndex > 0) {
                state.canvasHistoryIndex--;
                document.getElementById('canvas-editor').value = state.canvasHistory[state.canvasHistoryIndex];
                updateUndoRedoButtons();
            }
        }

        function canvasRedo() {
            if (state.canvasHistoryIndex < state.canvasHistory.length - 1) {
                state.canvasHistoryIndex++;
                document.getElementById('canvas-editor').value = state.canvasHistory[state.canvasHistoryIndex];
                updateUndoRedoButtons();
            }
        }

        function updateUndoRedoButtons() {
            document.getElementById('btn-undo').disabled = state.canvasHistoryIndex <= 0;
            document.getElementById('btn-redo').disabled = state.canvasHistoryIndex >= state.canvasHistory.length - 1;
        }

        // Acciones Reales del Toolbar (Usando la IA)
        async function canvasAction(type) {
            const editor = document.getElementById('canvas-editor');
            const currentText = editor.value;
            if (!currentText.trim()) return;

            // Mostrar loader en canvas (No simulado, es un elemento DOM)
            document.getElementById('canvas-loader').classList.remove('hidden');
            document.getElementById('canvas-loader').classList.add('flex');

            let prompt = "";
            if (type === 'grammar') prompt = "Corrige la gramática y mejora el estilo del siguiente texto, devuelve SOLAMENTE el texto corregido, nada mas:\n\n" + currentText;
            if (type === 'code') prompt = "Revisa el siguiente código, corrige errores y mejora la legibilidad. Devuelve SOLAMENTE el código corregido:\n\n" + currentText;

            try {
                const response = await fetch('https://text.pollinations.ai/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        messages: [{ role: 'user', content: prompt }],
                        model: 'openai',
                        jsonMode: false
                    })
                });
                
                if (response.ok) {
                    const newText = await response.text();
                    editor.value = newText;
                    saveCanvasHistory(newText); // Guardar en historial real
                }
            } catch (e) {
                console.error("Error en acción canvas", e);
                alert("Error al procesar la solicitud.");
            } finally {
                document.getElementById('canvas-loader').classList.add('hidden');
                document.getElementById('canvas-loader').classList.remove('flex');
            }
        }

        function insertEmoji() {
            const editor = document.getElementById('canvas-editor');
            const emojis = ['💡', '✨', '🚀', '📝', '✅', '🤖', '🔥', '💻'];
            const randomEmoji = emojis[Math.floor(Math.random() * emojis.length)];
            
            // Insertar en la posición del cursor (Real)
            const start = editor.selectionStart;
            const end = editor.selectionEnd;
            const text = editor.value;
            const before = text.substring(0, start);
            const after  = text.substring(end, text.length);
            
            editor.value = before + randomEmoji + after;
            editor.selectionStart = editor.selectionEnd = start + randomEmoji.length;
            editor.focus();
            saveCanvasHistory(editor.value);
        }

        function copyCanvasContent() {
            const editor = document.getElementById('canvas-editor');
            editor.select();
            document.execCommand('copy');
            // Feedback visual
            const btn = event.currentTarget;
            const originalHTML = btn.innerHTML;
            btn.innerHTML = `<i data-lucide="check" width="12"></i> Copiado`;
            setTimeout(() => { btn.innerHTML = originalHTML; initIcons(); }, 1500);
        }

        // --- CHAT LOGIC ---

        function handleSendClick() {
            if (state.isGenerating) {
                if (abortController) abortController.abort();
                window.speechSynthesis.cancel();
                state.isGenerating = false;
                
                const sendIcon = document.getElementById('send-icon');
                sendIcon.setAttribute('data-lucide', 'arrow-up');
                sendIcon.removeAttribute('fill');
                const l = document.getElementById('ai-loader');
                l.classList.add('hidden'); l.classList.remove('flex');
                initIcons();
            } else {
                sendMessage();
            }
        }

        async function sendMessage(textOverride = null) {
            const tx = document.getElementById('chat-textarea');
            const t = textOverride || tx.value.trim();
            if(!t) return;

            window.speechSynthesis.cancel();
            state.isGenerating = true;
            abortController = new AbortController();

            tx.value = ''; tx.style.height = 'auto';
            const sendBtn = document.getElementById('btn-send');
            const sendIcon = document.getElementById('send-icon');
            
            sendIcon.setAttribute('data-lucide', 'square');
            sendIcon.setAttribute('fill', 'currentColor'); 
            initIcons();
            
            updateInputUI(''); 
            sendBtn.disabled = false; 

            const userMsg = {role:'user',content:t};
            state.messages.push(userMsg);
            
            if(state.messages.length === 1) updateLayout();
            
            addMessage('user', t, true); 
            saveCurrentChat();

            const isCanvasTrigger = state.pendingAction === 'canvas';
            
            // Loader visible
            const l = document.getElementById('ai-loader');
            l.classList.remove('hidden'); l.classList.add('flex');
            scrollToBottom();

            try {
                // Si es modo Canvas, pedimos algo más estructurado
                const systemPrompt = isCanvasTrigger 
                    ? 'Eres IRO AI. El usuario ha activado el modo CANVAS. Genera contenido extenso, detallado y bien estructurado (artículo, código, ensayo) ideal para un editor de texto.' 
                    : 'Eres IRO AI, un asistente inteligente y útil.';

                const response = await fetch('https://text.pollinations.ai/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    signal: abortController.signal,
                    body: JSON.stringify({
                        messages: [ { role: 'system', content: systemPrompt }, ...state.messages.map(msg => ({ role: msg.role === 'ai' ? 'assistant' : msg.role, content: msg.content })) ],
                        model: 'openai', jsonMode: false
                    })
                });
                if (!response.ok) throw new Error('Network response was not ok');
                const textData = await response.text();
                
                l.classList.add('hidden'); l.classList.remove('flex');
                
                addMessage('ai', textData, true);
                state.messages.push({role: 'ai', content: textData});
                saveCurrentChat();

                // AUTOMATIZACIÓN REAL CANVAS
                if (isCanvasTrigger) {
                    openCanvas(textData); // Abre el panel REALMENTE
                    removeActiveTool();   // Quita la cápsula
                }

                if(state.isReadAloud) {
                    const u = new SpeechSynthesisUtterance(textData); u.lang = 'es-ES';
                    window.speechSynthesis.speak(u);
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.log('Fetch aborted');
                } else {
                    console.error("Error calling AI:", error);
                    addMessage('ai', "Lo siento, hubo un error al conectar con el servidor de IA.", true);
                }
                l.classList.add('hidden'); l.classList.remove('flex');
            } finally {
                state.isGenerating = false;
                sendIcon.setAttribute('data-lucide', 'arrow-up');
                sendIcon.removeAttribute('fill');
                initIcons();
                updateInputUI(document.getElementById('chat-textarea').value.trim());
            }
        }

        // --- FUNCIONES CORE ---
        function handleSidebarAction(action) {
            if (action === 'newChat') { 
                state.currentView = 'standard'; 
                if(state.messages.length > 0) saveCurrentChat();
                resetChat(); 
                switchView('standard'); 
                closeCanvas(); // Asegurar cierre
            }
            if (action === 'toggleHistory') toggleHistoryView(true);
            if (action === 'moreTools') { state.currentView = 'tools'; switchView('tools'); }
            if(window.innerWidth < 768) closeMobileSidebar();
        }

        function switchView(viewName) {
            const standard = document.getElementById('standard-view');
            const tools = document.getElementById('tools-view');
            if (viewName === 'standard') { standard.classList.remove('hidden'); tools.classList.add('hidden'); } 
            else { standard.classList.add('hidden'); tools.classList.remove('hidden'); tools.classList.add('flex'); }
        }

        function selectAgent(id) { console.log("Agent selected:", id); closeAllMenusExcept(null); }
        function handleLockedAgent() { closeAllMenusExcept(null); if (state.isSidebarCollapsed) setSidebar(false); if (window.innerWidth < 768) openMobileSidebar(); const btn = document.getElementById('btn-download-app'); btn.classList.add('bg-gray-200', 'ring-2', 'ring-gray-300'); setTimeout(() => { btn.classList.remove('bg-gray-200', 'ring-2', 'ring-gray-300'); }, 1000); }

        function renderCards() {
            const container = document.getElementById('cards-grid');
            container.innerHTML = cardsData.map(c => `
                <div class="bg-white border border-gray-200 rounded-xl overflow-hidden hover:shadow-md transition-shadow cursor-pointer group">
                    <div class="h-24 bg-gray-100 overflow-hidden"><img src="${c.img}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500"></div>
                    <div class="p-3"><h3 class="font-bold text-sm text-black mb-1">${c.title}</h3><p class="text-xs text-gray-500 leading-relaxed">${c.desc}</p></div>
                </div>
            `).join('');
        }

        function renderAdvancedTools() {
            const container = document.getElementById('tools-advanced-list');
            container.innerHTML = advancedTools.map(t => `<button onclick="selectTool('${t.id || ''}', '${t.label}')" class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-50 flex items-center gap-3 text-[12px] font-medium text-black transition-colors group"><div class="text-gray-400 group-hover:text-black"><i data-lucide="${t.icon}" width="14"></i></div> ${t.label}</button>`).join('');
            initIcons();
        }

        function updatePCMenuPosition() {
            const btn = document.getElementById('btn-plus'); const menu = document.getElementById('plus-menu-desktop');
            if(!btn || !menu) return; const rect = btn.getBoundingClientRect();
            menu.style.left = rect.left + 'px'; menu.style.bottom = (window.innerHeight - rect.top + 10) + 'px';
        }

        function closeAllMenusExcept(exceptId) {
            if(exceptId !== 'model-menu' && state.isModelMenuOpen) toggleState('isModelMenuOpen', 'model-menu');
            if(exceptId !== 'iro-menu' && state.isIroMenuOpen) {
                 toggleState('isIroMenuOpen', 'iro-menu-content');
                 document.getElementById('iro-menu-icon')?.classList.remove('rotate-180');
            }
            if(exceptId !== 'extras-menu' && state.isExtrasOpen) toggleState('isExtrasOpen', 'extras-menu');
            if(exceptId !== 'explore-menu' && state.isExploreOpen) toggleState('isExploreOpen', 'explore-menu');
            if(exceptId !== 'plus-menu' && state.isPlusMenuOpen) {
                if(window.innerWidth < 768) { closePlusMenuMobile(); } else { document.getElementById('plus-menu-desktop').classList.add('hidden'); }
                state.isPlusMenuOpen = false;
            }
            if(exceptId !== 'agents-menu' && state.isAgentsMenuOpen) toggleState('isAgentsMenuOpen', 'agents-menu');
            if(exceptId !== 'tools-attach-menu' && state.isToolsAttachOpen) toggleState('isToolsAttachOpen', 'tools-attach-menu');
            
            if(exceptId === null) { document.getElementById('global-click-overlay').classList.add('hidden'); document.getElementById('mobile-overlay').classList.add('hidden'); }
        }

        function handleGlobalClick(e) {
            if (state.isModelMenuOpen && !e.target.closest('#model-menu') && !e.target.closest('#btn-model-menu')) toggleState('isModelMenuOpen', 'model-menu');
            if (state.isIroMenuOpen && !e.target.closest('#iro-menu-content') && !e.target.closest('#btn-iro-menu')) {
                 toggleState('isIroMenuOpen', 'iro-menu-content');
                 document.getElementById('iro-menu-icon')?.classList.remove('rotate-180');
            }
            if (state.isExtrasOpen && !e.target.closest('#extras-menu') && !e.target.closest('#btn-extras-menu')) toggleState('isExtrasOpen', 'extras-menu');
            if (state.isExploreOpen && !e.target.closest('#explore-menu') && !e.target.closest('#btn-explore-menu')) toggleState('isExploreOpen', 'explore-menu');
            
            if (state.isPlusMenuOpen && window.innerWidth >= 768 && !e.target.closest('#plus-menu-desktop') && !e.target.closest('#btn-plus')) closeAllMenusExcept(null);
            if (state.isAgentsMenuOpen && !e.target.closest('#agents-menu') && !e.target.closest('#btn-tools-agents')) toggleState('isAgentsMenuOpen', 'agents-menu');
            if (state.isToolsAttachOpen && !e.target.closest('#tools-attach-menu') && !e.target.closest('#btn-tools-attach')) toggleState('isToolsAttachOpen', 'tools-attach-menu');
        }

        function initIcons() { lucide.createIcons(); }
        function toggleState(key, domId) { state[key] = !state[key]; const el = document.getElementById(domId); state[key] ? el.classList.remove('hidden') : el.classList.add('hidden'); }
        function openMobileSidebar() { 
            const s = document.getElementById('sidebar'); 
            const o = document.getElementById('mobile-overlay'); 
            s.classList.remove('hidden'); 
            requestAnimationFrame(() => s.classList.add('flex')); 
            o.classList.remove('hidden'); 
            if(state.isSidebarCollapsed) setSidebar(false);
        }
        function closeMobileSidebar() { const s = document.getElementById('sidebar'); const o = document.getElementById('mobile-overlay'); s.classList.add('hidden'); s.classList.remove('flex'); o.classList.add('hidden'); }
        
        function setSidebar(c) { 
            state.isSidebarCollapsed = c; 
            const s = document.getElementById('sidebar'), h = document.getElementById('sidebar-header'), ch = document.getElementById('collapsed-header'), ls = document.querySelectorAll('.sidebar-label'), is = document.querySelectorAll('.sidebar-item'), uid = document.getElementById('user-id-display');
            const body = document.body;
            
            if(c) { 
                s.classList.remove('w-[255px]'); s.classList.add('w-[70px]'); 
                h.classList.add('hidden'); ch.classList.remove('hidden'); ch.classList.add('flex'); 
                ls.forEach(l => l.classList.add('hidden')); 
                is.forEach(i => { i.classList.add('justify-center'); i.classList.remove('px-3'); }); 
                uid.classList.add('hidden');
                body.classList.remove('sidebar-expanded');
            } else { 
                s.classList.add('w-[255px]'); s.classList.remove('w-[70px]'); 
                h.classList.remove('hidden'); ch.classList.add('hidden'); ch.classList.remove('flex'); 
                ls.forEach(l => l.classList.remove('hidden')); 
                is.forEach(i => { i.classList.remove('justify-center'); i.classList.add('px-3'); }); 
                uid.classList.remove('hidden');
                body.classList.add('sidebar-expanded');
            } 
        }

        // --- HISTORIAL FULL SCREEN LOGIC ---
        function toggleHistoryView(show) { 
            state.isHistoryOpen = show; 
            const v = document.getElementById('history-view'); 
            if(show) {
                renderHistoryList();
                v.classList.remove('hidden'); 
                v.classList.add('flex');
            } else {
                v.classList.add('hidden'); 
                v.classList.remove('flex');
            }
        }
        
        function setInput(t) { const tx = document.getElementById('chat-textarea'); tx.value = t; tx.focus(); tx.dispatchEvent(new Event('input')); }
        function selectModel(n) { state.currentModel = n; document.getElementById('selected-model-name').innerText = n; toggleState('isModelMenuOpen', 'model-menu'); }
        function closeModal() { document.getElementById('modal-overlay').classList.add('hidden'); }
        
        // RESET REAL (LIMPIA DOM y STATE)
        function resetChat() { 
            startNewSession(); // Genera nuevo ID
            document.getElementById('messages-list').innerHTML = ''; // Limpia DOM
            document.getElementById('chat-textarea').value = ''; 
            document.getElementById('chat-textarea').style.height = 'auto'; 
            updateLayout(); 
        }

        function copyText(t) { const ta = document.createElement('textarea'); ta.value = t; ta.style.position = 'fixed'; ta.style.left = '-9999px'; document.body.appendChild(ta); ta.select(); try { document.execCommand('copy'); } catch(e){} document.body.removeChild(ta); }
        function regenerateResponse() { const l = document.getElementById('ai-loader'); l.classList.remove('hidden'); l.classList.add('flex'); scrollToBottom(); setTimeout(() => { l.classList.add('hidden'); l.classList.remove('flex'); addMessage('ai', "Respuesta regenerada.", true); }, 1000); }
        function toggleFeedback(b, t) { if(b.classList.contains('text-black')) { b.classList.remove('text-black','bg-gray-100'); b.classList.add('text-gray-400'); } else { b.classList.remove('text-gray-400'); b.classList.add('text-black','bg-gray-100'); } }
        
        function speakText(btn) {
            const msgWrapper = btn.closest('.group').querySelector('.prose');
            if(msgWrapper) {
                const text = msgWrapper.innerText; const u = new SpeechSynthesisUtterance(text); u.lang = 'es-ES'; window.speechSynthesis.cancel(); window.speechSynthesis.speak(u);
            }
        }

        function addMessage(r, c, animate = true) { 
            const l = document.getElementById('messages-list'); const u = r === 'user'; const d = document.createElement('div'); 
            d.className = `flex w-full ${u ? 'justify-end' : 'justify-start'} ${animate ? 'animate-fade-in' : ''}`; 
            let i = u ? `<div class="w-10 h-10 rounded-full flex items-center justify-center shrink-0 overflow-hidden border border-gray-100 shadow-sm bg-gray-100 text-black"><i data-lucide="user" width="20"></i></div>` : `<div class="w-10 h-10 rounded-full flex items-center justify-center shrink-0 overflow-hidden border border-gray-100 shadow-sm bg-white text-black"><img src="logo-negro.png" onerror="this.src='https://via.placeholder.com/28x28?text=I'" class="w-7 h-7 object-contain"></div>`; 
            const pc = u ? c : marked.parse(c); const wc = u ? 'max-w-[50%]' : 'w-fit max-w-[45ch] md:max-w-[68ch]'; 
            const b = `<div class="px-6 py-4 rounded-[1.5rem] text-base leading-relaxed tracking-wide shadow-sm ${u ? 'bg-gray-100 text-black rounded-tr-sm border border-gray-200' : 'bg-white text-black px-0 shadow-none border-transparent'} overflow-hidden ${wc}"><div class="prose prose-sm max-w-none break-words whitespace-pre-wrap ${u ? '' : 'font-light'}">${pc}</div></div>`; 
            const ec = c.replace(/`/g, '\\`').replace(/"/g, '&quot;'); 
            const a = !u ? `<div class="flex items-center gap-2 mt-2 justify-start pl-1"><button onclick="speakText(this)" class="p-2 text-gray-400 hover:text-black rounded-lg transition-all hover:bg-gray-100"><i data-lucide="volume-2" width="14"></i></button><button onclick="copyText(\`${ec}\`)" class="p-2 text-gray-400 hover:text-black rounded-lg transition-all hover:bg-gray-100"><i data-lucide="copy" width="14"></i></button><button onclick="regenerateResponse()" class="p-2 text-gray-400 hover:text-black rounded-lg transition-all hover:bg-gray-100"><i data-lucide="refresh-cw" width="14"></i></button><div class="h-4 w-px bg-gray-200 mx-1"></div><button onclick="toggleFeedback(this, 'like')" class="p-2 text-gray-400 hover:text-black rounded-lg transition-all hover:bg-gray-100"><i data-lucide="thumbs-up" width="14"></i></button><button onclick="toggleFeedback(this, 'dislike')" class="p-2 text-gray-400 hover:text-black rounded-lg transition-all hover:bg-gray-100"><i data-lucide="thumbs-down" width="14"></i></button></div>` : ''; 
            d.innerHTML = `<div class="flex gap-4 ${u ? 'flex-row-reverse' : 'flex-row'} group w-full">${i}<div class="flex flex-col gap-1 ${u ? 'items-end' : 'items-start'} w-full">${b}${a}</div></div>`; l.appendChild(d); initIcons(); scrollToBottom(); 
        }
        function scrollToBottom() { const v = document.getElementById('chat-viewport'); v.scrollTop = v.scrollHeight; }
        
        function renderSidebar() {
            const container = document.getElementById('sidebar-options');
            const isC = state.isSidebarCollapsed;
            container.innerHTML = sidebarItems.map(item => `
                <button onclick="handleSidebarAction('${item.action}')" class="sidebar-item w-full flex items-center ${isC ? 'justify-center' : 'px-3'} py-1.5 rounded-[8px] gap-3 text-black hover:bg-gray-100 transition-all group mb-1 ${item.action === 'moreTools' ? 'bg-white' : ''} font-dm-sans">
                    <i data-lucide="${item.icon}" width="14.5" height="14.5" stroke-width="1.2" class="shrink-0 text-black"></i>
                    <span class="text-[14.7px] truncate text-black fade-in-fast sidebar-label ${isC ? 'hidden' : ''}">${item.label}</span>
                </button>
            `).join('');
            initIcons();
        }
        function renderExtras() { 
            const et = [{ icon: 'file-text', label: "Crear documentos", desc: "Word, PDF, textos largos" }, { icon: 'align-left', label: "Resumir contenido", desc: "Sintetizar información clave" }]; 
            const ef = [{ icon: 'message-square', label: "Contexto extendido", desc: "Para charlas largas" }, { icon: 'archive', label: "Memoria de chat", desc: "Recordar datos previos" }]; 
            const ci = (i) => `<button class="w-full flex items-start gap-3 p-3 rounded-xl hover:bg-gray-200/50 transition-colors group text-left"><div class="mt-0.5 text-gray-500 group-hover:text-black transition-colors"><i data-lucide="${i.icon}" width="16" stroke-width="1.5"></i></div><div><div class="text-sm font-semibold text-black leading-tight">${i.label}</div><div class="text-[11px] text-gray-500 font-medium mt-0.5">${i.desc}</div></div></button>`; 
            document.getElementById('extras-tools-list').innerHTML = et.map(ci).join(''); document.getElementById('extras-functions-list').innerHTML = ef.map(ci).join(''); 
        }
        function renderQuickActions() { const q = [{ text: "Imagen creativa", icon: "image" }, { text: "Resumir esto", icon: "align-left" }, { text: "Código Python", icon: "terminal" }, { text: "Plan de viaje", icon: "plane" }]; document.getElementById('quick-actions').innerHTML = q.map(a => `<button onclick="setInput('${a.text}')" class="group px-4 py-2 md:px-5 md:py-3 md:text-sm bg-white hover:bg-gray-50 text-black rounded-full transition-all cursor-pointer flex items-center gap-2 text-xs font-medium border border-gray-200 shadow-sm hover:shadow-md"><i data-lucide="${a.icon}" width="14" height="14" class="text-gray-500 group-hover:text-black"></i><span>${a.text}</span></button>`).join(''); initIcons(); }
        
        function renderTools() { const pl = document.getElementById('pc-tools-list'); pl.innerHTML = toolList.map(t => `<button onclick="selectTool('${t.id || ''}', '${t.label}')" class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-50 flex items-center gap-3 text-[13px] text-black transition-colors group"><div class="text-gray-400 group-hover:text-black"><i data-lucide="${t.icon}" width="11"></i></div> ${t.label}</button>`).join(''); }
        
        function updateLayout() { 
            const iw = document.getElementById('main-input-wrapper'); 
            const qa = document.getElementById('quick-actions'); 
            const cs = document.getElementById('center-content-spot'); 
            const bs = document.getElementById('bottom-input-spot'); 
            const bb = document.getElementById('bottom-bar-container'); 
            const w = document.getElementById('welcome-screen'); 
            const ml = document.getElementById('messages-list'); 
            
            if(state.messages.length === 0) { 
                w.classList.remove('hidden'); 
                if(window.innerWidth < 768) { cs.innerHTML = ''; bb.appendChild(iw); qa.classList.add('hidden'); bb.classList.remove('hidden'); } 
                else { bb.classList.add('hidden'); iw.classList.remove('mt-5'); cs.appendChild(iw); qa.classList.remove('mt-6'); qa.classList.add('mt-6'); cs.appendChild(qa); qa.classList.remove('hidden'); } 
            } else { 
                bb.classList.remove('hidden'); 
                bs.appendChild(iw); 
                iw.classList.remove('mt-5'); 
                w.classList.add('hidden'); 
                ml.classList.remove('hidden'); 
                qa.classList.add('hidden'); 
            } 
        }
        function triggerFileSelect(t) { closePlusMenuMobile(); document.getElementById('plus-menu-desktop').classList.add('hidden'); state.isPlusMenuOpen = false; if(state.isToolsAttachOpen) toggleState('isToolsAttachOpen', 'tools-attach-menu'); let id = 'file-input-generic'; if(t==='image')id='file-input-image'; if(t==='video')id='file-input-video'; document.getElementById(id).click(); }
        function handleFileSelect(e) { const f = e.target.files[0]; if(!f) return; state.pendingFile = f; showPreview(f); e.target.value = ''; }
        function handleGalleryLoad(e) { const fs = Array.from(e.target.files); }
        function showPreview(f) { const m = document.getElementById('preview-modal'); const i = document.getElementById('preview-image'); const c = document.getElementById('preview-file-icon'); const n = document.getElementById('preview-filename'); m.classList.remove('hidden'); m.classList.add('flex'); if(f.type.startsWith('image/')) { const r = new FileReader(); r.onload = (e) => { i.src = e.target.result; i.classList.remove('hidden'); c.classList.add('hidden'); }; r.readAsDataURL(f); } else { i.classList.add('hidden'); c.classList.remove('hidden'); c.classList.add('flex'); n.innerText = f.name; } }
        function closePreview() { document.getElementById('preview-modal').classList.add('hidden'); document.getElementById('preview-modal').classList.remove('flex'); state.pendingFile = null; }
        
        function confirmSendFile() { 
            const m = document.getElementById('preview-modal'); 
            m.classList.add('hidden'); 
            m.classList.remove('flex'); 
            const fm = state.pendingFile ? `[Archivo Adjunto: ${state.pendingFile.name}]` : "[Imagen Enviada]"; 
            
            state.messages.push({role:'user',content:fm}); 
            if(state.messages.length === 1) updateLayout(); 
            
            addMessage('user', fm); 
            setTimeout(() => { 
                const l = document.getElementById('ai-loader'); l.classList.remove('hidden'); l.classList.add('flex'); scrollToBottom(); 
                setTimeout(() => { l.classList.add('hidden'); l.classList.remove('flex'); addMessage('ai', "He recibido tu archivo correctamente."); }, 1500); 
            }, 500); 
            state.pendingFile = null; 
        }
        
        function closePlusMenuMobile() { document.getElementById('plus-menu-mobile').classList.add('hidden'); document.getElementById('mobile-overlay').classList.add('hidden'); state.isPlusMenuOpen = false; }
    </script>
</body>
</html>