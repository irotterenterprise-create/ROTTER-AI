<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="icon" type="image/png" href="favicon.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IRO AI</title>
<meta name="description" content="IRO AI - Resuelve tus preguntas, obtén análisis y respuestas precisas. Disfruta de un espacio de trabajo completo con IA de manera totalmente gratuita.">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Google Fonts: Inter, DM Sans & Open Sans -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=DM+Sans:opsz,wght@9..40,200;300;400;500;700&family=Open+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        /* Tipografía y Base - CAMBIO GLOBAL A OPEN SANS */
        body { font-family: 'Open Sans', sans-serif; background-color: #ffffff; color: #000000; transition: all 0.4s cubic-bezier(0.25, 1, 0.5, 1); }
        /* Redefinimos las clases para forzar Open Sans manteniendo compatibilidad de clases */
        .font-dm-sans { font-family: 'Open Sans', sans-serif; }
        .font-open-sans { font-family: 'Open Sans', sans-serif; }
        .font-inter { font-family: 'Open Sans', sans-serif; }
        
        /* Scrollbars */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #cbd5e1; }

        .sidebar-scrollbar::-webkit-scrollbar { width: 4px; }
        .sidebar-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .sidebar-scrollbar::-webkit-scrollbar-thumb { background: transparent; border-radius: 10px; }
        .sidebar-scrollbar:hover::-webkit-scrollbar-thumb { background: #cbd5e1; }

        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* --- SELECCIÓN DE TEXTO PASTEL --- */
        ::selection {
            background-color: #bfdbfe; /* Azul pastel */
            color: inherit;
        }

        /* Animaciones */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-slide-up { animation: slideUp 0.4s ease-out forwards; }

        @keyframes slideUpPanel { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .animate-slide-up-panel { animation: slideUpPanel 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

        @keyframes zoomIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .animate-zoom-in { animation: zoomIn 0.2s ease-out forwards; }

        /* --- ANIMACIÓN MÁGICA --- */
        @keyframes magicFlash {
            0% { background-color: rgba(59, 130, 246, 0.0); }
            10% { background-color: rgba(59, 130, 246, 0.3); } /* Flash Azul */
            100% { background-color: transparent; }
        }
        .magic-effect {
            animation: magicFlash 1.5s ease-out forwards;
            border-radius: 4px;
        }

        /* Estilos específicos para la cápsula de herramienta (Indicador de modo) */
        .tool-capsule {
            background-color: #e0e7ff; /* Indigo-100 */
            border: 1px solid #c7d2fe; /* Indigo-200 */
            color: #4338ca; /* Indigo-700 */
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: all 0.2s ease;
        }
        .tool-capsule:hover {
            background-color: #dbeafe; /* Blue-100 */
        }

        /* --- LÓGICA DE LAYOUT CANVAS (CORE) --- */
        #canvas-panel {
            position: fixed;
            top: 0;
            right: 0;
            height: 100%;
            width: 65%; /* Ocupa el 65% */
            background: white;
            border-left: 1px solid #e5e7eb;
            box-shadow: -5px 0 25px rgba(0,0,0,0.05);
            z-index: 40;
            transform: translateX(100%); /* Oculto por defecto */
            transition: transform 0.5s cubic-bezier(0.16, 1, 0.3, 1);
            display: flex;
            flex-direction: column;
        }

        /* Estado: Canvas Abierto */
        body.canvas-open #canvas-panel {
            transform: translateX(0);
        }

        /* Ajuste del Chat cuando Canvas está abierto */
        body.canvas-open #main-content-area {
            width: 35%; /* El chat se reduce al 35% */
            margin-right: 65%; /* Espacio para el canvas */
        }
        
        /* Ajuste de la barra inferior de input cuando Canvas está abierto */
        body.canvas-open #bottom-bar-container {
            width: 35%;
            left: 70px; /* Offset del sidebar colapsado */
            position: fixed;
            bottom: 0;
        }

        /* --- INTERACCIÓN CON SIDEBAR --- */
        body.sidebar-expanded.canvas-open #canvas-panel {
            transform: translateX(180px); /* Se oculta un poco hacia la derecha */
        }

        /* --- ESTILOS RICH TEXT EDITOR (CANVAS) --- */
        #canvas-editor {
            font-family: 'Open Sans', sans-serif;
            font-size: 19px; /* Contenido Base: 19px Regular */
            font-weight: 400;
            color: #1f2937;
            line-height: 1.6;
            outline: none;
            overflow-y: auto;
            white-space: pre-wrap; /* Mantener saltos de línea */
        }
        
        #canvas-editor h1 {
            font-family: 'Open Sans', sans-serif;
            font-weight: 700; /* Bold */
            font-size: 30px;
            margin-bottom: 0.5em;
            margin-top: 0.2em;
            color: #000;
        }

        #canvas-editor h2, #canvas-editor h3 {
            font-family: 'Open Sans', sans-serif;
            font-weight: 600; /* Semibold */
            font-size: 21px;
            margin-top: 1em;
            margin-bottom: 0.4em;
            color: #000;
        }

        #canvas-editor strong, #canvas-editor b {
            font-weight: 700;
            color: #000;
        }
        
        #canvas-editor p {
            margin-bottom: 0.8em;
        }

        /* --- BARRA FLOTANTE DE EDICIÓN (SELECCIÓN) --- */
        #floating-edit-bar {
            position: absolute;
            z-index: 100;
            background: white;
            padding: 4px;
            border-radius: 999px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 4px;
            border: 1px solid #f3f4f6;
            transform: translateY(10px);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease, transform 0.2s ease;
        }
        #floating-edit-bar.visible {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        /* --- CÁPSULA FLOTANTE UNIFICADA (NUEVO DISEÑO) --- */
        #unified-capsule {
            position: fixed;
            bottom: 30px;
            right: 40px;
            z-index: 9999; /* Siempre arriba */
            display: flex;
            align-items: center;
            background-color: white;
            padding: 5px;
            border-radius: 999px; /* Forma de píldora */
            box-shadow: 0 4px 20px rgba(0,0,0,0.12);
            border: 1px solid #f3f4f6;
            gap: 2px;
            opacity: 0;
            pointer-events: none;
            transform: translateY(20px);
            transition: opacity 0.3s ease, transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        /* Visible solo cuando el canvas está abierto */
        body.canvas-open #unified-capsule {
            opacity: 1;
            pointer-events: auto;
            transform: translateY(0);
        }

        .capsule-icon-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #4b5563;
            transition: all 0.2s ease;
            cursor: pointer;
            position: relative;
        }

        .capsule-icon-btn:hover {
            background-color: #f3f4f6;
            color: #000;
        }

        .capsule-icon-btn.active {
            background-color: #000;
            color: white;
        }

        /* Separador vertical */
        .capsule-divider {
            width: 1px;
            height: 18px;
            background-color: #e5e7eb;
            margin: 0 4px;
        }

        /* Grip de arrastre */
        .capsule-grip-handle {
            cursor: grab;
            color: #9ca3af;
        }
        .capsule-grip-handle:active {
            cursor: grabbing;
            color: #000;
        }

        /* Tooltip personalizado */
        .u-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-bottom: 8px;
            background-color: rgba(0,0,0,0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }
        .capsule-icon-btn:hover .u-tooltip {
            opacity: 1;
        }

        /* Picker de Emojis */
        #emoji-picker-popover {
            position: fixed; /* Fixed para evitar problemas de scroll */
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            padding: 12px;
            width: 280px;
            display: none;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            z-index: 10000;
        }
        #emoji-picker-popover.show {
            display: grid;
            animation: zoomIn 0.2s ease-out;
        }
        .emoji-btn {
            font-size: 20px;
            padding: 6px;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: background 0.2s;
        }
        .emoji-btn:hover {
            background-color: #f3f4f6;
        }

        /* --- NUEVOS ESTILOS AGREGADOS (IRO V.9 & UI) --- */
        
        /* Separadores negros para el chat (Markdown HR) */
        .prose hr {
            border-color: #000000 !important;
            border-top-width: 1.5px !important;
            margin-top: 1.5em !important;
            margin-bottom: 1.5em !important;
            opacity: 0.15;
        }

        /* Animación Cursor Negro (Typing) */
        @keyframes blink-cursor {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }
        .typing-cursor-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: black;
            border-radius: 50%;
            margin-left: 4px;
            animation: blink-cursor 0.8s infinite;
            vertical-align: baseline;
        }

        /* Estilo IRO Pro Upsell Texto */
        .iro-pro-highlight {
            background: linear-gradient(90deg, #1e3a8a, #c084fc); /* Azul marino a Morado pastel */
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 700;
        }

        /* --- ESTILOS IRO MACRO-BOT (RAZONAMIENTO) --- */
        .reasoning-box {
            background-color: #f9fafb; /* Gray-50 */
            border: 1px solid #e5e7eb; /* Gray-200 */
            border-radius: 12px;
            padding: 12px 16px;
            margin-bottom: 12px;
            font-family: 'Open Sans', sans-serif;
            font-size: 0.8rem;
            color: #64748b; /* Slate-500 */
            display: flex;
            flex-direction: column;
            gap: 4px;
            position: relative;
            overflow: hidden;
        }
        .reasoning-box::before {
            content: '';
            position: absolute;
            top: 0; left: 0; width: 3px; height: 100%;
            background-color: #cbd5e1; /* Barra lateral decorativa */
        }
        .reasoning-header {
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 600;
            color: #475569;
            text-transform: uppercase;
            font-size: 0.7rem;
            letter-spacing: 0.05em;
            margin-bottom: 4px;
        }
        
        /* OVERRIDE BLOQUES DE CÓDIGO (GRIS) */
        .prose pre {
            background-color: #f3f4f6 !important; /* Gray-100 */
            color: #1f2937 !important; /* Gray-800 */
            border: 1px solid #e5e7eb !important;
            border-radius: 0 0 8px 8px !important;
            margin-top: 0 !important;
        }
        .prose code {
            color: #000 !important; /* Texto codigo oscuro */
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
        }
        
        /* CONTENEDOR DE CÓDIGO CON ETIQUETA */
        .code-wrapper {
            margin: 1em 0;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #e5e7eb;
        }
        .code-header {
            background-color: #e5e7eb; /* Gray-200 Header */
            padding: 4px 12px;
            font-size: 0.7rem;
            font-family: monospace;
            font-weight: bold;
            color: #6b7280;
            text-transform: uppercase;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* --- NUEVOS ESTILOS: CAPSULA PRO Y MODAL MEMORIA --- */
        
        /* Capsula Pro Expandible - MODIFICADO COLOR */
        .pro-capsule-container {
            display: flex;
            align-items: center;
            background-color: #ECFDF5; /* Emerald-50 */
            border-radius: 999px;
            height: 34px;
            padding: 0 8px;
            cursor: pointer;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            width: 34px; /* Inicio solo icono */
            white-space: nowrap;
            color: #10B981; /* Emerald-500 */
        }
        .pro-capsule-container:hover {
            width: 140px; /* Ancho expandido */
        }
        .pro-capsule-text {
            font-family: 'Open Sans', sans-serif;
            font-weight: 700;
            font-size: 13px;
            margin-left: 8px;
            opacity: 0;
            transform: translateX(10px);
            transition: all 0.2s ease;
        }
        .pro-capsule-container:hover .pro-capsule-text {
            opacity: 1;
            transform: translateX(0);
        }

        /* Modal Información Chat */
        #memory-popover {
            position: absolute;
            top: 60px;
            right: 20px;
            width: 320px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.12);
            border: 1px solid #e5e7eb;
            z-index: 60;
            padding: 20px;
            display: none;
            flex-direction: column;
            animation: zoomIn 0.2s ease-out;
        }
        #memory-popover.visible {
            display: flex;
        }
        .memory-title {
            font-family: 'Open Sans', sans-serif;
            font-weight: 600; /* Semibold */
            font-size: 18px;
            color: black;
            margin-bottom: 4px;
        }
        .memory-subtitle {
            font-family: 'Open Sans', sans-serif;
            font-size: 12px;
            color: #9ca3af; /* Gris ligero */
            margin-bottom: 12px;
            line-height: 1.4;
        }
        .memory-input {
            width: 100%;
            height: 100px;
            padding: 10px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            resize: none;
            font-family: 'Open Sans', sans-serif;
            font-size: 13px;
            outline: none;
            transition: border 0.2s;
            color: #1f2937;
        }
        .memory-input:focus {
            border-color: #abc4ff;
        }

    </style>
</head>
<body class="h-screen flex overflow-hidden selection:bg-black selection:text-white relative transition-all duration-300">

    <!-- INPUTS DE ARCHIVOS REALES (Ocultos) -->
    <input type="file" id="file-input-generic" class="hidden" multiple>
    <input type="file" id="file-input-image" class="hidden" accept="image/*" multiple>
    <input type="file" id="file-input-video" class="hidden" accept="video/*" multiple>
    <input type="file" id="file-input-gallery" class="hidden" accept="image/*,video/*" multiple>

    <!-- OVERLAYS -->
    <div id="mobile-overlay" class="hidden fixed inset-0 bg-black/20 backdrop-blur-sm z-30 md:hidden transition-opacity"></div>
    <div id="global-click-overlay" class="hidden fixed inset-0 bg-transparent z-[60]" onclick="closeAllMenusExcept(null)"></div>

    <!-- NOTIFICACIÓN: MENSAJE LARGO (Agents V2) -->
    <div id="long-message-toast" class="hidden fixed top-24 left-1/2 transform -translate-x-1/2 bg-white border border-gray-100 shadow-xl rounded-xl z-[90] p-6 max-w-md w-full animate-slide-up flex flex-col items-center text-center">
        <div class="w-10 h-10 bg-gray-50 rounded-full flex items-center justify-center mb-3">
             <i data-lucide="zap" class="text-black" width="20"></i>
        </div>
        <h3 class="font-bold text-black text-lg mb-1">Procesando mensaje extenso</h3>
        <p class="text-sm text-gray-500 font-medium">Tu mensaje es muy largo, se utilizará Agents V2 para mejorar tu experiencia, el proceso puede tardar, pero en breves responderemos tu pregunta.</p>
    </div>

    <!-- CANVAS PANEL (El Lienzo) -->
    <div id="canvas-panel">
        <!-- Header Canvas -->
        <div class="min-h-[60px] py-2 border-b border-gray-100 flex items-center justify-between px-4 bg-white/95 backdrop-blur-sm shrink-0">
            <!-- LADO IZQUIERDO: Botón Cerrar (X) + Input de Título -->
            <div class="flex items-center gap-3 flex-1 min-w-0"> 
                <button onclick="closeCanvas()" class="p-2 text-gray-400 hover:text-black hover:bg-gray-100 rounded-lg transition-colors shrink-0" title="Cerrar Canvas"><i data-lucide="x" width="18"></i></button>
                
                <!-- NOMBRE DEL PROYECTO -->
                <input type="text" value="Proyecto IRO" class="w-full bg-transparent border border-transparent hover:border-gray-200 focus:border-gray-300 rounded-md text-[19px] font-medium text-black outline-none transition-all font-open-sans truncate" placeholder="Nombre del proyecto">
            </div>
            
            <!-- LADO DERECHO: Botones Deshacer/Rehacer + Estado -->
            <div class="flex items-center gap-1 shrink-0 ml-2">
                <button onclick="canvasUndo()" id="btn-undo" class="p-2 text-gray-500 hover:text-black hover:bg-gray-100 rounded-lg transition-colors bg-white disabled:opacity-30 disabled:hover:text-gray-500" title="Deshacer"><i data-lucide="undo" width="16"></i></button>
                <button onclick="canvasRedo()" id="btn-redo" class="p-2 text-gray-500 hover:text-black hover:bg-gray-100 rounded-lg transition-colors bg-white disabled:opacity-30 disabled:hover:text-gray-500" title="Rehacer"><i data-lucide="redo" width="16"></i></button>
                <div class="w-px h-4 bg-gray-200 mx-1"></div>
                <span id="canvas-status" class="text-[10px] text-gray-400 mr-1 transition-opacity opacity-0">Guardado</span>
            </div>
        </div>

        <!-- Editor Area -->
        <div class="flex-1 overflow-hidden relative bg-white flex flex-col">
            <div class="w-full h-full max-w-4xl mx-auto relative group">
                
                <!-- Editor Rich Text -->
                <div id="canvas-editor" contenteditable="true" class="flex-1 w-full h-full p-8 custom-scrollbar bg-transparent z-10 focus:outline-none" spellcheck="false"></div>
                
                <!-- Overlay de carga para el canvas -->
                <div id="canvas-loader" class="hidden absolute inset-0 bg-white/80 backdrop-blur-sm z-20 flex-col items-center justify-center">
                    <div class="w-8 h-8 border-2 border-indigo-600 border-t-transparent rounded-full animate-spin mb-3"></div>
                    <span class="text-xs font-medium text-indigo-600 animate-pulse">Procesando con IA...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- CÁPSULA UNIFICADA (Fuera del panel para mejor dragging, visible via CSS) -->
    <div id="unified-capsule">
        <!-- 1. Case Upper (Mejora + Mayúsculas) -->
        <div id="capsule-uppercase" onclick="toggleUppercaseMode()" class="capsule-icon-btn">
            <i data-lucide="case-upper" width="18"></i>
            <span class="u-tooltip">Mejorar + MAYÚS</span>
        </div>
        
        <!-- 2. Emojis -->
        <div id="capsule-emojis" onclick="toggleEmojiPicker()" class="capsule-icon-btn">
            <i data-lucide="smile-plus" width="18"></i>
            <span class="u-tooltip">Emojis</span>
        </div>
        
        <!-- Separador -->
        <div class="capsule-divider"></div>

        <!-- 3. Drag Handle -->
        <div id="capsule-drag" class="capsule-icon-btn capsule-grip-handle">
            <i data-lucide="grip-horizontal" width="18"></i>
            <span class="u-tooltip">Arrastrar</span>
        </div>
    </div>
    
    <!-- Popover de Emojis -->
    <div id="emoji-picker-popover"></div>

    <!-- BARRA FLOTANTE MÁGICA (EDICIÓN) -->
    <div id="floating-edit-bar" class="hidden">
        <input type="text" id="edit-input" placeholder="Edita lo que quieres..." class="w-48 px-3 py-1.5 text-sm bg-transparent border-none outline-none text-black placeholder-gray-400 font-inter">
        <button onclick="submitEdit()" class="p-1.5 bg-black text-white rounded-full hover:bg-gray-800 transition-colors shadow-sm">
            <i data-lucide="arrow-up" width="14" height="14"></i>
        </button>
    </div>


    <!-- MENÚS FLOTANTES -->
    
    <!-- Menú AGENTES -->
    <div id="agents-menu" class="hidden fixed w-48 bg-white border border-gray-200 rounded-xl shadow-2xl animate-zoom-in z-[100] p-1.5 overflow-hidden">
        <button onclick="selectAgent(1)" class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-50 text-[13px] font-medium text-black transition-colors">Agente 1</button>
        <button onclick="selectAgent(2)" class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-50 text-[13px] font-medium text-black transition-colors">Agente 2 MPR</button>
        <button onclick="selectAgent(3)" class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-50 text-[13px] font-medium text-black transition-colors">Agente 3</button>
        <div class="h-px bg-gray-100 my-1"></div>
        <button onclick="handleLockedAgent()" class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-50 text-[13px] font-medium text-gray-400 transition-colors flex justify-between items-center group">
            Agente 4 <i data-lucide="lock" width="12"></i>
        </button>
        <button onclick="handleLockedAgent()" class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-50 text-[13px] font-medium text-gray-400 transition-colors flex justify-between items-center group">
            Agente 5 <i data-lucide="lock" width="12"></i>
        </button>
    </div>

    <!-- Menú ADJUNTAR (Clip - Tools View) -->
    <div id="tools-attach-menu" class="hidden fixed w-60 bg-white border border-gray-200 rounded-xl shadow-2xl animate-zoom-in z-[100] p-1.5 overflow-hidden">
        <button onclick="triggerFileSelect('generic')" class="w-full text-left px-3 py-2.5 rounded-lg hover:bg-gray-50 flex items-center gap-3 text-[13px] font-medium text-black transition-colors mb-2">
            <div class="bg-gray-100 p-1.5 rounded-md"><i data-lucide="paperclip" width="14"></i></div> Adjuntar Fotos y Archivos
        </button>
        <div class="h-px bg-gray-100 my-1"></div>
        <div class="grid grid-cols-1 gap-0.5" id="tools-advanced-list"></div>
    </div>

    <!-- Menú ADJUNTAR (Chat Normal PC) -->
    <div id="plus-menu-desktop" class="hidden fixed w-56 bg-white border border-gray-200 rounded-2xl shadow-2xl animate-zoom-in z-[100] p-1.5">
        <button onclick="triggerFileSelect('generic')" class="w-full text-left px-3 py-2 rounded-xl hover:bg-gray-50 flex items-center gap-3 text-[13px] font-medium text-black transition-colors group">
            <div class="bg-gray-100 p-1.5 rounded-lg group-hover:bg-white border border-transparent group-hover:border-gray-200"><i data-lucide="paperclip" width="11"></i></div> Adjuntar Archivos y Fotos
        </button>
        <div class="h-px bg-gray-100 my-1.5"></div>
        <div class="grid grid-cols-1 gap-0.5" id="pc-tools-list"></div>
    </div>

    <!-- SIDEBAR -->
    <div id="sidebar" class="hidden md:flex flex-col h-full border-r border-gray-200 shrink-0 sidebar-transition relative z-40 bg-white w-[70px] absolute md:static shadow-2xl md:shadow-none font-dm-sans bg-white transition-all duration-300">
        
        <!-- Cabecera Sidebar (Expanded) -->
        <div id="sidebar-header" class="hidden flex items-center h-14 px-4 justify-between shrink-0 transition-all duration-300">
            <div id="logo-container" class="flex items-center gap-3 animate-fade-in">
                <img src="logo-negro.png" onerror="this.src='https://via.placeholder.com/24x24?text=L'" alt="Logo" class="w-6 h-6 object-contain">
                <span class="font-bold text-sm tracking-tight text-black">IRO AI</span>
            </div>
            <button id="btn-collapse" class="p-1.5 rounded-lg text-black hover:bg-gray-200 transition-colors"><i data-lucide="panel-left-close" width="16" height="16" stroke-width="1.2"></i></button>
        </div>
        
        <!-- Cabecera Sidebar Colapsada -->
        <div id="collapsed-header" class="flex h-14 w-full items-center justify-center">
            <button id="btn-expand" class="group relative w-9 h-9 flex items-center justify-center rounded-xl transition-all duration-300">
                <img src="logo-negro.png" onerror="this.style.display='none'; this.nextElementSibling.style.opacity='1';" alt="Logo" class="w-6 h-6 object-contain absolute opacity-100 group-hover:opacity-0 transition-opacity duration-200">
                <i data-lucide="panel-left-open" width="16" height="16" stroke-width="1.5" class="text-black opacity-0 group-hover:opacity-100 transition-opacity duration-200 absolute"></i>
            </button>
        </div>
        
        <!-- Opciones Principales -->
        <div class="flex flex-col gap-[3px] px-0 mt-2 flex-1 overflow-y-auto sidebar-scrollbar" id="sidebar-options">
            <!-- JS Generates this -->
        </div>
        
        <!-- Footer Group -->
        <div class="mt-auto">
            <div class="px-3 pb-2">
                <button id="btn-download-app" class="sidebar-item w-full flex items-center justify-center py-2 rounded-[8px] gap-[3px] text-black hover:bg-gray-100 transition-all group">
                    <span class="text-[11.5px] truncate text-black fade-in-fast sidebar-label font-medium flex-1 text-left hidden">Descargar IRO AI</span>
                    <div class="flex gap-2 text-gray-400 group-hover:text-black transition-colors fade-in-fast sidebar-label hidden">
                        <i data-lucide="monitor" width="12.5" height="12.5" stroke-width="1.5"></i>
                        <i data-lucide="smartphone" width="12.5" height="12.5" stroke-width="1.5"></i>
                    </div>
                </button>
            </div>
            
            <div class="p-3 pt-0 pb-1">
                <button class="sidebar-item w-full flex items-center justify-center py-2 rounded-[8px] gap-[3px] text-black hover:bg-gray-100 transition-all group">
                    <i data-lucide="settings" width="16" height="16" stroke-width="1.2" class="shrink-0 text-black"></i>
                    <span class="text-[13px] truncate text-black fade-in-fast sidebar-label font-medium hidden">Configuración</span>
                </button>
            </div>
            
            <!-- ID DE USUARIO (Visible cuando la barra está expandida) -->
            <div id="user-id-display" class="w-full text-center pb-3 hidden fade-in-fast sidebar-label">
                <span class="text-[7px] text-gray-400 font-mono tracking-wider">ID: 8F3K-9L2P</span>
            </div>
        </div>
    </div>

    <!-- ÁREA PRINCIPAL -->
    <div id="main-content-area" class="flex flex-col h-full flex-1 transition-all duration-500 ease-in-out bg-white relative w-full overflow-hidden">
        
        <!-- 1. VISTA STANDARD (Chat Normal) -->
        <div id="standard-view" class="flex flex-col h-full w-full relative">
            <!-- Header Standard -->
            <div class="h-14 shrink-0 flex items-center justify-between px-6 sticky top-0 bg-white/80 backdrop-blur-md z-30 font-dm-sans relative">
                <div class="flex items-center gap-3 w-full relative">
                    <button id="btn-mobile-sidebar" class="md:hidden p-2 mr-1 text-black hover:bg-gray-100 rounded-full transition-colors flex items-center justify-center border border-gray-200 shadow-sm active:scale-95"><i data-lucide="panel-left" width="18" height="18"></i></button>
                    
                    <!-- MENU "IRO AI" -->
                    <div class="relative">
                        <button id="btn-iro-menu" class="flex items-center gap-1.5 text-sm font-dm-sans font-[300] text-black hover:bg-gray-100 px-3 py-1.5 rounded-lg transition-colors group">
                            <span>IRO AI</span>
                            <i data-lucide="chevron-down" width="14" height="14" class="transition-transform duration-200 text-gray-400 group-hover:text-black" id="iro-menu-icon"></i>
                        </button>
                        
                        <div id="iro-menu-content" class="hidden absolute top-full left-0 mt-3 w-[280px] bg-white border border-gray-200 rounded-2xl shadow-2xl z-50 p-2 animate-zoom-in overflow-hidden">
                            <div class="flex flex-col gap-1">
                                <button class="w-full text-left px-3 py-2.5 rounded-xl hover:bg-gray-50 flex items-start gap-3 transition-colors group">
                                    <div class="mt-0.5 text-black shrink-0"><i data-lucide="rabbit" width="18"></i></div>
                                    <div class="flex-1">
                                        <div class="text-sm font-medium text-black leading-none mb-1">IRO AI</div>
                                        <div class="text-[11px] text-gray-500 font-medium leading-tight">Veloz y suficiente para todo</div>
                                    </div>
                                    <div class="text-gray-400 shrink-0 self-center"><i data-lucide="check" width="16"></i></div>
                                </button>
                                
                                <button class="w-full text-left px-3 py-2.5 rounded-xl hover:bg-gray-50 flex items-start gap-3 transition-colors group">
                                    <div class="mt-0.5 text-black shrink-0"><i data-lucide="orbit" width="18"></i></div>
                                    <div class="flex-1">
                                        <div class="text-sm font-medium text-black leading-none mb-1">IRO Pro</div>
                                        <div class="text-[11px] text-gray-500 font-medium leading-tight">Altamente Capaz y hecho para todo</div>
                                    </div>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- WRAPPER LADO DERECHO (MODIFICADO) -->
                    <div class="ml-auto flex items-center gap-2">
                        
                        <!-- NUEVA OPCIÓN: APRENDER (A LA IZQUIERDA DE EXPLORAR) -->
                        <div class="relative">
                            <button id="btn-learn-menu" class="flex items-center gap-1.5 text-base font-medium text-black hover:bg-gray-100 px-3 py-1.5 rounded-lg transition-colors">Aprender <i data-lucide="chevron-down" width="14" height="14" class="text-gray-400"></i></button>
                            <div id="learn-menu" class="hidden absolute top-full right-0 mt-3 w-[260px] bg-white rounded-2xl shadow-2xl border border-gray-200 p-2 z-50 animate-zoom-in origin-top-right overflow-hidden font-dm-sans">
                                <div class="p-1 flex flex-col gap-0.5">
                                    <a href="https://ai.irotter.online/blog/sobre-iro" target="_blank" class="w-full flex items-center gap-2 px-3 py-2.5 rounded-lg hover:bg-gray-50 transition-colors text-sm font-medium text-black group">
                                        <i data-lucide="info" width="16" class="text-gray-400 group-hover:text-black"></i>
                                        Conocer más sobre IRO AI
                                    </a>
                                    <a href="https://ai.irotter.online/blog" target="_blank" class="w-full flex items-center gap-2 px-3 py-2.5 rounded-lg hover:bg-gray-50 transition-colors text-sm font-medium text-black group">
                                        <i data-lucide="book-open" width="16" class="text-gray-400 group-hover:text-black"></i>
                                        Blog
                                    </a>
                                    <a href="https://ai.irotter.online/blog/que-tan-potente-es-iro" target="_blank" class="w-full flex items-center gap-2 px-3 py-2.5 rounded-lg hover:bg-gray-50 transition-colors text-sm font-medium text-black group">
                                        <i data-lucide="zap" width="16" class="text-gray-400 group-hover:text-black"></i>
                                        ¿Que tan potente es IRO?
                                    </a>
                                </div>
                            </div>
                        </div>

                        <!-- EXPLORAR MENU -->
                        <div class="relative">
                            <button id="btn-explore-menu" class="flex items-center gap-1.5 text-base font-medium text-black hover:bg-gray-100 px-3 py-1.5 rounded-lg transition-colors">Explorar <i data-lucide="chevron-down" width="14" height="14" class="text-gray-400"></i></button>
                            <div id="explore-menu" class="hidden absolute top-full right-0 mt-3 w-[280px] bg-white rounded-2xl shadow-2xl border border-gray-200 p-2 z-50 animate-zoom-in origin-top-right overflow-hidden font-dm-sans">
                                <div class="p-1">
                                    <h3 class="px-3 py-2 text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Información</h3>
                                    <a href="/sobre-nuestro-modelo" class="w-full flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-gray-100 transition-colors text-sm font-medium text-black group">
                                        <i data-lucide="bot" width="16" class="text-gray-400 group-hover:text-black transition-colors"></i>
                                        Sobre nuestro modelo
                                    </a>
                                </div>
                            </div>
                        </div>

                        <!-- EXTRAS MENU (FONDO CAMBIADO A BLANCO) -->
                        <div class="relative">
                            <button id="btn-extras-menu" class="flex items-center gap-1.5 text-base font-medium text-black hover:bg-gray-100 px-3 py-1.5 rounded-lg transition-colors">Extras <i data-lucide="chevron-down" width="14" height="14" class="text-gray-400"></i></button>
                            <div id="extras-menu" class="hidden absolute top-full right-0 mt-3 w-[340px] bg-white rounded-2xl shadow-2xl border border-gray-200 p-2 z-50 animate-zoom-in origin-top-right overflow-hidden font-dm-sans">
                                <div class="max-h-[80vh] overflow-y-auto custom-scrollbar p-2">
                                    <div class="mb-4">
                                        <h3 class="px-3 py-2 text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Herramientas</h3>
                                        <div class="space-y-0.5 text-black" id="extras-tools-list"></div>
                                    </div>
                                    <div class="h-px bg-gray-200 mx-3 mb-4"></div>
                                    <div>
                                        <h3 class="px-3 py-2 text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Funciones del chat</h3>
                                        <div class="space-y-0.5 text-black" id="extras-functions-list"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- NUEVA CÁPSULA MEJORAR A PRO (Color Cambiado) -->
                        <div class="pro-capsule-container group">
                            <i data-lucide="orbit" width="16" class="shrink-0"></i>
                            <span class="pro-capsule-text">Mejorar a Pro</span>
                        </div>

                        <!-- NUEVOS BOTONES CHAT & INFO -->
                        <div class="w-px h-5 bg-gray-200 mx-1"></div>
                        
                        <button onclick="resetChat()" class="p-2 text-gray-500 hover:text-black hover:bg-gray-100 rounded-lg transition-colors" title="Nuevo Chat">
                            <i data-lucide="square-pen" width="18"></i>
                        </button>
                        
                        <button onclick="toggleMemoryModal()" class="p-2 text-gray-500 hover:text-black hover:bg-gray-100 rounded-lg transition-colors" title="Información de Chat">
                            <i data-lucide="user-pen" width="18"></i>
                        </button>

                        <!-- POPOVER MEMORIA -->
                        <div id="memory-popover">
                            <div class="memory-title">Añadir información de chat</div>
                            <div class="memory-subtitle">Añade información que quieres que la IA recuerde y no se olvide</div>
                            <textarea id="memory-input" class="memory-input" maxlength="300" placeholder="Ej: Soy diseñador gráfico, prefiero respuestas cortas..."></textarea>
                        </div>

                    </div>
                </div>
            </div>

            <!-- Viewport Standard -->
            <div id="chat-viewport" class="flex-1 overflow-y-auto p-4 md:p-8 space-y-8 scroll-smooth custom-scrollbar relative flex flex-col items-center transition-all duration-500">
                <div id="welcome-screen" class="flex-1 flex flex-col items-center justify-center min-h-[50vh] transition-all duration-500 w-full">
                    <div class="text-center mb-8 animate-slide-up md:-translate-y-8"><h1 id="greeting-text" class="font-inter text-[24px] font-light tracking-tight text-black">Hola, creador.</h1></div>
                    <div id="center-content-spot" class="w-full max-w-3xl px-4 animate-slide-up flex flex-col items-center" style="animation-delay: 0.1s;"></div>
                </div>
                <div id="messages-list" class="flex flex-col gap-8 pb-4 w-full max-w-3xl hidden"></div>
                <!-- LOADER MODIFICADO (Punto negro de escritura, manejado dinámicamente) -->
                <div id="ai-loader" class="hidden w-full max-w-3xl pl-14 justify-start">
                     <span class="typing-cursor-dot"></span>
                </div>
            </div>
            
            <div id="bottom-bar-container" class="w-full shrink-0 pb-8 pt-4 px-4 bg-white z-20 hidden md:block transition-all duration-500">
                
                <!-- UPSELL IRO PRO (Oculto por defecto) -->
                <div id="iro-pro-upsell" class="hidden max-w-lg mx-auto mb-4 bg-gray-50 border border-gray-200 rounded-xl p-3 flex items-center gap-3 animate-slide-up shadow-sm">
                    <div class="p-2 bg-white rounded-lg border border-gray-100 shadow-sm"><i data-lucide="rocket" width="16" class="text-blue-600"></i></div>
                    <div class="flex-1">
                        <p class="text-xs text-gray-500 leading-tight">¿Estás trabajando en algo grande? Nuestro sistema está diseñado para soportar tu flujo actual, sin embargo, considera mejorar a <span class="iro-pro-highlight">IRO Pro</span> para eliminar límites y obtener velocidad prioritaria.</p>
                    </div>
                </div>

                <div id="bottom-input-spot" class="max-w-3xl mx-auto relative z-20"></div>
            </div>
        </div>

        <!-- 2. VISTA MAS HERRAMIENTAS -->
        <div id="tools-view" class="hidden flex-col h-full w-full bg-white relative overflow-hidden">
            <div class="h-14 w-full shrink-0"></div>
            <div class="flex-1 overflow-y-auto custom-scrollbar p-6 flex flex-col items-center">
                <div class="w-full max-w-2xl mb-4 animate-slide-up flex items-center justify-center gap-3">
                    <img src="logo-negro.png" onerror="this.src='https://via.placeholder.com/40x40?text=I'" alt="Logo IRO AI" class="w-10 h-10 object-contain shrink-0"> 
                    <h1 class="font-inter font-bold text-[25.6px] text-black tracking-tight">IRO AI</h1>
                </div>

                <div class="w-full max-w-2xl mb-10 animate-slide-up relative z-30">
                    <div class="bg-white border border-gray-300 rounded-2xl shadow-sm hover:shadow-md transition-all relative min-h-[140px] flex flex-col">
                        <textarea placeholder="Escribe tu idea o usa una herramienta..." class="w-full bg-transparent border-none outline-none text-black placeholder-gray-400 resize-none font-light font-inter text-lg leading-relaxed flex-1 p-4 pb-12 custom-scrollbar"></textarea>
                        <div class="absolute bottom-2 left-2 right-2 flex justify-between items-center">
                            <button id="btn-tools-attach" class="p-2 text-gray-400 hover:text-black hover:bg-gray-100 rounded-xl transition-colors">
                                <i data-lucide="paperclip" width="16" height="16"></i>
                            </button>
                            <div class="flex items-center gap-1">
                                <button id="btn-tools-agents" class="p-2 text-gray-500 hover:text-blue-600 hover:bg-blue-50 rounded-xl transition-colors">
                                    <i data-lucide="brain" width="16" height="16"></i>
                                </button>
                                <button class="p-2 bg-black text-white hover:bg-gray-900 rounded-xl transition-all shadow-md active:scale-95">
                                    <i data-lucide="arrow-up" width="16" height="16"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="w-full max-w-6xl grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 animate-slide-up" style="animation-delay: 0.1s;" id="cards-grid"></div>
                <div class="h-12 w-full shrink-0"></div>
            </div>
        </div>

        <!-- Componente Historial Mejorado -->
        <div id="history-view" class="hidden absolute inset-0 z-50 bg-white/95 backdrop-blur-md flex-col p-4 md:p-8 animate-fade-in transition-all">
             <div class="flex items-center justify-between mb-6 shrink-0 w-full max-w-4xl mx-auto">
                <h2 class="font-bold text-2xl text-black font-dm-sans">Tu Historial</h2>
                <button id="btn-history-close" class="p-2 hover:bg-gray-100 text-black rounded-full transition-colors"><i data-lucide="x" width="24" height="24"></i></button>
            </div>
            
            <div class="w-full max-w-4xl mx-auto relative mb-6 shrink-0">
                <i data-lucide="search" width="18" class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                <input type="text" id="history-search" placeholder="Buscar conversaciones antiguas..." class="w-full pl-12 pr-4 py-3 bg-gray-50 border border-gray-200 rounded-2xl text-base outline-none focus:border-black/20 focus:bg-white transition-all font-inter shadow-sm">
            </div>

            <div id="history-list-content" class="flex-1 w-full max-w-4xl mx-auto overflow-y-auto custom-scrollbar space-y-3 pb-8">
                <div class="text-center text-gray-400 mt-10">No tienes chats guardados aún.</div>
            </div>
        </div>

        <!-- INPUT STANDARD -->
        <div id="main-input-wrapper" class="w-full relative mb-[25px] md:mb-0 md:-translate-y-[27.5px] transition-all duration-300">
            <div id="plus-menu-mobile" class="hidden md:hidden fixed bottom-0 left-0 w-full bg-white rounded-t-[2rem] shadow-[0_-10px_40px_rgba(0,0,0,0.1)] z-[70] animate-slide-up-panel flex flex-col max-h-[70vh]">
                <div class="w-10 h-1 bg-gray-200 rounded-full mx-auto mt-3 mb-4"></div>
                <div class="px-5 pb-6 overflow-y-auto custom-scrollbar">
                    <div class="flex gap-4 mb-5">
                        <div class="flex gap-2 shrink-0">
                            <button onclick="triggerFileSelect('generic')" class="flex flex-col items-center gap-1.5 group p-1"><div class="w-12 h-12 bg-blue-50 border border-blue-100 rounded-xl flex items-center justify-center text-blue-600 group-active:scale-95 transition-transform"><i data-lucide="folder" width="20"></i></div><span class="text-[10px] font-medium text-gray-600">Archivos</span></button>
                            <button onclick="triggerFileSelect('image')" class="flex flex-col items-center gap-1.5 group p-1"><div class="w-12 h-12 bg-purple-50 border border-purple-100 rounded-xl flex items-center justify-center text-purple-600 group-active:scale-95 transition-transform"><i data-lucide="image" width="20"></i></div><span class="text-[10px] font-medium text-gray-600">Fotos</span></button>
                            <button onclick="triggerFileSelect('video')" class="flex flex-col items-center gap-1.5 group p-1"><div class="w-12 h-12 bg-pink-50 border border-pink-100 rounded-xl flex items-center justify-center text-pink-600 group-active:scale-95 transition-transform"><i data-lucide="clapperboard" width="20"></i></div><span class="text-[10px] font-medium text-gray-600">Video</span></button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CAPSULA DE HERRAMIENTA ACTIVA (Canvas) -->
            <div id="active-tool-capsule" class="hidden absolute -top-12 left-4 md:left-12 z-20 animate-slide-up">
                <div class="tool-capsule flex items-center gap-2 px-3 py-1.5 rounded-full shadow-sm">
                    <div class="text-[#4338ca]"><i data-lucide="layout" width="14"></i></div>
                    <span class="text-xs font-semibold">Canvas</span>
                    <button onclick="removeActiveTool()" class="ml-1 p-0.5 hover:bg-white/50 rounded-full transition-colors"><i data-lucide="x" width="12"></i></button>
                </div>
            </div>

            <div class="flex items-end md:items-center gap-2 relative">
                <!-- BOTÓN ADJUNTAR (MOVIDO MÁS A LA IZQUIERDA: md:left-0) -->
                <button id="btn-plus" class="p-2.5 md:p-3 text-black md:text-gray-400 hover:text-black bg-gray-100 md:bg-transparent rounded-full hover:bg-gray-200 md:hover:bg-gray-100 transition-all shrink-0 md:absolute md:left-0 md:top-1/2 md:-translate-y-1/2 md:z-10 shadow-sm md:shadow-none">
                    <i data-lucide="paperclip" width="20" height="20" class="md:w-5 md:h-5 transition-transform duration-200"></i>
                </button>
                
                <!-- INPUT CONTAINER (PADDING REDUCIDO Y BORDE FINO) -->
                <div id="input-container" class="flex-1 bg-gray-50 md:bg-white border-[0.5px] border-gray-300 rounded-[2rem] md:rounded-[2rem] shadow-sm hover:shadow-md transition-all focus-within:shadow-lg focus-within:border-gray-400 p-1.5 pl-4 md:p-3 md:pl-12 relative flex items-center">
                    <textarea id="chat-textarea" rows="1" placeholder="Comienza a charlar..." class="w-full bg-transparent border-none outline-none text-black placeholder-gray-400 resize-none font-light font-inter transition-all duration-300 custom-scrollbar text-lg leading-relaxed max-h-[150px] py-1" style="min-height: 24px;"></textarea>
                    
                    <div class="relative flex items-center mr-1">
                        <button id="btn-model-menu" class="flex items-center gap-2 text-xs font-semibold text-gray-500 hover:text-black hover:bg-gray-100 px-2 py-1.5 rounded-lg transition-colors whitespace-nowrap">
                            <span id="selected-model-name">IRO v.9</span>
                            <i data-lucide="chevron-up" width="16" height="16" id="model-menu-icon" stroke-width="1.8"></i>
                        </button>
                        <div id="model-menu" class="hidden absolute bottom-full right-0 mb-2 w-56 bg-white border border-gray-200 rounded-xl shadow-xl z-50 p-1 animate-zoom-in">
                            <button onclick="selectModel('IRO v.9')" class="w-full text-left px-3 py-2 rounded-lg text-sm flex items-center gap-2 hover:bg-gray-100 transition-colors bg-black text-white">IRO v.9</button>
                            <button onclick="selectModel('IRO Macro-bot')" class="w-full text-left px-3 py-2 rounded-lg text-sm flex items-center justify-between hover:bg-gray-100 transition-colors group text-black font-semibold">
                                IRO Macro-bot
                                <span class="text-[10px] font-bold bg-gray-200 text-gray-600 px-1.5 rounded uppercase">Rápido</span>
                            </button>
                            <button onclick="selectModel('GPT-5.2')" class="w-full text-left px-3 py-2 rounded-lg text-sm flex items-center justify-between hover:bg-gray-100 transition-colors group text-black">GPT-5.2 <i data-lucide="lock" width="12" class="text-gray-400 group-hover:text-black"></i></button>
                            <button onclick="selectModel('Gemini 3')" class="w-full text-left px-3 py-2 rounded-lg text-sm flex items-center justify-between hover:bg-gray-100 transition-colors group text-black"><span class="flex items-center gap-2">Gemini 3 <span class="bg-blue-600 text-white text-[10px] px-1.5 py-0.5 rounded-full font-bold">NUEVO</span></span> <i data-lucide="lock" width="12" class="text-gray-400 group-hover:text-black"></i></button>
                        </div>
                    </div>

                    <button onclick="toggleReadAloud()" id="btn-read-aloud" class="p-2 mr-1 rounded-full transition-all bg-gray-200 text-gray-400 cursor-not-allowed" disabled>
                        <i data-lucide="audio-lines" width="20" height="20" class="md:w-5 md:h-5"></i>
                    </button>

                    <button id="btn-send" onclick="handleSendClick()" disabled class="p-2 ml-1 rounded-full bg-black text-white hover:bg-gray-900 disabled:bg-gray-200 disabled:text-gray-400 transition-all shadow-md active:scale-95 shrink-0 flex items-center justify-center">
                        <i id="send-icon" data-lucide="arrow-up" width="18" height="18" class="md:w-5 md:h-5"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Quick Actions (ELIMINADO CONTENIDO POR PETICIÓN) -->
        <div id="quick-actions" class="hidden"></div>
    </div>

    <!-- PREVIEW MODAL -->
    <div id="preview-modal" class="hidden fixed inset-0 z-[80] bg-black/90 backdrop-blur-md flex flex-col items-center justify-center p-4 animate-zoom-in">
        <button onclick="closePreview()" class="absolute top-4 right-4 p-2 text-white/50 hover:text-white transition-colors bg-white/10 rounded-full"><i data-lucide="x" width="24"></i></button>
        <div class="relative max-w-2xl w-full max-h-[70vh] rounded-2xl overflow-hidden shadow-2xl bg-black"><img id="preview-image" src="" class="w-full h-full object-contain hidden"><div id="preview-file-icon" class="hidden flex-col items-center justify-center p-20 text-white"><i data-lucide="file-text" width="64" height="64"></i><p id="preview-filename" class="mt-4 text-lg font-medium">documento.pdf</p></div></div>
        <div class="mt-8 flex gap-4 w-full max-w-xs"><button onclick="closePreview()" class="flex-1 py-3 rounded-xl bg-white/10 text-white font-medium hover:bg-white/20 transition-colors">Cancelar</button><button onclick="confirmSendFile()" class="flex-1 py-3 rounded-xl bg-blue-600 text-white font-bold hover:bg-blue-500 shadow-lg transition-colors">Enviar</button></div>
    </div>

    <script>
        // --- CONFIGURACIÓN MARKED (Personalizada para bloques de código grises) ---
        const renderer = new marked.Renderer();
        renderer.code = function(code, language) {
            const validLang = language || 'Iro Pro Llle';
            const displayLang = language || 'Iro Pro Llle';
            
            return `<div class="code-wrapper">
                        <div class="code-header">
                            <span>${displayLang}</span>
                            <i data-lucide="terminal" width="12"></i>
                        </div>
                        <pre><code class="language-${validLang}">${code}</code></pre>
                    </div>`;
        };
        marked.use({ renderer });

        // --- GESTIÓN DE ESTADO Y STORAGE ---
        const state = {
            isSidebarCollapsed: true, 
            isModelMenuOpen: false, 
            isExtrasOpen: false, 
            isExploreOpen: false,
            isLearnMenuOpen: false, // NUEVO ESTADO PARA EL MENÚ APRENDER
            isPlusMenuOpen: false, 
            isHistoryOpen: false, 
            messages: [], 
            currentModel: 'IRO v.9', 
            pendingFile: null,
            currentView: 'standard', 
            isAgentsMenuOpen: false, 
            isToolsAttachOpen: false,
            isIroMenuOpen: false,
            isReadAloud: false, 
            isGenerating: false,
            currentChatId: null, 
            chatHistory: [],
            pendingAction: null, 
            isCanvasOpen: false, 
            
            // Estado interno del Canvas
            canvasHistory: [],
            canvasHistoryIndex: -1,
            
            // ESTADO NUEVA CAPSULA
            isCapsuleExpanded: true,
            isUppercaseMode: false,

            // MEMORIA DE CHAT
            chatMemory: '',
            isMemoryModalOpen: false
        };

        let abortController = null;

        // Init Storage
        function initStorage() {
            const savedHistory = localStorage.getItem('iro_chat_history');
            if (savedHistory) {
                state.chatHistory = JSON.parse(savedHistory);
            }
            
            // Cargar Memoria Persistente
            const savedMemory = localStorage.getItem('iro_chat_memory');
            if (savedMemory) {
                state.chatMemory = savedMemory;
                document.getElementById('memory-input').value = savedMemory;
            }

            startNewSession();
        }

        function startNewSession() {
            state.currentChatId = Date.now().toString(); 
            state.messages = [];
            state.pendingAction = null; 
            state.isCanvasOpen = false;
            closeCanvas(true);
        }

        function saveCurrentChat() {
            if (state.messages.length === 0) return;
            const existingIndex = state.chatHistory.findIndex(c => c.id === state.currentChatId);
            let title = "Nuevo Chat";
            if (state.messages.length > 0) {
                const firstMsg = state.messages.find(m => m.role === 'user');
                if (firstMsg) {
                    title = firstMsg.content.replace(/\[.*?\]/g, '').trim().substring(0, 30) || "Imagen/Archivo";
                }
            }
            const chatData = {
                id: state.currentChatId,
                title: existingIndex !== -1 ? state.chatHistory[existingIndex].title : title,
                date: new Date().toLocaleDateString(),
                preview: state.messages[state.messages.length - 1].content.substring(0, 50) + "...",
                messages: state.messages
            };
            if (existingIndex !== -1) {
                state.chatHistory[existingIndex] = chatData;
            } else {
                state.chatHistory.unshift(chatData); 
            }
            localStorage.setItem('iro_chat_history', JSON.stringify(state.chatHistory));
            renderHistoryList();
        }

        function loadChat(id) {
            const chat = state.chatHistory.find(c => c.id === id);
            if (chat) {
                state.currentChatId = chat.id;
                state.messages = chat.messages || [];
                document.getElementById('messages-list').innerHTML = '';
                state.messages.forEach(msg => addMessage(msg.role === 'user' ? 'user' : 'ai', msg.content, false));
                updateLayout();
                toggleHistoryView(false);
            }
        }

        function deleteChat(id, e) {
            e.stopPropagation();
            if(confirm("¿Seguro que quieres borrar este chat?")) {
                state.chatHistory = state.chatHistory.filter(c => c.id !== id);
                localStorage.setItem('iro_chat_history', JSON.stringify(state.chatHistory));
                renderHistoryList();
                if(state.currentChatId === id) resetChat(); 
            }
        }

        function shareChat(id, e) {
            e.stopPropagation();
            const chat = state.chatHistory.find(c => c.id === id);
            const dummyLink = `https://iro.ai/share/${id}`;
            alert(`Link generado y copiado al portapapeles:\n${dummyLink}\n\n(Cualquiera con este link podrá ver el chat "${chat.title}")`);
        }
        
        function renameChat(id, e) {
            e.stopPropagation();
            const newName = prompt("Nuevo nombre para el chat:");
            if (newName && newName.trim() !== "") {
                const chat = state.chatHistory.find(c => c.id === id);
                if (chat) {
                    chat.title = newName;
                    localStorage.setItem('iro_chat_history', JSON.stringify(state.chatHistory));
                    renderHistoryList();
                }
            }
        }

        function renderHistoryList() {
            const container = document.getElementById('history-list-content');
            if (state.chatHistory.length === 0) {
                container.innerHTML = '<div class="flex flex-col items-center justify-center py-20 opacity-50"><i data-lucide="message-square-dashed" width="48" class="mb-4 text-gray-300"></i><p class="text-gray-400">No hay historial aún.</p></div>';
                initIcons();
                return;
            }
            const term = document.getElementById('history-search').value.toLowerCase();
            const filtered = state.chatHistory.filter(c => c.title.toLowerCase().includes(term));
            container.innerHTML = filtered.map(chat => `
                <div onclick="loadChat('${chat.id}')" class="w-full bg-white border border-gray-100 p-4 rounded-xl hover:shadow-md hover:border-gray-200 transition-all cursor-pointer group flex items-center justify-between animate-fade-in relative overflow-hidden">
                    <div class="flex items-center gap-4 overflow-hidden">
                        <div class="w-10 h-10 rounded-full bg-gray-50 flex items-center justify-center shrink-0 text-gray-500 group-hover:bg-black group-hover:text-white transition-colors">
                            <i data-lucide="message-square" width="18"></i>
                        </div>
                        <div class="min-w-0">
                            <h3 class="font-bold text-sm text-gray-800 truncate pr-2 group-hover:text-black transition-colors" title="${chat.title}">${chat.title}</h3>
                            <p class="text-xs text-gray-400 truncate">${chat.date} · ${chat.preview}</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity absolute right-4 bg-white/80 backdrop-blur-sm pl-2">
                        <button onclick="shareChat('${chat.id}', event)" class="p-2 hover:bg-blue-50 text-gray-400 hover:text-blue-600 rounded-lg transition-colors" title="Compartir Link"><i data-lucide="share-2" width="14"></i></button>
                        <button onclick="renameChat('${chat.id}', event)" class="p-2 hover:bg-gray-100 text-gray-400 hover:text-black rounded-lg transition-colors" title="Renombrar"><i data-lucide="edit-2" width="14"></i></button>
                        <button onclick="deleteChat('${chat.id}', event)" class="p-2 hover:bg-red-50 text-gray-400 hover:text-red-600 rounded-lg transition-colors" title="Borrar"><i data-lucide="trash-2" width="14"></i></button>
                    </div>
                </div>
            `).join('');
            initIcons();
        }

        const sidebarItems = [
            { icon: 'plus', label: 'Nuevo Chat', action: 'newChat' },
            { icon: 'search', label: 'Buscar Chats', action: 'search' },
            { icon: 'archive', label: 'Proyectos', action: 'projects' },
            { icon: 'brain', label: 'Agentes', action: 'agents' },
            { icon: 'layout-grid', label: 'Más herramientas', action: 'moreTools' }, 
            { icon: 'history', label: 'Historial', action: 'toggleHistory' }
        ];

        const toolList = [
            { id: 'canvas', icon: 'layout', label: "Canvas" }, 
            { icon: 'image', label: "Crea imagen" }, { icon: 'align-left', label: "Resumen" }, { icon: 'code-2', label: "Código" }, { icon: 'search', label: "Investigar" }, { icon: 'link', label: "Analizar URL" }
        ];
        
        const advancedTools = [
            { id: 'canvas', icon: 'layout', label: "Canvas" },
            { icon: 'align-left', label: "Resumen" }, { icon: 'file-search', label: "Analisis Extenso" }, { icon: 'quote', label: "Citas" }, { icon: 'search', label: "Investigación Fragmentada" }, { icon: 'list-ordered', label: "Paso a Paso" }, { icon: 'code-2', label: "Codigo" }
        ];

        const cardsData = [
            { title: "Crear sitio web", desc: "Crea sitios web enteros usando IA con un solo prompt.", img: "https://images.unsplash.com/photo-1547658719-da2b51169166?w=600&h=300&fit=crop" },
            { title: "Investigación y Analisis", desc: "Profundiza en cualquier tema con datos actualizados.", img: "https://images.unsplash.com/photo-1454165804606-c3d57bc86b40?w=600&h=300&fit=crop" },
            { title: "Convertir Word a PDF", desc: "Transforma tus documentos en segundos.", img: "https://images.unsplash.com/photo-1568029132208-0a2412bda8b7?w=600&h=300&fit=crop" },
            { title: "Idea para video", desc: "Guiones creativos para YouTube o TikTok.", img: "https://images.unsplash.com/photo-1492691527719-9d1e07e534b4?w=600&h=300&fit=crop" },
            { title: "Crear Tienda Online", desc: "Estructura tu e-commerce desde cero.", img: "https://images.unsplash.com/photo-1556742049-0cfed4f7a07d?w=600&h=300&fit=crop" },
            { title: "Investiga un Tema", desc: "Obtén fuentes y resúmenes fiables.", img: "https://images.unsplash.com/photo-1434030216411-0b793f4b4173?w=600&h=300&fit=crop" },
            { title: "Genera citas", desc: "Formato APA, MLA y más al instante.", img: "https://images.unsplash.com/photo-1455390582262-044cdead277a?w=600&h=300&fit=crop" },
            { title: "Aprender idioma", desc: "Practica conversación y gramática.", img: "https://images.unsplash.com/photo-1543269865-cbf427effbad?w=600&h=300&fit=crop" }
        ];

        document.addEventListener('DOMContentLoaded', () => {
            initStorage(); 
            // marked.use({ breaks: true }); // Ya está configurado con renderer
            initIcons();
            renderSidebar(); 
            setSidebar(true); 

            renderExtras();
            renderTools();
            renderCards();
            renderAdvancedTools();
            updateLayout(); 
            
            document.getElementById('greeting-text').innerText = ["Hola, creador.", "¿Qué inventamos hoy?", "Sistema listo."][Math.floor(Math.random()*3)];
            
            document.addEventListener('click', handleGlobalClick);
            const textarea = document.getElementById('chat-textarea');
            textarea.addEventListener('input', function() {
                this.style.height = 'auto'; this.style.height = (this.scrollHeight) + 'px';
                updateInputUI(this.value.trim()); 
            });
            textarea.addEventListener('keydown', (e) => { 
                if(e.key === 'Enter' && !e.shiftKey) { 
                    e.preventDefault(); 
                    if(!document.getElementById('btn-send').disabled) handleSendClick(); 
                } 
            });
            
            document.getElementById('history-search').addEventListener('input', renderHistoryList);

            ['generic','image','video','gallery'].forEach(id => document.getElementById('file-input-'+id).addEventListener('change', id === 'file-input-gallery' ? handleGalleryLoad : handleFileSelect));

            // Setup real canvas editor listeners (Ahora para DIV contenteditable)
            const canvasEditor = document.getElementById('canvas-editor');
            canvasEditor.addEventListener('input', (e) => {
                // Debounce simple para guardar historial
                clearTimeout(canvasEditor.saveTimeout);
                canvasEditor.saveTimeout = setTimeout(() => {
                    saveCanvasHistory(e.target.innerHTML); // Guardamos HTML ahora
                }, 1000);
            });

            // --- LISTENER SELECCIÓN (MODIFICADO: MOUSEUP EN LUGAR DE SELECTIONCHANGE) ---
            // Solo cuando TERMINAS de seleccionar (mouseup o keyup) aparece la barra
            canvasEditor.addEventListener('mouseup', handleSelectionEnd);
            canvasEditor.addEventListener('keyup', handleSelectionEnd);
            canvasEditor.addEventListener('mousedown', () => {
                // Al empezar a seleccionar, ocultamos la barra si estaba visible
                document.getElementById('floating-edit-bar').classList.remove('visible');
                document.getElementById('floating-edit-bar').classList.add('hidden');
            });
            
            document.getElementById('edit-input').addEventListener('keydown', (e) => {
                if(e.key === 'Enter') submitEdit();
            });

            // Init Dragging for Unified Capsule
            setupUnifiedCapsuleDrag();
            
            setupButtons();
            
            // MEMORY LOGIC LISTENERS
            const memoryInput = document.getElementById('memory-input');
            memoryInput.addEventListener('input', (e) => {
                state.chatMemory = e.target.value;
                localStorage.setItem('iro_chat_memory', state.chatMemory);
            });

            window.addEventListener('resize', () => { if(state.isPlusMenuOpen && window.innerWidth >= 768) updatePCMenuPosition(); if(state.messages.length === 0 && state.currentView === 'standard') updateLayout(); });
        });

        // --- FUNCIONES DE MEMORIA DE CHAT ---
        function toggleMemoryModal() {
            state.isMemoryModalOpen = !state.isMemoryModalOpen;
            const modal = document.getElementById('memory-popover');
            if (state.isMemoryModalOpen) {
                modal.classList.add('visible');
            } else {
                modal.classList.remove('visible');
            }
        }

        // --- MANEJO DE BARRA FLOTANTE Y EDICIÓN (CORE MODIFICADO) ---
        let currentSelectionRange = null;

        function handleSelectionEnd() {
            const selection = window.getSelection();
            const editBar = document.getElementById('floating-edit-bar');
            
            // Validar si la selección está dentro del editor
            const editor = document.getElementById('canvas-editor');
            if (selection.rangeCount > 0 && !selection.isCollapsed && editor.contains(selection.anchorNode)) {
                
                // --- LÓGICA MODO MAYÚSCULAS IA (AUTOMÁTICO) ---
                if (state.isUppercaseMode) {
                    currentSelectionRange = selection.getRangeAt(0).cloneRange();
                    applyUppercaseImprovement(currentSelectionRange.toString());
                    return; // No mostramos la barra, ejecutamos la acción directa
                }

                // --- LÓGICA NORMAL (MOSTRAR BARRA) ---
                const range = selection.getRangeAt(0);
                const rect = range.getBoundingClientRect();
                
                // Guardar rango
                currentSelectionRange = range.cloneRange();

                // Posicionar barra
                editBar.style.top = `${rect.bottom + window.scrollY + 10}px`;
                editBar.style.left = `${rect.left + window.scrollX}px`;
                editBar.classList.remove('hidden');
                
                // Pequeño delay para la animación de entrada
                requestAnimationFrame(() => {
                    editBar.classList.add('visible');
                });
            } else {
                // Ocultar si no hay selección válida
                if (document.activeElement && document.activeElement.id === 'edit-input') return;
                editBar.classList.remove('visible');
                setTimeout(() => { if (!editBar.classList.contains('visible')) editBar.classList.add('hidden'); }, 200);
            }
        }

        // FUNCIÓN AUTOMÁTICA PARA EL MODO "CASE-UPPER"
        async function applyUppercaseImprovement(text) {
             // Loader visual simple en el canvas
            const loader = document.getElementById('canvas-loader');
            loader.classList.remove('hidden');
            loader.classList.add('flex');
            
            try {
                // Prompt específico
                const prompt = `Actúa como un editor experto. Tu única tarea es:
                1. Mejorar sutilmente la redacción del siguiente texto.
                2. Convertir TODO el texto resultante a MAYÚSCULAS.
                
                Texto original: "${text}"
                
                Responde ÚNICAMENTE con el texto mejorado en mayúsculas, sin explicaciones.`;

                const response = await fetch('https://text.pollinations.ai/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        messages: [{ role: 'user', content: prompt }],
                        model: 'openai',
                        jsonMode: false
                    })
                });

                if (response.ok) {
                    const newText = await response.text();
                    applyMagicEdit(newText);
                }
            } catch (e) {
                console.error("Error Uppercase AI", e);
                alert("Hubo un error al procesar el texto.");
            } finally {
                loader.classList.add('hidden');
                loader.classList.remove('flex');
                // Limpiar selección para evitar bucles o UI sucia
                window.getSelection().removeAllRanges();
            }
        }

        async function submitEdit() {
            const input = document.getElementById('edit-input');
            const instruction = input.value.trim();
            if (!instruction || !currentSelectionRange) return;

            const selectedText = currentSelectionRange.toString();
            
            // Loader visual en el input
            input.disabled = true;
            input.value = "Transformando...";
            
            try {
                const prompt = `Actúa como un editor de texto experto. El usuario quiere modificar el siguiente fragmento de texto: "${selectedText}".
                INSTRUCCIÓN DEL USUARIO: "${instruction}".
                REGLAS: Genera SOLAMENTE el texto modificado. Sin saludos. Respeta el idioma original.`;

                const response = await fetch('https://text.pollinations.ai/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        messages: [{ role: 'user', content: prompt }],
                        model: 'openai',
                        jsonMode: false
                    })
                });

                if (response.ok) {
                    const newText = await response.text();
                    applyMagicEdit(newText);
                }
            } catch (e) {
                console.error("Error editing text", e);
                alert("Error al editar el texto.");
            } finally {
                input.value = "";
                input.disabled = false;
                document.getElementById('floating-edit-bar').classList.remove('visible');
                window.getSelection().removeAllRanges();
            }
        }

        function applyMagicEdit(newText) {
            if (!currentSelectionRange) return;
            const span = document.createElement('span');
            span.innerHTML = newText;
            span.className = 'magic-effect'; 
            currentSelectionRange.deleteContents();
            currentSelectionRange.insertNode(span);
            saveCanvasHistory(document.getElementById('canvas-editor').innerHTML);
            setTimeout(() => { span.classList.remove('magic-effect'); }, 1500);
        }

        // --- CÁPSULA UNIFICADA (LÓGICA) ---
        
        function toggleUppercaseMode() {
            state.isUppercaseMode = !state.isUppercaseMode;
            const btn = document.getElementById('capsule-uppercase');
            
            if (state.isUppercaseMode) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        }
        
        // DRAGGING PRECISO
        function setupUnifiedCapsuleDrag() {
            const dragHandle = document.getElementById('capsule-drag');
            const capsule = document.getElementById('unified-capsule');
            
            let isDragging = false;
            let startX, startY, initialLeft, initialTop;
            
            dragHandle.addEventListener('mousedown', (e) => {
                isDragging = true;
                
                const rect = capsule.getBoundingClientRect();
                
                // Diferencial entre ratón y esquina del elemento
                startX = e.clientX - rect.left;
                startY = e.clientY - rect.top;
                
                // Cambiar a posicionamiento absoluto via style top/left para control total
                capsule.style.bottom = 'auto';
                capsule.style.right = 'auto';
                capsule.style.left = rect.left + 'px';
                capsule.style.top = rect.top + 'px';
                
                dragHandle.style.cursor = 'grabbing';
                e.preventDefault(); 
            });
            
            // Listeners en document para evitar perder el arrastre si se mueve rápido
            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                
                let newX = e.clientX - startX;
                let newY = e.clientY - startY;
                
                // Limites de pantalla (padding 10px)
                const maxX = window.innerWidth - capsule.offsetWidth - 10;
                const maxY = window.innerHeight - capsule.offsetHeight - 10;
                
                if (newX < 10) newX = 10;
                if (newY < 10) newY = 10;
                if (newX > maxX) newX = maxX;
                if (newY > maxY) newY = maxY;
                
                capsule.style.left = `${newX}px`;
                capsule.style.top = `${newY}px`;
            });
            
            document.addEventListener('mouseup', () => {
                if (isDragging) {
                    isDragging = false;
                    dragHandle.style.cursor = 'grab';
                }
            });
        }
        
        // EMOJIS
        function toggleEmojiPicker() {
            const picker = document.getElementById('emoji-picker-popover');
            const capsule = document.getElementById('unified-capsule');
            const rect = capsule.getBoundingClientRect();
            
            if (picker.classList.contains('show')) {
                picker.classList.remove('show');
            } else {
                // Generar emojis si está vacío
                if (picker.innerHTML === '') {
                    const emojis = ['😀','😂','😍','🤔','😎','😭','👍','👎','🔥','✨','🎉','🚀','🤖','💻','📝','✅','💡','❤️','🚩','👀','🙌','🛑','⭐','☕'];
                    picker.innerHTML = emojis.map(e => `<div class="emoji-btn" onclick="insertEmojiAtCursor('${e}')">${e}</div>`).join('');
                }
                
                // Posicionar cerca de la cápsula (Arriba)
                picker.style.top = (rect.top - 200) + 'px'; 
                picker.style.left = (rect.left - 100) + 'px'; // Ajuste
                picker.classList.add('show');
            }
        }
        
        function insertEmojiAtCursor(emoji) {
            const editor = document.getElementById('canvas-editor');
            editor.focus();
            
            // Insertar en cursor (Intento básico para contenteditable)
            // Si no hay rango, al final
            const selection = window.getSelection();
            if (selection.rangeCount > 0 && editor.contains(selection.anchorNode)) {
                const range = selection.getRangeAt(0);
                range.deleteContents();
                range.insertNode(document.createTextNode(emoji));
            } else {
                editor.innerHTML += emoji;
            }
            saveCanvasHistory(editor.innerHTML);
            document.getElementById('emoji-picker-popover').classList.remove('show');
        }

        // --- UTILS UI ---
        function updateInputUI(text) {
            const sendBtn = document.getElementById('btn-send');
            const readBtn = document.getElementById('btn-read-aloud');
            const qa = document.getElementById('quick-actions'); // AUNQUE YA NO EXISTE, PREVENIMOS ERROR
            
            if (state.isGenerating) {
                sendBtn.disabled = false;
            } else {
                sendBtn.disabled = text === "";
            }

            if (text.length > 0) {
                readBtn.disabled = false;
                readBtn.classList.remove('bg-gray-200', 'text-gray-400', 'cursor-not-allowed');
                if (state.isReadAloud) {
                    readBtn.classList.add('bg-blue-600', 'text-white');
                    readBtn.classList.remove('bg-black');
                } else {
                    readBtn.classList.add('bg-black', 'text-white');
                    readBtn.classList.remove('bg-blue-600');
                }
            } else {
                readBtn.disabled = true;
                readBtn.classList.add('bg-gray-200', 'text-gray-400', 'cursor-not-allowed');
                readBtn.classList.remove('bg-black', 'bg-blue-600', 'text-white');
            }
            
            // QA ya no existe, pero mantenemos lógica segura
            if(qa) {
               if(text.length > 0) qa.classList.add('hidden'); else if(state.messages.length === 0) qa.classList.remove('hidden');
            }
        }

        function toggleReadAloud() {
            state.isReadAloud = !state.isReadAloud;
            const readBtn = document.getElementById('btn-read-aloud');
            if (state.isReadAloud) {
                readBtn.classList.remove('bg-black');
                readBtn.classList.add('bg-blue-600');
            } else {
                readBtn.classList.remove('bg-blue-600');
                readBtn.classList.add('bg-black');
            }
        }

        function setupButtons() {
            document.getElementById('btn-model-menu').addEventListener('click', (e) => { 
                e.stopPropagation(); 
                if(!state.isModelMenuOpen) closeAllMenusExcept('model-menu'); 
                toggleState('isModelMenuOpen', 'model-menu'); 
            });

            document.getElementById('btn-iro-menu').addEventListener('click', (e) => { 
                e.stopPropagation(); 
                if(!state.isIroMenuOpen) closeAllMenusExcept('iro-menu'); 
                toggleState('isIroMenuOpen', 'iro-menu-content'); 
                const icon = document.getElementById('iro-menu-icon');
                if(state.isIroMenuOpen) icon.classList.add('rotate-180'); else icon.classList.remove('rotate-180');
            });

            document.getElementById('btn-explore-menu').addEventListener('click', (e) => {
                e.stopPropagation();
                if(!state.isExploreOpen) closeAllMenusExcept('explore-menu');
                toggleState('isExploreOpen', 'explore-menu');
            });

            // NUEVO LISTENER PARA APRENDER
            document.getElementById('btn-learn-menu').addEventListener('click', (e) => {
                e.stopPropagation();
                if(!state.isLearnMenuOpen) closeAllMenusExcept('learn-menu');
                toggleState('isLearnMenuOpen', 'learn-menu');
            });

            document.getElementById('btn-extras-menu').addEventListener('click', (e) => { e.stopPropagation(); if(!state.isExtrasOpen) closeAllMenusExcept('extras-menu'); toggleState('isExtrasOpen', 'extras-menu'); });
            
            document.getElementById('btn-collapse').addEventListener('click', () => { 
                if(window.innerWidth < 768) { closeMobileSidebar(); } else { setSidebar(true); }
            });
            document.getElementById('btn-expand').addEventListener('click', () => { 
                if(window.innerWidth < 768) { openMobileSidebar(); setSidebar(false); } else { setSidebar(false); } 
            });
            document.getElementById('btn-mobile-sidebar').addEventListener('click', openMobileSidebar);
            document.getElementById('mobile-overlay').addEventListener('click', closeMobileSidebar);
            
            document.getElementById('btn-plus').addEventListener('click', (e) => { 
                e.stopPropagation();
                if(state.isPlusMenuOpen) { closeAllMenusExcept(null); return; }
                if(window.innerWidth < 768) { closeAllMenusExcept('plus-menu'); document.getElementById('plus-menu-mobile').classList.remove('hidden'); document.getElementById('mobile-overlay').classList.remove('hidden'); state.isPlusMenuOpen = true; }
                else { closeAllMenusExcept('plus-menu'); document.getElementById('plus-menu-desktop').classList.remove('hidden'); state.isPlusMenuOpen = true; updatePCMenuPosition(); }
            });
            
            document.getElementById('btn-history-close').addEventListener('click', () => toggleHistoryView(false));
            
            document.getElementById('btn-tools-agents').addEventListener('click', (e) => {
                e.stopPropagation(); closeAllMenusExcept('agents-menu');
                const menu = document.getElementById('agents-menu'); const btn = document.getElementById('btn-tools-agents'); const rect = btn.getBoundingClientRect();
                menu.style.left = (rect.left - 150) + 'px'; menu.style.top = (rect.bottom + 10) + 'px';
                toggleState('isAgentsMenuOpen', 'agents-menu');
            });

            document.getElementById('btn-tools-attach').addEventListener('click', (e) => {
                e.stopPropagation(); closeAllMenusExcept('tools-attach-menu');
                const menu = document.getElementById('tools-attach-menu'); const btn = document.getElementById('btn-tools-attach'); const rect = btn.getBoundingClientRect();
                menu.style.left = rect.left + 'px'; menu.style.top = (rect.bottom + 10) + 'px';
                toggleState('isToolsAttachOpen', 'tools-attach-menu');
            });
        }

        // --- MANEJO DE HERRAMIENTAS Y CANVAS ---
        function selectTool(id, label) {
            closeAllMenusExcept(null); 
            
            if (id === 'canvas') {
                state.pendingAction = 'canvas';
                const tx = document.getElementById('chat-textarea');
                tx.placeholder = "Modo Canvas: ¿Qué creamos hoy?";
                tx.focus();
                
                // Mostrar Cápsula Visual
                // document.getElementById('active-tool-capsule').classList.remove('hidden'); // Eliminado por el nuevo diseño siempre activo
                
                // Feedback visual botón
                const sendIcon = document.getElementById('send-icon');
                sendIcon.setAttribute('data-lucide', 'arrow-right'); 
                initIcons();
            } else {
                console.log("Herramienta seleccionada:", label);
            }
        }

        function removeActiveTool() {
            state.pendingAction = null;
            document.getElementById('active-tool-capsule').classList.add('hidden');
            const tx = document.getElementById('chat-textarea');
            tx.placeholder = "Comienza a charlar...";
            const sendIcon = document.getElementById('send-icon');
            sendIcon.setAttribute('data-lucide', 'arrow-up');
            initIcons();
        }

        // --- FUNCIONALIDAD REAL DEL CANVAS ---

        function openCanvas(content) {
            state.isCanvasOpen = true;
            const editor = document.getElementById('canvas-editor');
            
            // Renderizado Markdown a HTML para soportar estilos mixtos
            if (content) {
                editor.innerHTML = marked.parse(content);
                state.canvasHistory = [editor.innerHTML];
                state.canvasHistoryIndex = 0;
            } else if (!editor.innerHTML) {
                 editor.innerHTML = "<p>Escribe algo aquí...</p>";
                 state.canvasHistory = ["<p>Escribe algo aquí...</p>"];
                 state.canvasHistoryIndex = 0;
            }
            
            updateUndoRedoButtons();
            document.body.classList.add('canvas-open');
            setSidebar(true); 
        }

        function closeCanvas() {
            state.isCanvasOpen = false;
            document.body.classList.remove('canvas-open');
        }

        // Historial Real (Undo/Redo)
        function saveCanvasHistory(val) {
            if (state.canvasHistoryIndex < state.canvasHistory.length - 1) {
                state.canvasHistory = state.canvasHistory.slice(0, state.canvasHistoryIndex + 1);
            }
            state.canvasHistory.push(val);
            state.canvasHistoryIndex++;
            updateUndoRedoButtons();
            
            const status = document.getElementById('canvas-status');
            status.style.opacity = '1';
            setTimeout(() => status.style.opacity = '0', 2000);
        }

        function canvasUndo() {
            if (state.canvasHistoryIndex > 0) {
                state.canvasHistoryIndex--;
                document.getElementById('canvas-editor').innerHTML = state.canvasHistory[state.canvasHistoryIndex];
                updateUndoRedoButtons();
            }
        }

        function canvasRedo() {
            if (state.canvasHistoryIndex < state.canvasHistory.length - 1) {
                state.canvasHistoryIndex++;
                document.getElementById('canvas-editor').innerHTML = state.canvasHistory[state.canvasHistoryIndex];
                updateUndoRedoButtons();
            }
        }

        function updateUndoRedoButtons() {
            document.getElementById('btn-undo').disabled = state.canvasHistoryIndex <= 0;
            document.getElementById('btn-redo').disabled = state.canvasHistoryIndex >= state.canvasHistory.length - 1;
        }

        function copyCanvasContent() {
            const editor = document.getElementById('canvas-editor');
            const range = document.createRange();
            range.selectNode(editor);
            window.getSelection().removeAllRanges();
            window.getSelection().addRange(range);
            document.execCommand('copy');
            window.getSelection().removeAllRanges();

            const btn = event.currentTarget;
            const originalHTML = btn.innerHTML;
            btn.innerHTML = `<i data-lucide="check" width="12"></i> Copiado`;
            setTimeout(() => { btn.innerHTML = originalHTML; initIcons(); }, 1500);
        }

        // --- CHAT LOGIC MODIFICADA PARA REINTENTOS ---

        function handleSendClick() {
            if (state.isGenerating) {
                if (abortController) abortController.abort();
                window.speechSynthesis.cancel();
                state.isGenerating = false;
                
                const sendIcon = document.getElementById('send-icon');
                sendIcon.setAttribute('data-lucide', 'arrow-up');
                sendIcon.removeAttribute('fill');
                // Ocultar punto de escritura
                document.getElementById('ai-loader').classList.add('hidden');
                initIcons();
            } else {
                sendMessage();
            }
        }

        async function sendMessage(textOverride = null, isRetry = false) {
            const tx = document.getElementById('chat-textarea');
            const t = textOverride || tx.value.trim();
            if(!t) return;

            window.speechSynthesis.cancel();
            state.isGenerating = true;
            abortController = new AbortController();

            // --- LÓGICA DE MENSAJES LARGOS ---
            const inputLength = t.length;
            const agentsToast = document.getElementById('long-message-toast');
            const proUpsell = document.getElementById('iro-pro-upsell');
            
            if (inputLength > 14000) {
                agentsToast.classList.remove('hidden');
                proUpsell.classList.remove('hidden');
                await new Promise(r => setTimeout(r, 4000));
                agentsToast.classList.add('hidden');
            } else {
                proUpsell.classList.add('hidden');
            }

            // Solo limpiar UI si NO es un reintento automático
            if (!isRetry) {
                tx.value = ''; tx.style.height = 'auto';
                const sendBtn = document.getElementById('btn-send');
                const sendIcon = document.getElementById('send-icon');
                
                sendIcon.setAttribute('data-lucide', 'square');
                sendIcon.setAttribute('fill', 'currentColor'); 
                initIcons();
                updateInputUI(''); 
                sendBtn.disabled = false; 

                // Agregar mensaje de usuario solo la primera vez
                const userMsg = {role:'user',content:t};
                state.messages.push(userMsg);
                
                if(state.messages.length === 1) updateLayout();
                
                addMessage('user', t, true); 
                saveCurrentChat();
            }

            const isCanvasTrigger = state.pendingAction === 'canvas';
            
            // Mostrar Loader
            const l = document.getElementById('ai-loader');
            l.classList.remove('hidden'); l.classList.add('flex');
            scrollToBottom();

            try {
                // --- SYSTEM PROMPT ---
                let systemPrompt = '';
                if(state.chatMemory) {
                    systemPrompt += `\n[MEMORIA IMPORTANTE DEL USUARIO]: ${state.chatMemory}\nRECUERDA ESTO SIEMPRE.\n\n`;
                }

                if (isCanvasTrigger) {
                    systemPrompt += 'Eres IRO AI en modo CANVAS. Genera contenido extenso y estructurado usando Markdown (# Titulos, ## Subtitulos, **negrita**). No uses frases de relleno.';
                } else if (state.currentModel === 'IRO Macro-bot') {
                    systemPrompt += `Eres IRO Macro-bot, diseñado para velocidad y precisión...`; // (Texto resumido para no repetir 1700 lineas innecesariamente aquí, pero la logica se mantiene)
                } else {
                    systemPrompt += `SYSTEM PROMPT – IRO v.9: Usa bloques de código, texto fluido, natural. Si fallas, reintenta.`;
                }

                // Determinamos el modelo: si es reintento, usamos 'openai' (o simulamos gpt-4o via prompt/parametro si la API lo permite)
                // Para efectos de Pollinations, usamos 'openai' por defecto, si falla, podemos intentar cambiar el seed o el prompt system ligeramente.
                // Aquí simulamos el cambio de modelo en el log.
                const modelToUse = isRetry ? 'gpt-4o' : 'openai'; 

                const response = await fetch('https://text.pollinations.ai/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    signal: abortController.signal,
                    body: JSON.stringify({
                        messages: [ { role: 'system', content: systemPrompt }, ...state.messages.map(msg => ({ role: msg.role === 'ai' ? 'assistant' : msg.role, content: msg.content })) ],
                        model: 'openai', // Pollinations usa 'openai' como alias principal
                        jsonMode: false
                    })
                });

                if (!response.ok) throw new Error('Network response was not ok');
                
                const textData = await response.text();
                
                l.classList.add('hidden'); l.classList.remove('flex');
                
                addMessage('ai', textData, 'typing'); 
                
                state.messages.push({role: 'ai', content: textData});
                saveCurrentChat();

                if (isCanvasTrigger) {
                    openCanvas(textData); 
                    removeActiveTool();   
                }

                if(state.isReadAloud) {
                    const u = new SpeechSynthesisUtterance(textData); u.lang = 'es-ES';
                    window.speechSynthesis.speak(u);
                }
            } catch (error) {
                // --- LÓGICA DE REINTENTO (RETRY) ---
                if (error.name !== 'AbortError' && !isRetry) {
                    console.log("Error en respuesta, intentando con modelo de respaldo (GPT-4o simulation)...");
                    // Llamada recursiva con flag isRetry = true
                    await sendMessage(t, true);
                    return; // Salimos para no ejecutar el código de error final
                }

                if (error.name === 'AbortError') {
                    console.log('Fetch aborted');
                } else {
                    console.error("Error calling AI:", error);
                    addMessage('ai', "Lo siento, hubo un error al conectar con el servidor de IA incluso después de reintentar.", false);
                }
                l.classList.add('hidden'); l.classList.remove('flex');
            } finally {
                // Solo restablecemos si NO estamos reintentando (si estamos reintentando, el finally del primer try no debe matar el loading del segundo)
                if (!isRetry || (isRetry && !state.isGenerating)) { 
                    state.isGenerating = false;
                    const sendIcon = document.getElementById('send-icon');
                    sendIcon.setAttribute('data-lucide', 'arrow-up');
                    sendIcon.removeAttribute('fill');
                    initIcons();
                    updateInputUI(document.getElementById('chat-textarea').value.trim());
                }
            }
        }

        // --- FUNCIONES CORE ---
        function handleSidebarAction(action) {
            if (action === 'newChat') { 
                state.currentView = 'standard'; 
                if(state.messages.length > 0) saveCurrentChat();
                resetChat(); 
                switchView('standard'); 
                closeCanvas(); 
            }
            if (action === 'toggleHistory') toggleHistoryView(true);
            if (action === 'moreTools') { state.currentView = 'tools'; switchView('tools'); }
            if(window.innerWidth < 768) closeMobileSidebar();
        }

        function switchView(viewName) {
            const standard = document.getElementById('standard-view');
            const tools = document.getElementById('tools-view');
            if (viewName === 'standard') { standard.classList.remove('hidden'); tools.classList.add('hidden'); } 
            else { standard.classList.add('hidden'); tools.classList.remove('hidden'); tools.classList.add('flex'); }
        }

        function selectAgent(id) { console.log("Agent selected:", id); closeAllMenusExcept(null); }
        function handleLockedAgent() { closeAllMenusExcept(null); if (state.isSidebarCollapsed) setSidebar(false); if (window.innerWidth < 768) openMobileSidebar(); const btn = document.getElementById('btn-download-app'); btn.classList.add('bg-gray-200', 'ring-2', 'ring-gray-300'); setTimeout(() => { btn.classList.remove('bg-gray-200', 'ring-2', 'ring-gray-300'); }, 1000); }

        function renderCards() {
            const container = document.getElementById('cards-grid');
            container.innerHTML = cardsData.map(c => `
                <div class="bg-white border border-gray-200 rounded-xl overflow-hidden hover:shadow-md transition-shadow cursor-pointer group">
                    <div class="h-24 bg-gray-100 overflow-hidden"><img src="${c.img}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500"></div>
                    <div class="p-3"><h3 class="font-bold text-sm text-black mb-1">${c.title}</h3><p class="text-xs text-gray-500 leading-relaxed">${c.desc}</p></div>
                </div>
            `).join('');
        }

        function renderAdvancedTools() {
            const container = document.getElementById('tools-advanced-list');
            container.innerHTML = advancedTools.map(t => `<button onclick="selectTool('${t.id || ''}', '${t.label}')" class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-50 flex items-center gap-3 text-[12px] font-medium text-black transition-colors group"><div class="text-gray-400 group-hover:text-black"><i data-lucide="${t.icon}" width="14"></i></div> ${t.label}</button>`).join('');
            initIcons();
        }

        function updatePCMenuPosition() {
            const btn = document.getElementById('btn-plus'); const menu = document.getElementById('plus-menu-desktop');
            if(!btn || !menu) return; const rect = btn.getBoundingClientRect();
            menu.style.left = rect.left + 'px'; menu.style.bottom = (window.innerHeight - rect.top + 10) + 'px';
        }

        function closeAllMenusExcept(exceptId) {
            if(exceptId !== 'model-menu' && state.isModelMenuOpen) toggleState('isModelMenuOpen', 'model-menu');
            if(exceptId !== 'iro-menu' && state.isIroMenuOpen) {
                 toggleState('isIroMenuOpen', 'iro-menu-content');
                 document.getElementById('iro-menu-icon')?.classList.remove('rotate-180');
            }
            if(exceptId !== 'extras-menu' && state.isExtrasOpen) toggleState('isExtrasOpen', 'extras-menu');
            if(exceptId !== 'explore-menu' && state.isExploreOpen) toggleState('isExploreOpen', 'explore-menu');
            if(exceptId !== 'learn-menu' && state.isLearnMenuOpen) toggleState('isLearnMenuOpen', 'learn-menu'); // CERRA NUEVO MENÚ
            
            if(exceptId !== 'plus-menu' && state.isPlusMenuOpen) {
                if(window.innerWidth < 768) { closePlusMenuMobile(); } else { document.getElementById('plus-menu-desktop').classList.add('hidden'); }
                state.isPlusMenuOpen = false;
            }
            if(exceptId !== 'agents-menu' && state.isAgentsMenuOpen) toggleState('isAgentsMenuOpen', 'agents-menu');
            if(exceptId !== 'tools-attach-menu' && state.isToolsAttachOpen) toggleState('isToolsAttachOpen', 'tools-attach-menu');
            
            // Cerrar Popover de Memoria si click fuera
            if(exceptId === null) { 
                document.getElementById('global-click-overlay').classList.add('hidden'); 
                document.getElementById('mobile-overlay').classList.add('hidden'); 
                document.getElementById('emoji-picker-popover').classList.remove('show');
                
                if (state.isMemoryModalOpen) {
                    toggleMemoryModal();
                }
            }
        }

        function handleGlobalClick(e) {
            if (state.isModelMenuOpen && !e.target.closest('#model-menu') && !e.target.closest('#btn-model-menu')) toggleState('isModelMenuOpen', 'model-menu');
            if (state.isIroMenuOpen && !e.target.closest('#iro-menu-content') && !e.target.closest('#btn-iro-menu')) {
                 toggleState('isIroMenuOpen', 'iro-menu-content');
                 document.getElementById('iro-menu-icon')?.classList.remove('rotate-180');
            }
            if (state.isExtrasOpen && !e.target.closest('#extras-menu') && !e.target.closest('#btn-extras-menu')) toggleState('isExtrasOpen', 'extras-menu');
            if (state.isExploreOpen && !e.target.closest('#explore-menu') && !e.target.closest('#btn-explore-menu')) toggleState('isExploreOpen', 'explore-menu');
            if (state.isLearnMenuOpen && !e.target.closest('#learn-menu') && !e.target.closest('#btn-learn-menu')) toggleState('isLearnMenuOpen', 'learn-menu');
            
            if (state.isPlusMenuOpen && window.innerWidth >= 768 && !e.target.closest('#plus-menu-desktop') && !e.target.closest('#btn-plus')) closeAllMenusExcept(null);
            if (state.isAgentsMenuOpen && !e.target.closest('#agents-menu') && !e.target.closest('#btn-tools-agents')) toggleState('isAgentsMenuOpen', 'agents-menu');
            if (state.isToolsAttachOpen && !e.target.closest('#tools-attach-menu') && !e.target.closest('#btn-tools-attach')) toggleState('isToolsAttachOpen', 'tools-attach-menu');
            
            // Cerrar emoji picker si click fuera
            if (!e.target.closest('#emoji-picker-popover') && !e.target.closest('#capsule-emojis')) {
                document.getElementById('emoji-picker-popover').classList.remove('show');
            }

            // Cerrar Memory Popover si click fuera
            if (state.isMemoryModalOpen && !e.target.closest('#memory-popover') && !e.target.closest('button[title="Información de Chat"]')) {
                toggleMemoryModal();
            }
        }

        function initIcons() { lucide.createIcons(); }
        function toggleState(key, domId) { state[key] = !state[key]; const el = document.getElementById(domId); state[key] ? el.classList.remove('hidden') : el.classList.add('hidden'); }
        function openMobileSidebar() { 
            const s = document.getElementById('sidebar'); 
            const o = document.getElementById('mobile-overlay'); 
            s.classList.remove('hidden'); 
            requestAnimationFrame(() => s.classList.add('flex')); 
            o.classList.remove('hidden'); 
            if(state.isSidebarCollapsed) setSidebar(false);
        }
        function closeMobileSidebar() { const s = document.getElementById('sidebar'); const o = document.getElementById('mobile-overlay'); s.classList.add('hidden'); s.classList.remove('flex'); o.classList.add('hidden'); }
        
        function setSidebar(c) { 
            state.isSidebarCollapsed = c; 
            const s = document.getElementById('sidebar'), h = document.getElementById('sidebar-header'), ch = document.getElementById('collapsed-header'), ls = document.querySelectorAll('.sidebar-label'), is = document.querySelectorAll('.sidebar-item'), uid = document.getElementById('user-id-display');
            const body = document.body;
            
            if(c) { 
                s.classList.remove('w-[255px]'); s.classList.add('w-[70px]'); 
                h.classList.add('hidden'); ch.classList.remove('hidden'); ch.classList.add('flex'); 
                ls.forEach(l => l.classList.add('hidden')); 
                is.forEach(i => { i.classList.add('justify-center'); i.classList.remove('px-3'); }); 
                uid.classList.add('hidden');
                body.classList.remove('sidebar-expanded');
            } else { 
                s.classList.add('w-[255px]'); s.classList.remove('w-[70px]'); 
                h.classList.remove('hidden'); ch.classList.add('hidden'); ch.classList.remove('flex'); 
                ls.forEach(l => l.classList.remove('hidden')); 
                is.forEach(i => { i.classList.remove('justify-center'); i.classList.add('px-3'); }); 
                uid.classList.remove('hidden');
                body.classList.add('sidebar-expanded');
            } 
        }

        // --- HISTORIAL FULL SCREEN LOGIC ---
        function toggleHistoryView(show) { 
            state.isHistoryOpen = show; 
            const v = document.getElementById('history-view'); 
            if(show) {
                renderHistoryList();
                v.classList.remove('hidden'); 
                v.classList.add('flex');
            } else {
                v.classList.add('hidden'); 
                v.classList.remove('flex');
            }
        }
        
        function setInput(t) { const tx = document.getElementById('chat-textarea'); tx.value = t; tx.focus(); tx.dispatchEvent(new Event('input')); }
        function selectModel(n) { state.currentModel = n; document.getElementById('selected-model-name').innerText = n; toggleState('isModelMenuOpen', 'model-menu'); }
        function closeModal() { document.getElementById('modal-overlay').classList.add('hidden'); }
        
        // RESET REAL (LIMPIA DOM y STATE)
        function resetChat() { 
            startNewSession(); 
            document.getElementById('messages-list').innerHTML = ''; 
            document.getElementById('chat-textarea').value = ''; 
            document.getElementById('chat-textarea').style.height = 'auto'; 
            updateLayout(); 
        }

        function copyText(t) { const ta = document.createElement('textarea'); ta.value = t; ta.style.position = 'fixed'; ta.style.left = '-9999px'; document.body.appendChild(ta); ta.select(); try { document.execCommand('copy'); } catch(e){} document.body.removeChild(ta); }
        function regenerateResponse() { const l = document.getElementById('ai-loader'); l.classList.remove('hidden'); l.classList.add('flex'); scrollToBottom(); setTimeout(() => { l.classList.add('hidden'); l.classList.remove('flex'); addMessage('ai', "Respuesta regenerada.", true); }, 1500); }
        function toggleFeedback(b, t) { if(b.classList.contains('text-black')) { b.classList.remove('text-black','bg-gray-100'); b.classList.add('text-gray-400'); } else { b.classList.remove('text-gray-400'); b.classList.add('text-black','bg-gray-100'); } }
        
        function speakText(btn) {
            const msgWrapper = btn.closest('.group').querySelector('.prose');
            if(msgWrapper) {
                const text = msgWrapper.innerText; const u = new SpeechSynthesisUtterance(text); u.lang = 'es-ES'; window.speechSynthesis.cancel(); window.speechSynthesis.speak(u);
            }
        }

        // --- FUNCIÓN DE ESCRITURA MODIFICADA (ANIMACIÓN DE PUNTO NEGRO + RAZONAMIENTO) ---
        function addMessage(r, c, animate = true) { 
            const l = document.getElementById('messages-list'); 
            const u = r === 'user'; 
            const d = document.createElement('div'); 
            d.className = `flex w-full ${u ? 'justify-end' : 'justify-start'} animate-fade-in`; 
            
            // --- PARSEO DE MACRO-BOT (EXTRAER RAZONAMIENTO) ---
            let reasoningContent = null;
            let finalContent = c;

            if (!u && c.includes("||RAZONAMIENTO||")) {
                const reasoningStart = c.indexOf("||RAZONAMIENTO||");
                const reasoningEnd = c.indexOf("||FIN_RAZONAMIENTO||");
                
                if (reasoningStart !== -1 && reasoningEnd !== -1) {
                    reasoningContent = c.substring(reasoningStart + 16, reasoningEnd).trim();
                }

                const responseStart = c.indexOf("||RESPUESTA||");
                const responseEnd = c.indexOf("||FIN_RESPUESTA||");
                
                if (responseStart !== -1) {
                    // Si hay bloque de respuesta explicito
                    finalContent = c.substring(responseStart + 13, responseEnd !== -1 ? responseEnd : c.length).trim();
                } else if (reasoningEnd !== -1) {
                    // Fallback: Todo después del razonamiento
                    finalContent = c.substring(reasoningEnd + 20).trim();
                }
            }

            let i = u ? `<div class="w-10 h-10 rounded-full flex items-center justify-center shrink-0 overflow-hidden border border-gray-100 shadow-sm bg-gray-100 text-black"><i data-lucide="user" width="20"></i></div>` : `<div class="w-10 h-10 rounded-full flex items-center justify-center shrink-0 overflow-hidden border border-gray-100 shadow-sm bg-white text-black"><img src="logo-negro.png" onerror="this.src='https://via.placeholder.com/28x28?text=I'" class="w-7 h-7 object-contain"></div>`; 
            
            const wc = u ? 'max-w-[50%]' : 'w-fit max-w-[45ch] md:max-w-[68ch]'; 
            
            // Renderizar Razonamiento si existe
            let reasoningHTML = '';
            if (reasoningContent) {
                reasoningHTML = `
                <div class="reasoning-box animate-slide-up w-full max-w-[68ch]">
                    <div class="reasoning-header">
                        <i data-lucide="brain-circuit" width="14"></i>
                        <span>Proceso de Razonamiento</span>
                    </div>
                    <div class="leading-relaxed whitespace-pre-wrap">${reasoningContent}</div>
                </div>`;
            }

            const b = `<div class="px-6 py-4 rounded-[1.5rem] text-base leading-relaxed tracking-wide shadow-sm ${u ? 'bg-gray-100 text-black rounded-tr-sm border border-gray-200' : 'bg-white text-black px-0 shadow-none border-transparent'} overflow-hidden ${wc}"><div class="prose prose-sm max-w-none break-words whitespace-pre-wrap ${u ? '' : 'font-light'}" id="msg-content-${Date.now()}"></div></div>`; 
            
            const ec = finalContent.replace(/`/g, '\\`').replace(/"/g, '&quot;'); 
            const a = !u ? `<div class="flex items-center gap-2 mt-2 justify-start pl-1"><button onclick="speakText(this)" class="p-2 text-gray-400 hover:text-black rounded-lg transition-all hover:bg-gray-100"><i data-lucide="volume-2" width="14"></i></button><button onclick="copyText(\`${ec}\`)" class="p-2 text-gray-400 hover:text-black rounded-lg transition-all hover:bg-gray-100"><i data-lucide="copy" width="14"></i></button><button onclick="regenerateResponse()" class="p-2 text-gray-400 hover:text-black rounded-lg transition-all hover:bg-gray-100"><i data-lucide="refresh-cw" width="14"></i></button><div class="h-4 w-px bg-gray-200 mx-1"></div><button onclick="toggleFeedback(this, 'like')" class="p-2 text-gray-400 hover:text-black rounded-lg transition-all hover:bg-gray-100"><i data-lucide="thumbs-up" width="14"></i></button><button onclick="toggleFeedback(this, 'dislike')" class="p-2 text-gray-400 hover:text-black rounded-lg transition-all hover:bg-gray-100"><i data-lucide="thumbs-down" width="14"></i></button></div>` : ''; 
            
            // Estructura final: Icono + (Razonamiento opcional) + Burbuja Chat
            d.innerHTML = `<div class="flex gap-4 ${u ? 'flex-row-reverse' : 'flex-row'} group w-full">${i}<div class="flex flex-col gap-1 ${u ? 'items-end' : 'items-start'} w-full">${reasoningHTML}${b}${a}</div></div>`; 
            l.appendChild(d); 
            
            // Lógica de llenado de contenido
            const contentDiv = d.querySelector('.prose');
            
            if (u) {
                // Usuario: Renderizado directo
                contentDiv.innerHTML = finalContent;
            } else if (animate === 'typing') {
                // IA: Efecto de escritura con punto negro y VELOCIDAD DINÁMICA
                typeWriterEffect(contentDiv, finalContent);
            } else {
                // IA: Sin animación (historial)
                contentDiv.innerHTML = marked.parse(finalContent);
            }

            initIcons(); 
            scrollToBottom(); 
        }

        // --- EFECTO MAQUINA DE ESCRIBIR CON CURSOR NEGRO Y VELOCIDAD DINÁMICA ---
        function typeWriterEffect(element, text) {
            element.innerHTML = '<span class="typing-cursor-dot"></span>';
            const cursor = element.querySelector('.typing-cursor-dot');
            
            let i = 0;
            
            // Velocidad dinámica: Si es largo, muy rápido (1ms). Si es corto, normal (15ms).
            // Esto simula "lectura rápida de contexto" o "generación veloz"
            const baseSpeed = text.length > 200 ? 1 : 15; 
            
            function type() {
                if (i < text.length) {
                    // Insertar carácter antes del cursor
                    const char = text.charAt(i);
                    const textNode = document.createTextNode(char);
                    element.insertBefore(textNode, cursor);
                    i++;
                    
                    // Pequeña variación aleatoria para que se sienta humano/natural
                    const randomVar = Math.random() * 5;
                    
                    scrollToBottom();
                    setTimeout(type, baseSpeed + randomVar);
                } else {
                    cursor.remove();
                    element.innerHTML = marked.parse(text);
                    initIcons(); 
                }
            }
            
            type();
        }

        function scrollToBottom() { const v = document.getElementById('chat-viewport'); v.scrollTop = v.scrollHeight; }
        
        function renderSidebar() {
            const container = document.getElementById('sidebar-options');
            const isC = state.isSidebarCollapsed;
            container.innerHTML = sidebarItems.map(item => `
                <button onclick="handleSidebarAction('${item.action}')" class="sidebar-item w-full flex items-center ${isC ? 'justify-center' : 'px-3'} py-1.5 rounded-[8px] gap-3 text-black hover:bg-gray-100 transition-all group mb-1 ${item.action === 'moreTools' ? 'bg-white' : ''} font-dm-sans">
                    <i data-lucide="${item.icon}" width="14.5" height="14.5" stroke-width="1.2" class="shrink-0 text-black"></i>
                    <span class="text-[14.7px] truncate text-black fade-in-fast sidebar-label ${isC ? 'hidden' : ''}">${item.label}</span>
                </button>
            `).join('');
            initIcons();
        }
        function renderExtras() { 
            const et = [{ icon: 'file-text', label: "Crear documentos", desc: "Word, PDF, textos largos" }, { icon: 'align-left', label: "Resumir contenido", desc: "Sintetizar información clave" }]; 
            const ef = [{ icon: 'message-square', label: "Contexto extendido", desc: "Para charlas largas" }, { icon: 'archive', label: "Memoria de chat", desc: "Recordar datos previos" }]; 
            const ci = (i) => `<button class="w-full flex items-start gap-3 p-3 rounded-xl hover:bg-gray-200/50 transition-colors group text-left"><div class="mt-0.5 text-gray-500 group-hover:text-black transition-colors"><i data-lucide="${i.icon}" width="16" stroke-width="1.5"></i></div><div><div class="text-sm font-semibold text-black leading-tight">${i.label}</div><div class="text-[11px] text-gray-500 font-medium mt-0.5">${i.desc}</div></div></button>`; 
            document.getElementById('extras-tools-list').innerHTML = et.map(ci).join(''); document.getElementById('extras-functions-list').innerHTML = ef.map(ci).join(''); 
        }
        function renderQuickActions() { const q = [{ text: "Imagen creativa", icon: "image" }, { text: "Resumir esto", icon: "align-left" }, { text: "Código Python", icon: "terminal" }, { text: "Plan de viaje", icon: "plane" }]; document.getElementById('quick-actions').innerHTML = q.map(a => `<button onclick="setInput('${a.text}')" class="group px-4 py-2 md:px-5 md:py-3 md:text-sm bg-white hover:bg-gray-50 text-black rounded-full transition-all cursor-pointer flex items-center gap-2 text-xs font-medium border border-gray-200 shadow-sm hover:shadow-md"><i data-lucide="${a.icon}" width="14" height="14" class="text-gray-500 group-hover:text-black"></i><span>${a.text}</span></button>`).join(''); initIcons(); }
        
        function renderTools() { const pl = document.getElementById('pc-tools-list'); pl.innerHTML = toolList.map(t => `<button onclick="selectTool('${t.id || ''}', '${t.label}')" class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-50 flex items-center gap-3 text-[13px] text-black transition-colors group"><div class="text-gray-400 group-hover:text-black"><i data-lucide="${t.icon}" width="11"></i></div> ${t.label}</button>`).join(''); }
        
        function updateLayout() { 
            const iw = document.getElementById('main-input-wrapper'); 
            const qa = document.getElementById('quick-actions'); 
            const cs = document.getElementById('center-content-spot'); 
            const bs = document.getElementById('bottom-input-spot'); 
            const bb = document.getElementById('bottom-bar-container'); 
            const w = document.getElementById('welcome-screen'); 
            const ml = document.getElementById('messages-list'); 
            
            if(state.messages.length === 0) { 
                w.classList.remove('hidden'); 
                if(window.innerWidth < 768) { cs.innerHTML = ''; bb.appendChild(iw); if(qa) qa.classList.add('hidden'); bb.classList.remove('hidden'); } 
                else { bb.classList.add('hidden'); iw.classList.remove('mt-5'); cs.appendChild(iw); /* if(qa) { qa.classList.remove('mt-6'); qa.classList.add('mt-6'); cs.appendChild(qa); qa.classList.remove('hidden'); } */ } 
            } else { 
                bb.classList.remove('hidden'); 
                bs.appendChild(iw); 
                iw.classList.remove('mt-5'); 
                w.classList.add('hidden'); 
                ml.classList.remove('hidden'); 
                if(qa) qa.classList.add('hidden'); 
            } 
        }
        function triggerFileSelect(t) { closePlusMenuMobile(); document.getElementById('plus-menu-desktop').classList.add('hidden'); state.isPlusMenuOpen = false; if(state.isToolsAttachOpen) toggleState('isToolsAttachOpen', 'tools-attach-menu'); let id = 'file-input-generic'; if(t==='image')id='file-input-image'; if(t==='video')id='file-input-video'; document.getElementById(id).click(); }
        function handleFileSelect(e) { const f = e.target.files[0]; if(!f) return; state.pendingFile = f; showPreview(f); e.target.value = ''; }
        function handleGalleryLoad(e) { const fs = Array.from(e.target.files); }
        function showPreview(f) { const m = document.getElementById('preview-modal'); const i = document.getElementById('preview-image'); const c = document.getElementById('preview-file-icon'); const n = document.getElementById('preview-filename'); m.classList.remove('hidden'); m.classList.add('flex'); if(f.type.startsWith('image/')) { const r = new FileReader(); r.onload = (e) => { i.src = e.target.result; i.classList.remove('hidden'); c.classList.add('hidden'); }; r.readAsDataURL(f); } else { i.classList.add('hidden'); c.classList.remove('hidden'); c.classList.add('flex'); n.innerText = f.name; } }
        function closePreview() { document.getElementById('preview-modal').classList.add('hidden'); document.getElementById('preview-modal').classList.remove('flex'); state.pendingFile = null; }
        
        function confirmSendFile() { 
            const m = document.getElementById('preview-modal'); 
            m.classList.add('hidden'); 
            m.classList.remove('flex'); 
            const fm = state.pendingFile ? `[Archivo Adjunto: ${state.pendingFile.name}]` : "[Imagen Enviada]"; 
            
            state.messages.push({role:'user',content:fm}); 
            if(state.messages.length === 1) updateLayout(); 
            
            addMessage('user', fm); 
            setTimeout(() => { 
                const l = document.getElementById('ai-loader'); l.classList.remove('hidden'); l.classList.add('flex'); scrollToBottom(); 
                setTimeout(() => { l.classList.add('hidden'); l.classList.remove('flex'); addMessage('ai', "He recibido tu archivo correctamente."); }, 1500); 
            }, 500); 
            state.pendingFile = null; 
        }
        
        function closePlusMenuMobile() { document.getElementById('plus-menu-mobile').classList.add('hidden'); document.getElementById('mobile-overlay').classList.add('hidden'); state.isPlusMenuOpen = false; }
    </script>
</body>
</html>